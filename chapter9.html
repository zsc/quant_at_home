<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬ä¹ç« ï¼šæ™ºèƒ½åˆçº¦å®‰å…¨ - åŒºå—é“¾ç¨³å®šå¸æ•™ç¨‹</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">ç¨³å®šå¸æ•™ç¨‹</a>
            <button class="navbar-toggle" onclick="toggleMobileNav()">â˜°</button>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">é¦–é¡µ</a>
                </li>
                <li class="nav-item">
                    <a href="intro.html" class="nav-link">å¼•è¨€</a>
                </li>
                <li class="nav-item dropdown">
                    <a href="#" class="nav-link">ç« èŠ‚</a>
                    <div class="dropdown-menu">
                        <a href="chapter1.html" class="dropdown-item">ç¬¬1ç« ï¼šåŒºå—é“¾åŸºç¡€</a>
                        <a href="chapter2.html" class="dropdown-item">ç¬¬2ç« ï¼šç¨³å®šå¸åˆ†ç±»</a>
                        <a href="chapter3.html" class="dropdown-item">ç¬¬3ç« ï¼šERC-20æ ‡å‡†</a>
                        <a href="chapter4.html" class="dropdown-item">ç¬¬4ç« ï¼šæŠµæŠ¼å‹è®¾è®¡</a>
                        <a href="chapter5.html" class="dropdown-item">ç¬¬5ç« ï¼šæ•°å­¦æ¨¡å‹</a>
                        <a href="chapter6.html" class="dropdown-item">ç¬¬6ç« ï¼šAMMé›†æˆ</a>
                        <a href="chapter7.html" class="dropdown-item">ç¬¬7ç« ï¼šå€Ÿè´·åè®®</a>
                        <a href="chapter8.html" class="dropdown-item">ç¬¬8ç« ï¼šæ”¶ç›Šç­–ç•¥</a>
                        <a href="chapter9.html" class="dropdown-item">ç¬¬9ç« ï¼šæ™ºèƒ½åˆçº¦å®‰å…¨</a>
                        <a href="chapter10.html" class="dropdown-item">ç¬¬10ç« ï¼šç»æµæ”»å‡»</a>
                        <a href="chapter11.html" class="dropdown-item">ç¬¬11ç« ï¼šæœªæ¥æ–¹å‘</a>
                        <a href="chapter12.html" class="dropdown-item">ç¬¬12ç« ï¼šç”Ÿäº§éƒ¨ç½²</a>
                        <a href="chapter13.html" class="dropdown-item">ç¬¬13ç« ï¼šç”Ÿæ€é›†æˆ</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="index.html#resources" class="nav-link">èµ„æº</a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- å¤´éƒ¨ -->
    <header id="top">
        <div class="container">
            <h1>ç¬¬ä¹ç« ï¼šæ™ºèƒ½åˆçº¦å®‰å…¨</h1>
        </div>
    </header>
    
    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container">
        <div class="chapter">
<h2>ç¬¬ä¹ç« ï¼šæ™ºèƒ½åˆçº¦å®‰å…¨</h2>
        
        <p>ç»è¿‡å‰å…«ç« çš„å­¦ä¹ ï¼Œæˆ‘ä»¬å·²ç»æŒæ¡äº†ç¨³å®šå¸çš„è®¾è®¡åŸç†ã€å®ç°æŠ€æœ¯å’Œå„ç§åº”ç”¨åœºæ™¯ã€‚ç„¶è€Œï¼Œæ‰€æœ‰è¿™äº›åŠªåŠ›éƒ½å¯èƒ½å› ä¸ºä¸€ä¸ªå°å°çš„å®‰å…¨æ¼æ´è€ŒåŠŸäºä¸€ç¯‘ã€‚æœ¬ç« å°†å…¨é¢å‰–ææ™ºèƒ½åˆçº¦å®‰å…¨ï¼Œç‰¹åˆ«æ˜¯ç¨³å®šå¸ç³»ç»Ÿç‰¹æœ‰çš„å®‰å…¨æŒ‘æˆ˜ã€‚ä»ç»å…¸çš„é‡å…¥æ”»å‡»åˆ°å¤æ‚çš„æ²»ç†æ”»å‡»ï¼Œä»ä»£ç å®¡è®¡æŠ€å·§åˆ°å½¢å¼åŒ–éªŒè¯æ–¹æ³•ï¼Œæˆ‘ä»¬å°†æ„å»ºä¸€ä¸ªå®Œæ•´çš„å®‰å…¨é˜²æŠ¤ä½“ç³»ã€‚è®°ä½ï¼Œåœ¨åŒºå—é“¾ä¸–ç•Œä¸­ï¼Œä»£ç å³æ³•å¾‹ï¼Œè€Œå®‰å…¨å°±æ˜¯è¿™éƒ¨æ³•å¾‹çš„å®ˆæŠ¤è€…ã€‚</p>
        
        <div class="intro-box">
            <strong>æœ¬ç« æ¦‚è§ˆï¼š</strong>
            <ul>
                <li>ç¨³å®šå¸å®‰å…¨å¨èƒå…¨æ™¯åˆ†æ</li>
                <li>å¸¸è§æ¼æ´æ¨¡å¼ä¸é˜²å¾¡æªæ–½</li>
                <li>å®‰å…¨å¼€å‘ç”Ÿå‘½å‘¨æœŸä¸æœ€ä½³å®è·µ</li>
                <li>é«˜çº§å®‰å…¨æ¨¡å¼ï¼ˆæ–­è·¯å™¨ã€æ—¶é—´é”ã€å¤šç­¾ï¼‰</li>
                <li>å®‰å…¨å®¡è®¡æµç¨‹ä¸è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·</li>
            </ul>
        </div>

        <h3 id="security-threats">9.1 ç¨³å®šå¸å®‰å…¨å¨èƒå…¨æ™¯</h3>
        
        <div class="intro-box" style="background-color: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h4>ğŸ›¡ï¸ å®‰å…¨ï¼šç¨³å®šå¸ç³»ç»Ÿçš„ç”Ÿå‘½çº¿</h4>
            <p>åœ¨DeFiä¸–ç•Œä¸­ï¼Œå®‰å…¨ä¸æ˜¯é€‰é¡¹ï¼Œè€Œæ˜¯å¿…éœ€å“ã€‚ä¸€ä¸ªå°å°çš„æ¼æ´å¯èƒ½å¯¼è‡´æ•°ç™¾ä¸‡ç¾å…ƒçš„æŸå¤±ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œå®ƒä¼šæ°¸ä¹…æ€§åœ°ç ´åç”¨æˆ·ä¿¡ä»»ã€‚ç¨³å®šå¸ä½œä¸ºDeFiçš„åŸºç¡€è®¾æ–½ï¼Œå…¶å®‰å…¨æ€§è¦æ±‚æ›´æ˜¯ä¸¥è‹›ã€‚</p>
            
            <div style="background-color: #e0f2fe; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h5>ğŸ¯ ä¸ºä»€ä¹ˆç¨³å®šå¸å®‰å…¨æ ¼å¤–é‡è¦ï¼š</h5>
                <ol>
                    <li><strong>ç³»ç»Ÿæ€§å½±å“</strong>ï¼šç¨³å®šå¸æ˜¯å…¶ä»–DeFiåè®®çš„åŸºçŸ³</li>
                    <li><strong>ä»·å€¼é›†ä¸­</strong>ï¼šå¾€å¾€é”å®šå·¨é¢èµ„é‡‘ï¼ˆæ•°åäº¿ç¾å…ƒï¼‰</li>
                    <li><strong>æ”»å‡»åŠ¨æœºå¼º</strong>ï¼šç¨³å®šçš„ä»·å€¼ä½¿å…¶æˆä¸ºç†æƒ³æ”»å‡»ç›®æ ‡</li>
                    <li><strong>å¤æ‚åº¦é«˜</strong>ï¼šæ¶‰åŠé¢„è¨€æœºã€æ²»ç†ã€è·¨é“¾ç­‰å¤šä¸ªæ”»å‡»é¢</li>
                </ol>
            </div>
        </div>
        
        <div class="info-box">
            <h4>ğŸ“Š 2023-2024å¹´DeFiå®‰å…¨æ€åŠ¿</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">ç»Ÿè®¡é¡¹</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">2023å¹´</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">2024å¹´ï¼ˆæˆªè‡³Q3ï¼‰</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">è¶‹åŠ¿</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ€»æŸå¤±é‡‘é¢</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$1.8B</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$1.2B</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“‰ ä¸‹é™33%</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ”»å‡»æ•°é‡</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">425æ¬¡</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">312æ¬¡</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“‰ å‡å°‘</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>å¹³å‡æŸå¤±</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$4.2M</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$3.8M</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“‰ ç•¥é™</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>ä¸»è¦æ”»å‡»ç±»å‹</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">é—ªç”µè´·ï¼ˆ35%ï¼‰</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">é¢„è¨€æœºæ“çºµï¼ˆ42%ï¼‰</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”„ å˜åŒ–</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>ç¨³å®šå¸ç›¸å…³</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">12%çš„æ”»å‡»</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">18%çš„æ”»å‡»</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“ˆ ä¸Šå‡</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>èµ„é‡‘è¿½å›ç‡</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">8%</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">15%</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“ˆ æ”¹å–„</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="warning-box">
            <h4>âš ï¸ ç¨³å®šå¸å®‰å…¨çš„ç‹¬ç‰¹æŒ‘æˆ˜</h4>
            <ul>
                <li><strong>ä»·æ ¼ç¨³å®šæœºåˆ¶</strong>ï¼šå¤æ‚çš„ç®—æ³•å’Œåé¦ˆå¾ªç¯å¢åŠ æ”»å‡»é¢</li>
                <li><strong>å¤šèµ„äº§æŠµæŠ¼</strong>ï¼šä¸åŒèµ„äº§çš„é£é™©ç‰¹å¾éœ€è¦ç»¼åˆè€ƒè™‘</li>
                <li><strong>è·¨åè®®ä¾èµ–</strong>ï¼šä¸AMMã€å€Ÿè´·åè®®çš„æ·±åº¦é›†æˆ</li>
                <li><strong>æ²»ç†å¤æ‚æ€§</strong>ï¼šå»ä¸­å¿ƒåŒ–æ²»ç†ä¸å®‰å…¨æ€§çš„å¹³è¡¡</li>
                <li><strong>ç›‘ç®¡å‹åŠ›</strong>ï¼šåˆè§„è¦æ±‚å¯èƒ½å¼•å…¥æ–°çš„ä¸­å¿ƒåŒ–é£é™©</li>
            </ul>
        </div>
        
        <div class="theory-section">
            <h4>9.1.1 å®‰å…¨å¨èƒåˆ†ç±»ä½“ç³»</h4>
            <p>ç¨³å®šå¸ç³»ç»Ÿçš„å®‰å…¨å¨èƒå‘ˆç°å¤šå±‚æ¬¡ã€å¤šç»´åº¦çš„ç‰¹å¾ï¼š</p>
            
            <h5>1. ä»£ç å±‚é¢å¨èƒ</h5>
            <ul>
                <li><strong>é‡å…¥æ”»å‡»ï¼ˆReentrancyï¼‰</strong>ï¼šå¤–éƒ¨è°ƒç”¨æœŸé—´çš„çŠ¶æ€ä¸ä¸€è‡´</li>
                <li><strong>æ•´æ•°æº¢å‡º/ä¸‹æº¢</strong>ï¼šç®—æœ¯è¿ç®—çš„è¾¹ç•Œæ¡ä»¶é”™è¯¯</li>
                <li><strong>è®¿é—®æ§åˆ¶ç¼ºé™·</strong>ï¼šæƒé™ç®¡ç†ä¸å½“å¯¼è‡´çš„è¶Šæƒæ“ä½œ</li>
                <li><strong>é€»è¾‘é”™è¯¯</strong>ï¼šä¸šåŠ¡é€»è¾‘å®ç°ä¸è®¾è®¡ä¸ç¬¦</li>
                <li><strong>ç²¾åº¦æŸå¤±</strong>ï¼šä¸åŒå°æ•°ä½ä»£å¸çš„è½¬æ¢é”™è¯¯</li>
                <li><strong>éæ ‡å‡†ERC20å¤„ç†</strong>ï¼šéƒ¨åˆ†ä»£å¸ä¸è¿”å›å¸ƒå°”å€¼</li>
            </ul>
            
            <h5>é‡å…¥æ”»å‡»è¯¦è§£</h5>
            <div class="code-block">
                <div class="code-header">
                    Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-solidity">// ç¤ºä¾‹1ï¼šç»å…¸é‡å…¥æ”»å‡»
contract VulnerableVault {
    mapping(address => uint256) public balances;
    
    // åŸºç¡€ç‰ˆæ¼æ´ï¼šçŠ¶æ€æ›´æ–°åœ¨å¤–éƒ¨è°ƒç”¨ä¹‹å
    function withdraw(uint256 amount) external {
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // å±é™©ï¼šå…ˆè½¬è´¦ï¼Œåæ›´æ–°çŠ¶æ€
        (bool success,) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
        
        balances[msg.sender] -= amount;  // æ”»å‡»è€…å¯ä»¥åœ¨æ­¤ä¹‹å‰å†æ¬¡è°ƒç”¨withdraw
    }
}

// ä¿®å¤ç‰ˆï¼šæ£€æŸ¥-ç”Ÿæ•ˆ-äº¤äº’æ¨¡å¼
contract SecureVault {
    mapping(address => uint256) public balances;
    
    function withdraw(uint256 amount) external {
        // æ£€æŸ¥
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // ç”Ÿæ•ˆï¼šå…ˆæ›´æ–°çŠ¶æ€
        balances[msg.sender] -= amount;
        
        // äº¤äº’ï¼šæœ€åè¿›è¡Œå¤–éƒ¨è°ƒç”¨
        (bool success,) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }
}

// è¿›é˜¶ç‰ˆï¼šåªè¯»é‡å…¥æ”»å‡»
contract ReadOnlyReentrancy {
    uint256 public totalShares;
    mapping(address => uint256) public shares;
    
    // æ¼æ´ï¼šåœ¨å¤–éƒ¨è°ƒç”¨æœŸé—´ï¼ŒtotalShareså¯èƒ½ä¸å‡†ç¡®
    function withdraw() external {
        uint256 userShares = shares[msg.sender];
        require(userShares > 0, "No shares");
        
        // è®¡ç®—ä»½é¢ä»·å€¼
        uint256 value = (address(this).balance * userShares) / totalShares;
        
        // æ›´æ–°çŠ¶æ€
        shares[msg.sender] = 0;
        totalShares -= userShares;
        
        // å¤–éƒ¨è°ƒç”¨
        IExternalContract(externalContract).notifyWithdrawal(msg.sender, value);
        // é—®é¢˜ï¼šå¦‚æœnotifyWithdrawalè°ƒç”¨äº†getSharePrice()ï¼Œ
        // å®ƒä¼šçœ‹åˆ°æ›´æ–°åçš„totalSharesï¼Œä½†ä½™é¢è¿˜æ²¡æœ‰è½¬å‡º
        
        payable(msg.sender).transfer(value);
    }
    
    // åªè¯»å‡½æ•°ï¼Œä½†å¯èƒ½è¿”å›ä¸ä¸€è‡´çš„çŠ¶æ€
    function getSharePrice() external view returns (uint256) {
        if (totalShares == 0) return 0;
        return address(this).balance / totalShares;
    }
}

// å®Œå…¨ä¿®å¤ç‰ˆï¼šä½¿ç”¨ReentrancyGuard
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";

contract FullySecureVault is ReentrancyGuard {
    mapping(address => uint256) public shares;
    uint256 public totalShares;
    
    function withdraw() external nonReentrant {
        uint256 userShares = shares[msg.sender];
        require(userShares > 0, "No shares");
        
        uint256 value = (address(this).balance * userShares) / totalShares;
        
        shares[msg.sender] = 0;
        totalShares -= userShares;
        
        // nonReentrantä¿®é¥°ç¬¦ä¿æŠ¤æ‰€æœ‰å¤–éƒ¨è°ƒç”¨
        IExternalContract(externalContract).notifyWithdrawal(msg.sender, value);
        payable(msg.sender).transfer(value);
    }
}</code></pre>
                </div>
            </div>
            
            <h5>2. æ¶æ„å±‚é¢å¨èƒ</h5>
            <ul>
                <li><strong>é¢„è¨€æœºæ“çºµ</strong>ï¼šä»·æ ¼æºè¢«æ¶æ„æ§åˆ¶</li>
                <li><strong>æ²»ç†æ”»å‡»</strong>ï¼šé€šè¿‡æ²»ç†æœºåˆ¶çªƒå–æ§åˆ¶æƒ</li>
                <li><strong>è·¨é“¾æ¡¥æ¼æ´</strong>ï¼šè·¨é“¾é€šä¿¡çš„å®‰å…¨è–„å¼±ç‚¹</li>
                <li><strong>ç»„åˆæ€§é£é™©</strong>ï¼šä¸å…¶ä»–åè®®äº¤äº’äº§ç”Ÿçš„æ–°é£é™©</li>
            </ul>
            
            <h5>3. ç»æµå±‚é¢å¨èƒ</h5>
            <ul>
                <li><strong>é—ªç”µè´·æ”»å‡»</strong>ï¼šåˆ©ç”¨åŸå­æ€§äº¤æ˜“è¿›è¡Œä»·æ ¼æ“çºµ</li>
                <li><strong>MEVæ”»å‡»</strong>ï¼šçŸ¿å·¥/éªŒè¯è€…çš„äº¤æ˜“æ’åºæ”»å‡»</li>
                <li><strong>é“¶è¡ŒæŒ¤å…‘</strong>ï¼šå¤§è§„æ¨¡èµå›å¯¼è‡´çš„æµåŠ¨æ€§å±æœº</li>
                <li><strong>æ­»äº¡èºæ—‹</strong>ï¼šè´Ÿåé¦ˆå¾ªç¯å¯¼è‡´çš„ç³»ç»Ÿå´©æºƒ</li>
            </ul>
        </div>

        <div class="practice-section">
            <h4>9.1.2 å†å²æ”»å‡»æ¡ˆä¾‹åˆ†æ</h4>
            
            <div class="example-box" style="background-color: #fee2e2; margin: 20px 0;">
                <h4>ğŸ’¥ é‡å¤§ç¨³å®šå¸å®‰å…¨äº‹ä»¶æ—¶é—´çº¿</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background-color: #fef3c7;">
                            <th style="border: 1px solid #f59e0b; padding: 12px;">æ—¶é—´</th>
                            <th style="border: 1px solid #f59e0b; padding: 12px;">é¡¹ç›®</th>
                            <th style="border: 1px solid #f59e0b; padding: 12px;">æŸå¤±</th>
                            <th style="border: 1px solid #f59e0b; padding: 12px;">æ”»å‡»ç±»å‹</th>
                            <th style="border: 1px solid #f59e0b; padding: 12px;">å…³é”®æ•™è®­</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">2022.05</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;"><strong>UST/Luna</strong></td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">$60B</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">æ­»äº¡èºæ—‹</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">çº¯ç®—æ³•ç¨³å®šå¸çš„è„†å¼±æ€§</td>
                        </tr>
                        <tr style="background-color: #fef9e7;">
                            <td style="border: 1px solid #f59e0b; padding: 12px;">2023.03</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;"><strong>USDC</strong></td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">è„±é”š13%</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">é“¶è¡Œé£é™©</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">ä¸­å¿ƒåŒ–å‚¨å¤‡çš„ç³»ç»Ÿæ€§é£é™©</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">2023.07</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;"><strong>crvUSD</strong></td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">$70M</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">é‡å…¥æ”»å‡»</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">ç¼–è¯‘å™¨æ¼æ´çš„è¿é”æ•ˆåº”</td>
                        </tr>
                        <tr style="background-color: #fef9e7;">
                            <td style="border: 1px solid #f59e0b; padding: 12px;">2024.01</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;"><strong>Platypus</strong></td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">$8.5M</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">é—ªç”µè´·</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">ç´§æ€¥ææ¬¾æœºåˆ¶çš„æ¼æ´</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">2024.04</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;"><strong>æŸç®—æ³•ç¨³å®šå¸</strong></td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">$12M</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">é¢„è¨€æœºæ“çºµ</td>
                            <td style="border: 1px solid #f59e0b; padding: 12px;">å•ä¸€ä»·æ ¼æºçš„å±é™©</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="tip-box">
                <p><strong>ğŸ” æ·±åº¦åˆ†æè¦ç‚¹ï¼š</strong>æ¯ä¸ªæ”»å‡»æ¡ˆä¾‹éƒ½æš´éœ²äº†ç‰¹å®šçš„ç³»ç»Ÿæ€§å¼±ç‚¹ã€‚ç†è§£è¿™äº›å¼±ç‚¹ä¸ä»…å¸®åŠ©æˆ‘ä»¬æ„å»ºæ›´å®‰å…¨çš„ç³»ç»Ÿï¼Œä¹Ÿè®©æˆ‘ä»¬è®¤è¯†åˆ°å®‰å…¨æ˜¯ä¸€ä¸ªæŒç»­æ¼”è¿›çš„è¿‡ç¨‹ã€‚</p>
            </div>
            
            <div class="code-block">
                <div class="code-header">
                    Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-solidity">// æ¡ˆä¾‹1ï¼šUST/Luna æ­»äº¡èºæ—‹ï¼ˆ2022å¹´5æœˆï¼‰
// æ”»å‡»å‘é‡ï¼šå¤§è§„æ¨¡USTæŠ›å”® â†’ Lunaå¢å‘ â†’ ä»·æ ¼ä¸‹è·Œ â†’ æ›´å¤šå¢å‘
contract TerraUSDVulnerability {
    // é—®é¢˜ï¼šç®—æ³•ç¨³å®šæœºåˆ¶ä¾èµ–å•ä¸€èµ„äº§ä»·å€¼
    // Lunaä»·æ ¼ä¸‹è·Œæ—¶ï¼Œéœ€è¦å¢å‘æ›´å¤šLunaæ¥ç»´æŒUSTé”šå®š
    
    function mint(uint256 ustAmount) external {
        uint256 lunaPrice = getOraclePrice();
        // è‡´å‘½ç¼ºé™·ï¼šæ— å¢å‘ä¸Šé™ï¼Œæ— ç†”æ–­æœºåˆ¶
        uint256 lunaToMint = ustAmount / lunaPrice;
        _mintLuna(msg.sender, lunaToMint);
    }
}

// æ¡ˆä¾‹2ï¼šEuler Finance æ”»å‡»ï¼ˆ2023å¹´3æœˆï¼ŒæŸå¤±1.97äº¿ç¾å…ƒï¼‰
contract EulerVulnerability {
    // é—®é¢˜ï¼šdonateåŠŸèƒ½ä¸æ æ†æœºåˆ¶çš„ç»„åˆæ¼æ´
    
    function donateToReserves(uint256 amount) external {
        // ç¼ºé™·ï¼šæœªæ£€æŸ¥donateåçš„å¥åº·å› å­
        reserves += amount;
        // æ”»å‡»è€…é€šè¿‡donateæ“ä½œç ´åäº†ä¼šè®¡ç³»ç»Ÿ
    }
    
    function liquidate(address borrower) external {
        // æ¸…ç®—é€»è¾‘ä¾èµ–è¢«æ“çºµçš„å‚¨å¤‡é‡‘æ•°æ®
        uint256 collateral = getCollateralValue(borrower);
        // å¯¼è‡´ä¸å½“æ¸…ç®—
    }
}

// æ¡ˆä¾‹3ï¼šPlatypus Finance æ”»å‡»ï¼ˆ2023å¹´2æœˆï¼ŒæŸå¤±850ä¸‡ç¾å…ƒï¼‰
contract PlatypusVulnerability {
    mapping(address => uint256) public balances;
    
    // é—®é¢˜ï¼šç´§æ€¥ææ¬¾åŠŸèƒ½çš„é€»è¾‘é”™è¯¯
    function emergencyWithdraw() external {
        uint256 amount = balances[msg.sender];
        // è‡´å‘½é”™è¯¯ï¼šä½¿ç”¨äº†é”™è¯¯çš„ä½™é¢è®¡ç®—
        // åº”è¯¥è€ƒè™‘è´Ÿå€ºï¼Œä½†åªæ£€æŸ¥äº†èµ„äº§
        _transfer(msg.sender, amount);
        balances[msg.sender] = 0;
    }
}</code></pre>
                </div>
            </div>
        </div>
        
        <h4>9.1.3 MEVæ”»å‡»ä¸é˜²æŠ¤</h4>
        
        <div class="intro-box" style="background-color: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h4>âš¡ MEVï¼šåŒºå—é“¾çš„æš—é»‘æ£®æ—</h4>
            <p>MEVï¼ˆæœ€å¤§å¯æå–ä»·å€¼ï¼‰ä»£è¡¨ç€åŒºå—é“¾ä¸­çš„"æš—é»‘æ£®æ—"æ³•åˆ™ã€‚åœ¨è¿™ä¸ªä¸–ç•Œé‡Œï¼Œæ¯ä¸€ç¬”äº¤æ˜“éƒ½å¯èƒ½æˆä¸ºçŒç‰©ï¼Œè€ŒMEVæœç´¢è€…å°±æ˜¯æ½œä¼åœ¨é»‘æš—ä¸­çš„çŒäººã€‚å¯¹äºç¨³å®šå¸ç³»ç»Ÿï¼ŒMEVæ”»å‡»å¯èƒ½å¯¼è‡´ç”¨æˆ·æŸå¤±ã€ç³»ç»Ÿä¸ç¨³å®šç”šè‡³åè®®å´©æºƒã€‚</p>
        </div>
        
        <div class="warning-box">
            <p><strong>MEVï¼ˆæœ€å¤§å¯æå–ä»·å€¼ï¼‰</strong>æ˜¯å¯¹ä»»ä½•é“¾ä¸Šé‡‘èç³»ç»Ÿï¼ˆå°¤å…¶æ˜¯ç¨³å®šå¸ï¼‰çš„å·¨å¤§å¨èƒã€‚MEVæœºå™¨äººå¯ä»¥é€šè¿‡é‡æ–°æ’åºã€æ’å…¥æˆ–å®¡æŸ¥äº¤æ˜“æ¥è·åˆ©ã€‚</p>
        </div>
        
        <div class="info-box">
            <h4>ğŸ¯ å¸¸è§MEVæ”»å‡»ç±»å‹ä¸ç¨³å®šå¸å½±å“</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">æ”»å‡»ç±»å‹</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">æ”»å‡»åŸç†</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">ç¨³å®šå¸å½±å“</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">é˜²æŠ¤éš¾åº¦</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>ä¸‰æ˜æ²»æ”»å‡»</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å‰ç½®+åç½®äº¤æ˜“å¤¹å‡»ç”¨æˆ·</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">é“¸é€ /èµå›æ»‘ç‚¹æŸå¤±</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­ç­‰</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æŠ¢å…ˆäº¤æ˜“</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å¤åˆ¶å¹¶æŠ¢å…ˆæ‰§è¡Œè·åˆ©äº¤æ˜“</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å¥—åˆ©æœºä¼šè¢«å¤ºå–</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¢ è¾ƒæ˜“</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>å°¾éšæ”»å‡»</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">åœ¨å¤§é¢äº¤æ˜“åç«‹å³åå‘äº¤æ˜“</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ä»·æ ¼æ“çºµé£é™©</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­ç­‰</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ¸…ç®—æŠ¢è·‘</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">æŠ¢å…ˆæ‰§è¡Œæœ‰åˆ©å¯å›¾çš„æ¸…ç®—</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">æ¸…ç®—æ¿€åŠ±æœºåˆ¶å¤±æ•ˆ</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ å›°éš¾</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ—¶é—´å¼ºç›—</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">é‡ç»„åŒºå—è·å–MEV</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">äº¤æ˜“æœ€ç»ˆæ€§é£é™©</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ æéš¾</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="example-box" style="background-color: #fef3c7; margin: 20px 0;">
            <h4>ğŸ’° MEVæ•°æ®æ´å¯Ÿï¼ˆ2024å¹´ï¼‰</h4>
            <ul>
                <li><strong>æ¯æ—¥MEVæ€»é¢</strong>ï¼š$2-5Mï¼ˆä»¥å¤ªåŠä¸»ç½‘ï¼‰</li>
                <li><strong>ç¨³å®šå¸ç›¸å…³MEV</strong>ï¼šå æ€»MEVçš„15-20%</li>
                <li><strong>æœ€å¤§å•ç¬”MEV</strong>ï¼š$8.1Mï¼ˆCurveæ± å¥—åˆ©ï¼‰</li>
                <li><strong>å¹³å‡ä¸‰æ˜æ²»æ”»å‡»æŸå¤±</strong>ï¼šäº¤æ˜“é¢çš„0.3-0.5%</li>
                <li><strong>å—å½±å“ç”¨æˆ·æ¯”ä¾‹</strong>ï¼šå¤§é¢äº¤æ˜“çš„35%+</li>
            </ul>
        </div>
        
        <div class="code-block">
            <div class="code-header">
                Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-solidity">// MEVä¸‰æ˜æ²»æ”»å‡»ç¤ºä¾‹
contract VulnerableStablecoinSwap {
    IUniswapV2Router public router;
    IERC20 public stablecoin;
    
    // æ¼æ´ï¼šç›´æ¥åœ¨DEXä¸Šäº¤æ˜“ï¼Œå®¹æ˜“è¢«MEVæ”»å‡»
    function swapStablecoinForETH(uint256 amount) external {
        stablecoin.transferFrom(msg.sender, address(this), amount);
        stablecoin.approve(address(router), amount);
        
        address[] memory path = new address[](2);
        path[0] = address(stablecoin);
        path[1] = router.WETH();
        
        // MEVæœºå™¨äººå¯ä»¥ï¼š
        // 1. å‰ç½®äº¤æ˜“ï¼šåœ¨ç”¨æˆ·äº¤æ˜“å‰ä¹°å…¥ETH
        // 2. ç”¨æˆ·äº¤æ˜“æ‰§è¡Œï¼Œæ¨é«˜ETHä»·æ ¼
        // 3. åç½®äº¤æ˜“ï¼šå–å‡ºETHè·åˆ©
        router.swapExactTokensForETH(
            amount,
            0,  // æ²¡æœ‰æ»‘ç‚¹ä¿æŠ¤
            path,
            msg.sender,
            block.timestamp
        );
    }
}

// MEVé˜²æŠ¤æ–¹æ¡ˆ
contract MEVProtectedStablecoinSwap {
    using SafeERC20 for IERC20;
    
    IUniswapV2Router public immutable router;
    IERC20 public immutable stablecoin;
    
    // é˜²æŠ¤æªæ–½1ï¼šæäº¤-æ­ç¤ºæ¨¡å¼
    mapping(address => bytes32) private commitments;
    mapping(address => uint256) private commitTimestamps;
    
    function commitSwap(bytes32 commitment) external {
        commitments[msg.sender] = commitment;
        commitTimestamps[msg.sender] = block.timestamp;
    }
    
    function executeSwap(
        uint256 amount,
        uint256 minAmountOut,
        uint256 deadline,
        uint256 nonce
    ) external {
        // éªŒè¯æ‰¿è¯º
        require(
            block.timestamp >= commitTimestamps[msg.sender] + 1 minutes,
            "Too early"
        );
        
        bytes32 commitment = keccak256(abi.encodePacked(
            msg.sender,
            amount,
            minAmountOut,
            deadline,
            nonce
        ));
        require(commitments[msg.sender] == commitment, "Invalid commitment");
        
        // æ¸…é™¤æ‰¿è¯º
        delete commitments[msg.sender];
        delete commitTimestamps[msg.sender];
        
        // é˜²æŠ¤æªæ–½2ï¼šæ»‘ç‚¹ä¿æŠ¤
        require(deadline >= block.timestamp, "Expired");
        
        stablecoin.safeTransferFrom(msg.sender, address(this), amount);
        stablecoin.safeApprove(address(router), amount);
        
        address[] memory path = new address[](2);
        path[0] = address(stablecoin);
        path[1] = router.WETH();
        
        uint256[] memory amounts = router.swapExactTokensForETH(
            amount,
            minAmountOut,  // æ»‘ç‚¹ä¿æŠ¤
            path,
            msg.sender,
            deadline
        );
        
        emit SwapExecuted(msg.sender, amount, amounts[1]);
    }
    
    // é˜²æŠ¤æªæ–½3ï¼šä½¿ç”¨ç§æœ‰äº¤æ˜“æ± 
    function privateSwap(
        uint256 amount,
        uint256 minAmountOut,
        bytes calldata signature
    ) external {
        // é€šè¿‡Flashbotsæˆ–å…¶ä»–ç§æœ‰RPCæäº¤
        // éªŒè¯ç­¾åç¡®ä¿åªæœ‰æˆæƒçš„builderå¯ä»¥åŒ…å«æ­¤äº¤æ˜“
        // ...
    }
}

// é˜²æŠ¤æªæ–½4ï¼šæ‰¹é‡æ‹å–æœºåˆ¶
contract BatchAuctionSwap {
    struct Order {
        address user;
        uint256 amountIn;
        uint256 minAmountOut;
    }
    
    Order[] public pendingOrders;
    uint256 public auctionEndTime;
    
    function submitOrder(uint256 amountIn, uint256 minAmountOut) external {
        require(block.timestamp < auctionEndTime, "Auction ended");
        
        pendingOrders.push(Order({
            user: msg.sender,
            amountIn: amountIn,
            minAmountOut: minAmountOut
        }));
        
        stablecoin.transferFrom(msg.sender, address(this), amountIn);
    }
    
    function executeBatch() external {
        require(block.timestamp >= auctionEndTime, "Auction not ended");
        
        // æ‰€æœ‰è®¢å•åŒæ—¶æ‰§è¡Œï¼Œæ¶ˆé™¤MEVæœºä¼š
        uint256 totalAmountIn = 0;
        for (uint i = 0; i < pendingOrders.length; i++) {
            totalAmountIn += pendingOrders[i].amountIn;
        }
        
        // æ‰§è¡Œå•æ¬¡å¤§äº¤æ˜“
        uint256 totalAmountOut = _performSwap(totalAmountIn);
        
        // æŒ‰æ¯”ä¾‹åˆ†é…
        for (uint i = 0; i < pendingOrders.length; i++) {
            Order memory order = pendingOrders[i];
            uint256 amountOut = (totalAmountOut * order.amountIn) / totalAmountIn;
            
            require(amountOut >= order.minAmountOut, "Slippage");
            payable(order.user).transfer(amountOut);
        }
        
        delete pendingOrders;
    }
}</code></pre>
            </div>
        </div>
        
        <h4>9.1.4 ç­¾åé‡æ”¾æ”»å‡»ä¸EIP-712</h4>
        
        <p>å¯¹äºæ”¯æŒpermitåŠŸèƒ½ï¼ˆEIP-2612ï¼‰çš„ç¨³å®šå¸ï¼Œç­¾åé‡æ”¾æ”»å‡»æ˜¯ä¸€ä¸ªé‡è¦å¨èƒï¼š</p>
        
        <div class="code-block">
            <div class="code-header">
                Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-solidity">// EIP-712ç»“æ„åŒ–æ•°æ®ç­¾å
contract SecurePermitStablecoin is ERC20, EIP712 {
    // EIP-2612 permit
    mapping(address => uint256) public nonces;
    
    bytes32 private constant PERMIT_TYPEHASH = keccak256(
        "Permit(address owner,address spender,uint256 value,uint256 nonce,uint256 deadline)"
    );
    
    constructor() ERC20("Secure Stablecoin", "SSTBL") 
        EIP712("Secure Stablecoin", "1") {}
    
    function permit(
        address owner,
        address spender,
        uint256 value,
        uint256 deadline,
        uint8 v,
        bytes32 r,
        bytes32 s
    ) external {
        // é˜²æŠ¤æªæ–½1ï¼šæ£€æŸ¥æˆªæ­¢æ—¶é—´
        require(block.timestamp <= deadline, "Expired");
        
        // é˜²æŠ¤æªæ–½2ï¼šä½¿ç”¨nonceé˜²æ­¢é‡æ”¾
        uint256 currentNonce = nonces[owner]++;
        
        // é˜²æŠ¤æªæ–½3ï¼šä½¿ç”¨EIP-712ç»“æ„åŒ–æ•°æ®
        bytes32 structHash = keccak256(abi.encode(
            PERMIT_TYPEHASH,
            owner,
            spender,
            value,
            currentNonce,
            deadline
        ));
        
        bytes32 hash = _hashTypedDataV4(structHash);
        
        // éªŒè¯ç­¾å
        address signer = ECDSA.recover(hash, v, r, s);
        require(signer == owner, "Invalid signature");
        
        _approve(owner, spender, value);
    }
    
    // é˜²æŠ¤æªæ–½4ï¼šdomain separatoré˜²æ­¢è·¨é“¾é‡æ”¾
    function DOMAIN_SEPARATOR() external view returns (bytes32) {
        return _domainSeparatorV4();
    }
}

// é”™è¯¯ç¤ºä¾‹ï¼šæ²¡æœ‰é˜²æŠ¤çš„permit
contract VulnerablePermit {
    mapping(address => mapping(address => uint256)) public allowances;
    
    // æ¼æ´ï¼šæ²¡æœ‰nonceï¼Œç­¾åå¯ä»¥è¢«é‡æ”¾
    function permit(
        address owner,
        address spender,
        uint256 value,
        uint8 v,
        bytes32 r,
        bytes32 s
    ) external {
        bytes32 hash = keccak256(abi.encodePacked(
            owner,
            spender,
            value
        ));
        
        address signer = ecrecover(hash, v, r, s);
        require(signer == owner, "Invalid signature");
        
        // æ”»å‡»è€…å¯ä»¥é‡æ”¾è¿™ä¸ªç­¾åå¤šæ¬¡
        allowances[owner][spender] = value;
    }
}

// é«˜çº§é˜²æŠ¤ï¼šæ”¯æŒå–æ¶ˆå’Œæ‰¹é‡permit
contract AdvancedPermit is SecurePermitStablecoin {
    mapping(bytes32 => bool) public cancelledPermits;
    
    // å…è®¸ç”¨æˆ·å–æ¶ˆæœªä½¿ç”¨çš„permit
    function cancelPermit(
        address spender,
        uint256 value,
        uint256 deadline,
        uint256 nonce
    ) external {
        bytes32 permitId = keccak256(abi.encodePacked(
            msg.sender,
            spender,
            value,
            deadline,
            nonce
        ));
        
        cancelledPermits[permitId] = true;
        emit PermitCancelled(permitId);
    }
    
    // æ‰¹é‡permitä»¥èŠ‚çœgas
    function batchPermit(
        address[] calldata owners,
        address[] calldata spenders,
        uint256[] calldata values,
        uint256[] calldata deadlines,
        uint8[] calldata vs,
        bytes32[] calldata rs,
        bytes32[] calldata ss
    ) external {
        require(
            owners.length == spenders.length &&
            owners.length == values.length &&
            owners.length == deadlines.length &&
            owners.length == vs.length &&
            owners.length == rs.length &&
            owners.length == ss.length,
            "Length mismatch"
        );
        
        for (uint i = 0; i < owners.length; i++) {
            permit(
                owners[i],
                spenders[i],
                values[i],
                deadlines[i],
                vs[i],
                rs[i],
                ss[i]
            );
        }
    }
}</code></pre>
            </div>
        </div>

        <h4>9.1.5 é€»è¾‘æ¼æ´ï¼ˆLogic Bugsï¼‰</h4>
        <p>é€»è¾‘æ¼æ´æ˜¯å®¡è®¡ä¸­å‘ç°æœ€å¤šçš„é—®é¢˜ç±»åˆ«ï¼Œé€šå¸¸æºäºä¸šåŠ¡é€»è¾‘çš„å®ç°é”™è¯¯ã€‚</p>
        
        <div class="code-block collapsible">
            <div class="code-header" onclick="toggleCode(this)">
                <span class="toggle-icon">â–¼</span>
                <span>çŠ¶æ€æœºè®¾è®¡ç¼ºé™·ç¤ºä¾‹</span>
            </div>
            <pre class="collapsed"><code class="language-solidity">// é”™è¯¯çš„å¥–åŠ±è®¡ç®—é€»è¾‘
contract FlawedRewardSystem {
    mapping(address => uint256) public stakes;
    mapping(address => uint256) public lastClaimTime;
    uint256 public rewardRate = 100; // æ¯ç§’å¥–åŠ±ç‡
    
    // æ¼æ´ï¼šæœªè€ƒè™‘è´¨æŠ¼é‡‘é¢å˜åŒ–çš„æ—¶é—´ç‚¹
    function claimRewards() external {
        uint256 timePassed = block.timestamp - lastClaimTime[msg.sender];
        // é”™è¯¯ï¼šä½¿ç”¨å½“å‰è´¨æŠ¼é‡‘é¢è®¡ç®—å†å²å¥–åŠ±
        uint256 rewards = stakes[msg.sender] * rewardRate * timePassed;
        lastClaimTime[msg.sender] = block.timestamp;
        // è½¬è´¦å¥–åŠ±...
    }
    
    function stake(uint256 amount) external {
        // æ¼æ´ï¼šæœªåœ¨è´¨æŠ¼å‰ç»“ç®—ä¹‹å‰çš„å¥–åŠ±
        stakes[msg.sender] += amount;
        // ç”¨æˆ·å¯ä»¥åœ¨claimå‰å¤§é‡è´¨æŠ¼ï¼Œè·å–ä¸å½“å¥–åŠ±
    }
}

// æ­£ç¡®å®ç°
contract SecureRewardSystem {
    struct UserInfo {
        uint256 amount;
        uint256 rewardDebt;
    }
    
    mapping(address => UserInfo) public userInfo;
    uint256 public accRewardPerShare;
    uint256 public lastRewardTime;
    
    modifier update() {
        if (block.timestamp > lastRewardTime) {
            uint256 timePassed = block.timestamp - lastRewardTime;
            accRewardPerShare += (rewardRate * timePassed * 1e12) / totalStaked;
            lastRewardTime = block.timestamp;
        }
        _;
    }
    
    function stake(uint256 amount) external update {
        UserInfo storage user = userInfo[msg.sender];
        // å…ˆç»“ç®—ä¹‹å‰çš„å¥–åŠ±
        if (user.amount > 0) {
            uint256 pending = (user.amount * accRewardPerShare / 1e12) - user.rewardDebt;
            // è½¬è´¦pendingå¥–åŠ±
        }
        user.amount += amount;
        user.rewardDebt = user.amount * accRewardPerShare / 1e12;
    }
}</code></pre>
        </div>

        <h4>9.1.6 ç²¾åº¦æŸå¤±ï¼ˆPrecision Lossï¼‰</h4>
        <p>åœ¨å¤„ç†ä¸åŒç²¾åº¦ä»£å¸æ—¶ï¼Œä¸æ­£ç¡®çš„ä¹˜é™¤é¡ºåºä¼šå¯¼è‡´ä¸¥é‡çš„èµ„é‡‘æŸå¤±ã€‚</p>
        
        <div class="code-block collapsible">
            <div class="code-header" onclick="toggleCode(this)">
                <span class="toggle-icon">â–¼</span>
                <span>ç²¾åº¦æŸå¤±æ¼æ´ç¤ºä¾‹</span>
            </div>
            <pre class="collapsed"><code class="language-solidity">// ç²¾åº¦æŸå¤±ç¤ºä¾‹
contract PrecisionLossExample {
    // USDC: 6 decimals, DAI: 18 decimals
    uint256 constant USDC_DECIMALS = 6;
    uint256 constant DAI_DECIMALS = 18;
    
    // é”™è¯¯ï¼šå…ˆé™¤åä¹˜å¯¼è‡´ç²¾åº¦æŸå¤±
    function convertUSDCToDAI_Wrong(uint256 usdcAmount, uint256 price) 
        public pure returns (uint256) {
        // priceæ ¼å¼ï¼š1 USDC = price DAI (18 decimals)
        // é”™è¯¯ï¼šæ•´æ•°é™¤æ³•ä¼šä¸¢å¤±ç²¾åº¦
        return (usdcAmount / 10**USDC_DECIMALS) * price;
    }
    
    // æ­£ç¡®ï¼šå…ˆä¹˜åé™¤ï¼Œä¿æŒç²¾åº¦
    function convertUSDCToDAI_Correct(uint256 usdcAmount, uint256 price) 
        public pure returns (uint256) {
        // ä½¿ç”¨ç¼©æ”¾å› å­é¿å…æº¢å‡º
        return (usdcAmount * price) / 10**USDC_DECIMALS;
    }
    
    // é«˜çº§ï¼šä½¿ç”¨å®šç‚¹æ•°å­¦åº“
    using FixedPoint for uint256;
    
    function convertWithFixedPoint(uint256 usdcAmount, uint256 price) 
        public pure returns (uint256) {
        // è½¬æ¢ä¸ºå®šç‚¹æ•°è¿›è¡Œè®¡ç®—
        uint256 scaledAmount = usdcAmount.mul(10**(18 - USDC_DECIMALS));
        return scaledAmount.mulDiv(price, FixedPoint.Q112);
    }
}

// å®é™…æ¡ˆä¾‹ï¼šæ¸…ç®—è®¡ç®—ç²¾åº¦é—®é¢˜
contract LiquidationPrecision {
    uint256 constant LIQUIDATION_PENALTY = 11000; // 110% (basis points)
    uint256 constant BASIS_POINTS = 10000;
    
    // é”™è¯¯ï¼šè¿ç»­é™¤æ³•å¯¼è‡´ç²¾åº¦æŸå¤±
    function calculateLiquidationAmount_Wrong(
        uint256 debt,
        uint256 collateralPrice,
        uint256 debtPrice
    ) public pure returns (uint256) {
        // é”™è¯¯é¡ºåºï¼šæ¯æ¬¡é™¤æ³•éƒ½ä¼šæŸå¤±ç²¾åº¦
        return debt * LIQUIDATION_PENALTY / BASIS_POINTS 
               * debtPrice / collateralPrice;
    }
    
    // æ­£ç¡®ï¼šä¼˜åŒ–è¿ç®—é¡ºåº
    function calculateLiquidationAmount_Correct(
        uint256 debt,
        uint256 collateralPrice,
        uint256 debtPrice
    ) public pure returns (uint256) {
        // å…ˆåšæ‰€æœ‰ä¹˜æ³•ï¼Œæœ€ååšé™¤æ³•
        return (debt * LIQUIDATION_PENALTY * debtPrice) 
               / (BASIS_POINTS * collateralPrice);
    }
}</code></pre>
        </div>

        <h3 id="stablecoin-risks">9.2 ç¨³å®šå¸ç‰¹å®šé£é™©</h3>
        
        <div class="intro-box" style="background-color: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h4>ğŸ¯ ç¨³å®šå¸çš„ç‹¬ç‰¹æ”»å‡»é¢</h4>
            <p>ç¨³å®šå¸ä¸åŒäºæ™®é€šçš„DeFiåè®®ï¼Œå…¶æ ¸å¿ƒç›®æ ‡æ˜¯ç»´æŒä»·æ ¼ç¨³å®šã€‚è¿™ä¸ªçœ‹ä¼¼ç®€å•çš„ç›®æ ‡ï¼Œåœ¨å»ä¸­å¿ƒåŒ–ç¯å¢ƒä¸­å´é¢ä¸´ç€ç‹¬ç‰¹è€Œå¤æ‚çš„å®‰å…¨æŒ‘æˆ˜ã€‚ä»é¢„è¨€æœºæ“çºµåˆ°æ²»ç†æ”»å‡»ï¼Œä»é—ªç”µè´·å¥—åˆ©åˆ°è·¨é“¾æ¡¥æ¼æ´ï¼Œæ¯ä¸€ä¸ªç¯èŠ‚éƒ½å¯èƒ½æˆä¸ºæ”»å‡»è€…çš„çªç ´å£ã€‚</p>
            
            <div style="background-color: #e0f2fe; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h5>ğŸ” ç¨³å®šå¸å®‰å…¨çš„æ ¸å¿ƒæ‚–è®ºï¼š</h5>
                <ul>
                    <li><strong>ç¨³å®šæ€§ vs å»ä¸­å¿ƒåŒ–</strong>ï¼šè¶Šç¨³å®šå¾€å¾€æ„å‘³ç€è¶Šä¸­å¿ƒåŒ–</li>
                    <li><strong>æ•ˆç‡ vs å®‰å…¨æ€§</strong>ï¼šé«˜æ•ˆçš„ç¨³å®šæœºåˆ¶å¯èƒ½å¼•å…¥æ–°çš„é£é™©</li>
                    <li><strong>é€æ˜æ€§ vs å¯æ”»å‡»æ€§</strong>ï¼šå…¬å¼€çš„ç®—æ³•å®¹æ˜“è¢«åˆ†æå’Œæ”»å‡»</li>
                    <li><strong>åˆ›æ–° vs å¯é æ€§</strong>ï¼šæ–°æœºåˆ¶æœªç»æ—¶é—´æ£€éªŒ</li>
                </ul>
            </div>
        </div>
        
        <div class="info-box">
            <h4>ğŸ“Š ç¨³å®šå¸é£é™©çŸ©é˜µ</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">é£é™©ç±»åˆ«</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">æ³•å¸æŠµæŠ¼å‹</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">åŠ å¯†æŠµæŠ¼å‹</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">ç®—æ³•å‹</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">æ··åˆå‹</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>é¢„è¨€æœºé£é™©</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¢ ä½</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ é«˜</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ æé«˜</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>é“¶è¡ŒæŒ¤å…‘</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ æé«˜</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ²»ç†æ”»å‡»</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¢ ä½</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ é«˜</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>ç›‘ç®¡é£é™©</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ é«˜</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¢ ä½</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æŠ€æœ¯å¤æ‚åº¦</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¢ ä½</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ é«˜</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ æé«˜</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <h4>9.2.1 ä»·æ ¼æ“çºµä¸é¢„è¨€æœºæ”»å‡»</h4>
        <p>ç¨³å®šå¸ç³»ç»Ÿé«˜åº¦ä¾èµ–å‡†ç¡®çš„ä»·æ ¼ä¿¡æ¯ï¼Œè¿™ä½¿å…¶æˆä¸ºé¢„è¨€æœºæ”»å‡»çš„ä¸»è¦ç›®æ ‡ã€‚</p>
        
        <div class="warning-box">
            <h4>âš ï¸ é¢„è¨€æœºæ”»å‡»çš„è‡´å‘½æ€§</h4>
            <p>å¯¹äºç¨³å®šå¸ç³»ç»Ÿï¼Œé¢„è¨€æœºæä¾›çš„ä»·æ ¼æ•°æ®ç›´æ¥å½±å“ï¼š</p>
            <ul>
                <li><strong>æŠµæŠ¼ç‡è®¡ç®—</strong>ï¼šé”™è¯¯çš„ä»·æ ¼å¯èƒ½å¯¼è‡´ä¸å½“æ¸…ç®—æˆ–é“¸é€ </li>
                <li><strong>ç¨³å®šæœºåˆ¶</strong>ï¼šç®—æ³•ç¨³å®šå¸ä¾èµ–å‡†ç¡®ä»·æ ¼è°ƒæ•´ä¾›åº”</li>
                <li><strong>æ¸…ç®—é˜ˆå€¼</strong>ï¼šæ“çºµä»·æ ¼å¯è§¦å‘å¤§è§„æ¨¡æ¸…ç®—</li>
                <li><strong>å¥—åˆ©æœºä¼š</strong>ï¼šä»·æ ¼åå·®åˆ›é€ ä¸å½“è·åˆ©ç©ºé—´</li>
            </ul>
        </div>
        
        <div class="code-block collapsible">
            <div class="code-header" onclick="toggleCode(this)">
                <span class="toggle-icon">â–¼</span>
                <span>é¢„è¨€æœºæ“çºµé˜²æŠ¤å®ç°</span>
            </div>
            <pre class="collapsed"><code class="language-solidity">// å¤šé¢„è¨€æœºèšåˆå™¨
contract RobustPriceOracle {
    struct PriceData {
        uint256 price;
        uint256 timestamp;
        uint256 confidence;
    }
    
    mapping(address => PriceData) public chainlinkPrices;
    mapping(address => PriceData) public uniswapTWAP;
    mapping(address => PriceData) public internalPrices;
    
    uint256 constant PRICE_FRESHNESS = 3600; // 1å°æ—¶
    uint256 constant MAX_DEVIATION = 300; // 3%
    
    function getPrice(address token) external view returns (uint256) {
        PriceData memory chainlink = chainlinkPrices[token];
        PriceData memory twap = uniswapTWAP[token];
        PriceData memory internal = internalPrices[token];
        
        // æ£€æŸ¥ä»·æ ¼æ–°é²œåº¦
        require(block.timestamp - chainlink.timestamp <= PRICE_FRESHNESS, "Stale chainlink");
        require(block.timestamp - twap.timestamp <= PRICE_FRESHNESS, "Stale TWAP");
        
        // è®¡ç®—ä¸­ä½æ•°ä»·æ ¼
        uint256 medianPrice = _getMedian(chainlink.price, twap.price, internal.price);
        
        // æ£€æŸ¥ä»·æ ¼åç¦»
        require(_checkDeviation(chainlink.price, medianPrice), "Chainlink deviation");
        require(_checkDeviation(twap.price, medianPrice), "TWAP deviation");
        
        return medianPrice;
    }
    
    function _checkDeviation(uint256 price, uint256 reference) private pure returns (bool) {
        uint256 deviation = price > reference ? 
            ((price - reference) * 10000) / reference :
            ((reference - price) * 10000) / reference;
        return deviation <= MAX_DEVIATION;
    }
}</code></pre>
        </div>

        <h4>9.2.2 é—ªç”µè´·æ”»å‡»æ·±åº¦åˆ†æ</h4>
        <p>é—ªç”µè´·æœ¬èº«ä¸æ˜¯æ¼æ´ï¼Œè€Œæ˜¯åŸå­æ€§çš„èµ„æœ¬æ”¾å¤§å™¨ã€‚çœŸæ­£çš„é£é™©åœ¨äºåè®®çš„çŠ¶æ€ä¾èµ–å’Œä»·æ ¼è®¡ç®—é€»è¾‘ã€‚</p>
        
        <div class="example-box" style="background-color: #fef3c7; margin: 20px 0;">
            <h4>ğŸ’¡ é—ªç”µè´·æ”»å‡»çš„æœ¬è´¨</h4>
            <p>é—ªç”µè´·è®©ä»»ä½•äººéƒ½èƒ½åœ¨ä¸€ä¸ªäº¤æ˜“å†…ä¸´æ—¶è·å¾—å·¨é¢èµ„é‡‘ã€‚è¿™æ‰“ç ´äº†ä¼ ç»Ÿé‡‘èçš„èµ„æœ¬é—¨æ§›ï¼Œä½†ä¹Ÿä¸ºæ”»å‡»è€…æä¾›äº†å‰æ‰€æœªæœ‰çš„èƒ½åŠ›ã€‚</p>
            
            <div style="background-color: #fef9e7; padding: 15px; border-radius: 8px;">
                <h5>æ”»å‡»ä¸‰è¦ç´ ï¼š</h5>
                <ol>
                    <li><strong>èµ„æœ¬æ”¾å¤§</strong>ï¼šä»0åˆ°æ•°äº¿ç¾å…ƒçš„ç¬æ—¶èµ„æœ¬</li>
                    <li><strong>åŸå­æ€§ä¿è¯</strong>ï¼šè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š</li>
                    <li><strong>åè®®å¼±ç‚¹</strong>ï¼šä¾èµ–å³æ—¶çŠ¶æ€çš„ä»·æ ¼æˆ–é€»è¾‘</li>
                </ol>
            </div>
        </div>
        
        <div class="info-box">
            <h4>ğŸ“Š 2023-2024å¹´é—ªç”µè´·æ”»å‡»ç»Ÿè®¡</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">æ”»å‡»ç‰¹å¾</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">æ•°é‡/é‡‘é¢</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">å æ¯”</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">è¶‹åŠ¿</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ€»æ”»å‡»æ¬¡æ•°</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">147æ¬¡</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">35%çš„DeFiæ”»å‡»</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“ˆ ä¸Šå‡</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ€»æŸå¤±é‡‘é¢</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$482M</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">27%çš„æ€»æŸå¤±</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“ˆ å¢é•¿</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>å¹³å‡å€Ÿæ¬¾é¢</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$156M</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">-</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“ˆ å¢å¤§</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æœ€å¸¸è§ç›®æ ‡</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ä»·æ ¼é¢„è¨€æœº</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">68%</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">â†’ ç¨³å®š</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>ç¨³å®šå¸ç›¸å…³</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">31æ¬¡</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">21%</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ“ˆ å¢åŠ </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="tip-box">
            <p><strong>ğŸ›¡ï¸ é˜²å¾¡å…³é”®ï¼š</strong>æ°¸è¿œä¸è¦ä¾èµ–åŒä¸€åŒºå—å†…çš„å³æ—¶çŠ¶æ€ã€‚ä½¿ç”¨æ—¶é—´åŠ æƒå¹³å‡ä»·æ ¼ï¼ˆTWAPï¼‰ã€å»¶è¿Ÿæ›´æ–°æˆ–å…¶ä»–æŠ—æ“çºµæœºåˆ¶ã€‚</p>
        </div>
        
        <div class="code-block collapsible">
            <div class="code-header" onclick="toggleCode(this)">
                <span class="toggle-icon">â–¼</span>
                <span>å®Œæ•´çš„é—ªç”µè´·æ”»å‡»ç¤ºä¾‹</span>
            </div>
            <pre class="collapsed"><code class="language-solidity">// æ˜“å—æ”»å‡»çš„ç¨³å®šå¸åè®®
contract VulnerableStablecoin {
    IUniswapV2Pair public collateralPair; // ETH/USDC
    mapping(address => uint256) public collateral;
    mapping(address => uint256) public debt;
    
    // æ¼æ´ï¼šä½¿ç”¨å³æ—¶ä»·æ ¼ï¼Œæ²¡æœ‰TWAPä¿æŠ¤
    function getCollateralValue(address user) public view returns (uint256) {
        (uint112 reserve0, uint112 reserve1,) = collateralPair.getReserves();
        uint256 price = uint256(reserve1) * 1e18 / uint256(reserve0);
        return collateral[user] * price / 1e18;
    }
    
    function liquidate(address user) external {
        require(getCollateralValue(user) < debt[user] * 11 / 10, "Not undercollateralized");
        // æ¸…ç®—é€»è¾‘...
    }
}

// æ”»å‡»åˆçº¦
contract FlashLoanAttack {
    IFlashLoanProvider flashLoan;
    VulnerableStablecoin target;
    IUniswapV2Router router;
    
    function executeAttack() external {
        // 1. å€Ÿå…¥å¤§é‡USDC
        flashLoan.flashLoan(address(this), USDC, 10_000_000e6);
    }
    
    function onFlashLoan(uint256 amount) external {
        // 2. åœ¨Uniswapä¸Šç ¸ç›˜ï¼Œæ“çºµä»·æ ¼
        IERC20(USDC).approve(address(router), amount);
        address[] memory path = new address[](2);
        path[0] = USDC;
        path[1] = WETH;
        
        // å¤§é‡å–å‡ºUSDCï¼Œå‹ä½ETH/USDCä»·æ ¼
        router.swapExactTokensForTokens(
            amount,
            0,
            path,
            address(this),
            block.timestamp
        );
        
        // 3. è§¦å‘æ¸…ç®—
        address victim = 0x...; // ç›®æ ‡ç”¨æˆ·
        target.liquidate(victim);
        
        // 4. æ¢å¤ä»·æ ¼
        uint256 wethBalance = IERC20(WETH).balanceOf(address(this));
        IERC20(WETH).approve(address(router), wethBalance);
        path[0] = WETH;
        path[1] = USDC;
        
        router.swapExactTokensForTokens(
            wethBalance,
            amount, // ç¡®ä¿èƒ½è¿˜æ¬¾
            path,
            address(this),
            block.timestamp
        );
        
        // 5. å½’è¿˜é—ªç”µè´·
        IERC20(USDC).transfer(address(flashLoan), amount + fee);
        
        // 6. æå–åˆ©æ¶¦
        // ...
    }
}

// é˜²æŠ¤æªæ–½ï¼šä½¿ç”¨TWAP
contract SecureStablecoin {
    using UniswapV2OracleLibrary for IUniswapV2Pair;
    
    uint32 public constant TWAP_PERIOD = 1800; // 30åˆ†é’Ÿ
    
    struct Observation {
        uint32 timestamp;
        uint224 priceCumulative;
    }
    
    mapping(address => Observation) public observations;
    
    function updatePrice(address pair) external {
        uint32 currentTime = uint32(block.timestamp);
        uint224 priceCumulative = uint224(IUniswapV2Pair(pair).price0CumulativeLast());
        
        Observation storage obs = observations[pair];
        uint32 timeElapsed = currentTime - obs.timestamp;
        
        if (timeElapsed >= TWAP_PERIOD) {
            obs.timestamp = currentTime;
            obs.priceCumulative = priceCumulative;
        }
    }
    
    function getTWAPPrice(address pair) public view returns (uint256) {
        Observation memory obs = observations[pair];
        uint32 timeElapsed = uint32(block.timestamp) - obs.timestamp;
        
        require(timeElapsed >= TWAP_PERIOD, "TWAP period not elapsed");
        
        uint224 currentCumulative = uint224(IUniswapV2Pair(pair).price0CumulativeLast());
        
        return (currentCumulative - obs.priceCumulative) / timeElapsed;
    }
}</code></pre>
        </div>

        <h4>9.2.3 æ²»ç†æ”»å‡»ä¸ç»æµæ“çºµ</h4>
        <p>ç¨³å®šå¸çš„æ²»ç†æœºåˆ¶å¯èƒ½è¢«æ¶æ„ææ¡ˆæˆ–ç»æµæ¿€åŠ±æ“çºµã€‚</p>
        
        <div class="code-block collapsible">
            <div class="code-header" onclick="toggleCode(this)">
                <span class="toggle-icon">â–¼</span>
                <span>æ²»ç†æ”»å‡»é˜²æŠ¤</span>
            </div>
            <pre class="collapsed"><code class="language-solidity">// å®‰å…¨çš„æ²»ç†å®ç°
contract SecureGovernance {
    uint256 public constant PROPOSAL_THRESHOLD = 100000e18; // 10ä¸‡ä»£å¸
    uint256 public constant VOTING_PERIOD = 3 days;
    uint256 public constant EXECUTION_DELAY = 2 days;
    uint256 public constant QUORUM = 4; // 4%çš„æ€»ä¾›åº”é‡
    
    struct Proposal {
        address proposer;
        address[] targets;
        uint256[] values;
        bytes[] calldatas;
        uint256 startBlock;
        uint256 endBlock;
        uint256 forVotes;
        uint256 againstVotes;
        bool canceled;
        bool executed;
        mapping(address => bool) hasVoted;
    }
    
    mapping(uint256 => Proposal) public proposals;
    
    // é˜²æ­¢é—ªç”µè´·æ²»ç†æ”»å‡»
    modifier noFlashLoan() {
        uint256 balanceBefore = governanceToken.balanceOf(msg.sender);
        _;
        require(
            governanceToken.balanceOf(msg.sender) >= balanceBefore,
            "Flash loan governance attack detected"
        );
    }
    
    // æŠ•ç¥¨æƒå¿«ç…§æœºåˆ¶
    function propose(
        address[] memory targets,
        uint256[] memory values,
        bytes[] memory calldatas,
        string memory description
    ) public returns (uint256) {
        require(
            governanceToken.getPastVotes(msg.sender, block.number - 1) >= PROPOSAL_THRESHOLD,
            "Below proposal threshold"
        );
        
        // åˆ›å»ºææ¡ˆ...
    }
    
    // æ—¶é—´é”æ‰§è¡Œ
    function execute(uint256 proposalId) public {
        Proposal storage proposal = proposals[proposalId];
        require(proposal.forVotes > proposal.againstVotes, "Proposal defeated");
        require(
            proposal.forVotes >= (governanceToken.totalSupply() * QUORUM) / 100,
            "Quorum not reached"
        );
        require(
            block.timestamp >= proposal.endBlock + EXECUTION_DELAY,
            "Execution delay not met"
        );
        
        // æ‰§è¡Œææ¡ˆ...
    }
}</code></pre>
        </div>

        <h4>9.2.4 è·¨é“¾æ¡¥é£é™©</h4>
        <p>è·¨é“¾ç¨³å®šå¸é¢ä¸´é¢å¤–çš„å®‰å…¨æŒ‘æˆ˜ï¼ŒåŒ…æ‹¬æ¡¥åˆçº¦æ¼æ´å’Œè·¨é“¾æ¶ˆæ¯éªŒè¯ã€‚</p>
        
        <div class="code-block collapsible">
            <div class="code-header" onclick="toggleCode(this)">
                <span class="toggle-icon">â–¼</span>
                <span>è·¨é“¾å®‰å…¨å®ç°</span>
            </div>
            <pre class="collapsed"><code class="language-solidity">// LayerZeroé›†æˆçš„å®‰å…¨å®ç°
contract CrossChainStablecoin is OFT {
    mapping(uint16 => uint256) public chainSupply;
    uint256 public maxSupplyPerChain = 100_000_000e18;
    
    // é˜²æ­¢è·¨é“¾é“¸é€ æ”»å‡»
    function _creditTo(
        uint16 _srcChainId,
        address _toAddress,
        uint256 _amount
    ) internal override returns (uint256) {
        // æ£€æŸ¥é“¾ä¾›åº”é‡é™åˆ¶
        require(
            chainSupply[_srcChainId] + _amount <= maxSupplyPerChain,
            "Chain supply limit exceeded"
        );
        
        chainSupply[_srcChainId] += _amount;
        
        return super._creditTo(_srcChainId, _toAddress, _amount);
    }
    
    // éªŒè¯è·¨é“¾æ¶ˆæ¯
    function _blockingLzReceive(
        uint16 _srcChainId,
        bytes memory _srcAddress,
        uint64 _nonce,
        bytes memory _payload
    ) internal override {
        // éªŒè¯æºé“¾åœ°å€
        require(
            _srcAddress.length == trustedRemoteLookup[_srcChainId].length &&
            keccak256(_srcAddress) == keccak256(trustedRemoteLookup[_srcChainId]),
            "Invalid source"
        );
        
        // é˜²é‡æ”¾æ”»å‡»
        require(!processedNonces[_srcChainId][_nonce], "Nonce already processed");
        processedNonces[_srcChainId][_nonce] = true;
        
        super._blockingLzReceive(_srcChainId, _srcAddress, _nonce, _payload);
    }
}</code></pre>
        </div>

        <h3 id="secure-development">9.3 å®‰å…¨å¼€å‘ç”Ÿå‘½å‘¨æœŸ</h3>
        
        <div class="intro-box" style="background-color: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h4>ğŸ” å®‰å…¨ä¸æ˜¯äº‹åè¡¥æ•‘ï¼Œè€Œæ˜¯è®¾è®¡ä¹‹åˆ</h4>
            <p>å®‰å…¨å¼€å‘ç”Ÿå‘½å‘¨æœŸï¼ˆSDLCï¼‰æ˜¯æ„å»ºå®‰å…¨ç¨³å®šå¸ç³»ç»Ÿçš„åŸºçŸ³ã€‚å®ƒä¸æ˜¯åœ¨ä»£ç å†™å®Œå"æ‰“è¡¥ä¸"ï¼Œè€Œæ˜¯ä»æ¶æ„è®¾è®¡çš„ç¬¬ä¸€å¤©å°±èå…¥æ¯ä¸€ä¸ªå†³ç­–ä¸­ã€‚</p>
            
            <div style="background-color: #e0f2fe; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h5>ğŸ¯ SDLCçš„äº”ä¸ªå…³é”®é˜¶æ®µï¼š</h5>
                <ol>
                    <li><strong>éœ€æ±‚åˆ†æ</strong>ï¼šè¯†åˆ«å®‰å…¨éœ€æ±‚å’Œå¨èƒæ¨¡å‹</li>
                    <li><strong>è®¾è®¡</strong>ï¼šåº”ç”¨å®‰å…¨è®¾è®¡åŸåˆ™å’Œæ¨¡å¼</li>
                    <li><strong>å®ç°</strong>ï¼šéµå¾ªå®‰å…¨ç¼–ç è§„èŒƒ</li>
                    <li><strong>æµ‹è¯•</strong>ï¼šå…¨é¢çš„å®‰å…¨æµ‹è¯•å’Œå®¡è®¡</li>
                    <li><strong>ç»´æŠ¤</strong>ï¼šæŒç»­ç›‘æ§å’Œåº”æ€¥å“åº”</li>
                </ol>
            </div>
        </div>
        
        <div class="info-box">
            <h4>ğŸ“Š å®‰å…¨å¼€å‘æˆæœ¬æ•ˆç›Šåˆ†æ</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">é˜¶æ®µ</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">å‘ç°æ¼æ´æˆæœ¬</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">ä¿®å¤æˆæœ¬</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">ç›¸å¯¹å€æ•°</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>è®¾è®¡é˜¶æ®µ</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$1,000</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$1,000</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">1x</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>å¼€å‘é˜¶æ®µ</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$5,000</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$10,000</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">10x</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æµ‹è¯•é˜¶æ®µ</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$15,000</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$50,000</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">50x</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>å®¡è®¡é˜¶æ®µ</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$50,000</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$100,000</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">100x</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>ç”Ÿäº§ç¯å¢ƒ</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$0ï¼ˆè¢«é»‘å®¢å‘ç°ï¼‰</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$1M-$100M+</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">1000x+</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="warning-box">
            <h4>âš ï¸ å¸¸è§çš„å®‰å…¨å¼€å‘è¯¯åŒº</h4>
            <ul>
                <li><strong>"æˆ‘ä»¬ä»¥åå†åŠ å®‰å…¨åŠŸèƒ½"</strong> - å®‰å…¨å¿…é¡»ä»ä¸€å¼€å§‹å°±å†…ç½®</li>
                <li><strong>"å®¡è®¡ä¼šå‘ç°æ‰€æœ‰é—®é¢˜"</strong> - å®¡è®¡åªæ˜¯æœ€åä¸€é“é˜²çº¿</li>
                <li><strong>"ä½¿ç”¨çŸ¥ååº“å°±å®‰å…¨äº†"</strong> - é”™è¯¯çš„é›†æˆåŒæ ·å±é™©</li>
                <li><strong>"æµ‹è¯•ç½‘æ²¡é—®é¢˜å°±è¡Œ"</strong> - ä¸»ç½‘ç¯å¢ƒå®Œå…¨ä¸åŒ</li>
                <li><strong>"ä»£ç å¼€æºä¼šæš´éœ²æ¼æ´"</strong> - é€æ˜æ€§å®é™…ä¸Šæé«˜å®‰å…¨æ€§</li>
            </ul>
        </div>
        
        <div class="theory-section">
            <h4>9.3.1 å®‰å…¨è®¾è®¡åŸåˆ™</h4>
            
            <h5>1. æœ€å°æƒé™åŸåˆ™ï¼ˆPrinciple of Least Privilegeï¼‰</h5>
            <div class="code-block">
                <div class="code-header">
                    Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-solidity">// æ­£ç¡®çš„æƒé™è®¾è®¡
contract SecureStablecoin {
    bytes32 public constant MINTER_ROLE = keccak256("MINTER_ROLE");
    bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
    bytes32 public constant ORACLE_ROLE = keccak256("ORACLE_ROLE");
    
    // ç»†ç²’åº¦çš„è§’è‰²åˆ†ç¦»
    modifier onlyRole(bytes32 role) {
        require(hasRole(role, msg.sender), "Unauthorized");
        _;
    }
    
    function mint(address to, uint256 amount) 
        external 
        onlyRole(MINTER_ROLE) 
        whenNotPaused 
    {
        _mint(to, amount);
    }
    
    // æ—¶é—´é”ä¿æŠ¤çš„å…³é”®æ“ä½œ
    uint256 public constant TIMELOCK_DURATION = 48 hours;
    mapping(bytes32 => uint256) public timelockProposals;
    
    function proposeNewMinter(address newMinter) external onlyRole(DEFAULT_ADMIN_ROLE) {
        bytes32 proposalId = keccak256(abi.encodePacked("ADD_MINTER", newMinter));
        timelockProposals[proposalId] = block.timestamp + TIMELOCK_DURATION;
    }
}</code></pre>
                </div>
            </div>
            
            <h5>2. é˜²å¾¡æ€§ç¼–ç¨‹ï¼ˆDefensive Programmingï¼‰</h5>
            <div class="code-block">
                <div class="code-header">
                    Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-solidity">contract DefensiveStablecoin {
    using SafeMath for uint256;
    
    // çŠ¶æ€å˜é‡çš„æ˜¾å¼åˆå§‹åŒ–
    bool private initialized = false;
    uint256 public constant MAX_SUPPLY = 1e12 * 1e18; // 1ä¸‡äº¿ä¸Šé™
    
    // é˜²é‡å…¥ä¿æŠ¤
    uint256 private constant NOT_ENTERED = 1;
    uint256 private constant ENTERED = 2;
    uint256 private reentrancyStatus = NOT_ENTERED;
    
    modifier nonReentrant() {
        require(reentrancyStatus != ENTERED, "ReentrancyGuard: reentrant call");
        reentrancyStatus = ENTERED;
        _;
        reentrancyStatus = NOT_ENTERED;
    }
    
    // è¾“å…¥éªŒè¯
    function transfer(address to, uint256 amount) public returns (bool) {
        require(to != address(0), "Transfer to zero address");
        require(to != address(this), "Transfer to contract itself");
        require(amount > 0, "Transfer amount must be positive");
        require(amount <= balanceOf(msg.sender), "Insufficient balance");
        
        _transfer(msg.sender, to, amount);
        return true;
    }
    
    // æ£€æŸ¥-å½±å“-äº¤äº’æ¨¡å¼ï¼ˆCEIï¼‰
    function withdraw(uint256 amount) external nonReentrant {
        // æ£€æŸ¥
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // å½±å“ï¼ˆå…ˆæ›´æ–°çŠ¶æ€ï¼‰
        balances[msg.sender] = balances[msg.sender].sub(amount);
        totalSupply = totalSupply.sub(amount);
        
        // äº¤äº’ï¼ˆæœ€åè¿›è¡Œå¤–éƒ¨è°ƒç”¨ï¼‰
        (bool success,) = msg.sender.call{value: amount}("");
        require(success, "Transfer failed");
    }
}</code></pre>
                </div>
            </div>
        </div>

        <h4>9.3.2 å½¢å¼åŒ–éªŒè¯</h4>
        
        <div class="theory-section">
            <p>å½¢å¼åŒ–éªŒè¯ä½¿ç”¨æ•°å­¦æ–¹æ³•è¯æ˜ä»£ç çš„æ­£ç¡®æ€§ï¼š</p>
            
            <div class="code-block">
                <div class="code-header">
                    Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-solidity">// ä½¿ç”¨ SMTChecker å’Œæ–­è¨€è¿›è¡Œå½¢å¼åŒ–éªŒè¯
contract FormallyVerifiedStablecoin {
    mapping(address => uint256) public balances;
    uint256 public totalSupply;
    
    // ä¸å˜é‡ï¼šæ‰€æœ‰ä½™é¢ä¹‹å’Œç­‰äºæ€»ä¾›åº”é‡
    function invariant_totalSupply() private view {
        uint256 sum = 0;
        // æ³¨æ„ï¼šå®é™…ä¸­éœ€è¦éå†æ‰€æœ‰åœ°å€
        // è¿™é‡Œç”¨æ–­è¨€è¡¨ç¤ºæ¦‚å¿µ
        assert(sum == totalSupply);
    }
    
    function transfer(address to, uint256 amount) public {
        require(to != address(0));
        
        uint256 oldFromBalance = balances[msg.sender];
        uint256 oldToBalance = balances[to];
        
        require(oldFromBalance >= amount);
        
        balances[msg.sender] = oldFromBalance - amount;
        balances[to] = oldToBalance + amount;
        
        // åç½®æ¡ä»¶éªŒè¯
        assert(balances[msg.sender] == oldFromBalance - amount);
        assert(balances[to] == oldToBalance + amount);
        
        // ä¿æŒä¸å˜é‡
        invariant_totalSupply();
    }
}

// è§„èŒƒè¯­è¨€ç¤ºä¾‹ï¼ˆç”¨æ³¨é‡Šè¡¨ç¤ºï¼‰
contract Specification {
    /// @custom:formal-verification
    /// @pre balances[msg.sender] >= amount
    /// @post balances[msg.sender] == old(balances[msg.sender]) - amount
    /// @post balances[to] == old(balances[to]) + amount
    /// @post totalSupply == old(totalSupply)
    function transfer(address to, uint256 amount) external;
}</code></pre>
                </div>
            </div>
        </div>

        <h3 id="advanced-patterns">9.4 é«˜çº§å®‰å…¨æ¨¡å¼</h3>
        
        <div class="intro-box" style="background-color: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h4>ğŸ›¡ï¸ æ„å»ºå¤šå±‚é˜²å¾¡ä½“ç³»</h4>
            <p>é«˜çº§å®‰å…¨æ¨¡å¼æ˜¯ç¨³å®šå¸ç³»ç»Ÿçš„"ä¿é™©ä¸"å’Œ"é˜²ç«å¢™"ã€‚å®ƒä»¬ä¸æ˜¯ä¸ºäº†é˜»æ­¢æ­£å¸¸è¿ä½œï¼Œè€Œæ˜¯åœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¿æŠ¤ç³»ç»Ÿå’Œç”¨æˆ·èµ„äº§ã€‚å°±åƒç°ä»£å»ºç­‘çš„é˜²éœ‡è®¾è®¡ï¼Œè¿™äº›æ¨¡å¼è®©ç³»ç»Ÿåœ¨æç«¯æƒ…å†µä¸‹ä¹Ÿèƒ½ä¼˜é›…é™çº§è€Œéå½»åº•å´©æºƒã€‚</p>
            
            <div style="background-color: #e0f2fe; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h5>ğŸ¯ ä¸‰å±‚é˜²å¾¡æ¶æ„ï¼š</h5>
                <ol>
                    <li><strong>é¢„é˜²å±‚</strong>ï¼šè®¿é—®æ§åˆ¶ã€è¾“å…¥éªŒè¯ã€çŠ¶æ€æ£€æŸ¥</li>
                    <li><strong>æ£€æµ‹å±‚</strong>ï¼šå¼‚å¸¸ç›‘æ§ã€æ–­è·¯å™¨ã€é™æµå™¨</li>
                    <li><strong>å“åº”å±‚</strong>ï¼šç´§æ€¥æš‚åœã€èµ„é‡‘å†»ç»“ã€æ²»ç†ä»‹å…¥</li>
                </ol>
            </div>
        </div>
        
        <div class="info-box">
            <h4>ğŸ“Š é«˜çº§å®‰å…¨æ¨¡å¼å¯¹æ¯”</h4>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">å®‰å…¨æ¨¡å¼</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">ä¸»è¦åŠŸèƒ½</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">é€‚ç”¨åœºæ™¯</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">å®ç°å¤æ‚åº¦</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ–­è·¯å™¨ï¼ˆCircuit Breakerï¼‰</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">è‡ªåŠ¨æš‚åœå¼‚å¸¸æ“ä½œ</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ä»·æ ¼å¼‚å¸¸ã€å¤§é¢è½¬è´¦</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­ç­‰</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>æ—¶é—´é”ï¼ˆTimelockï¼‰</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å»¶è¿Ÿæ‰§è¡Œå…³é”®æ“ä½œ</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å‚æ•°æ›´æ”¹ã€å‡çº§</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¢ ç®€å•</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>å¤šç­¾ï¼ˆMulti-sigï¼‰</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å¤šæ–¹å…±åŒå†³ç­–</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">é‡‘åº“ç®¡ç†ã€ç´§æ€¥å“åº”</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¡ ä¸­ç­‰</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>é™æµå™¨ï¼ˆRate Limiterï¼‰</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">é™åˆ¶æ“ä½œé¢‘ç‡</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">é˜²æ­¢DoSã€é™åˆ¶æå–</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸŸ¢ ç®€å•</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>ä»£ç†å‡çº§</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">åˆçº¦é€»è¾‘æ›´æ–°</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ä¿®å¤æ¼æ´ã€åŠŸèƒ½å‡çº§</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ğŸ”´ å¤æ‚</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="example-box" style="background-color: #fef3c7; margin: 20px 0;">
            <h4>ğŸ’¡ å®æˆ˜æ¡ˆä¾‹ï¼šMakerDAOçš„ç´§æ€¥å…³åœç³»ç»Ÿ</h4>
            <p>MakerDAOçš„ç´§æ€¥å…³åœï¼ˆEmergency Shutdownï¼‰æ˜¯æ–­è·¯å™¨æ¨¡å¼çš„å…¸èŒƒï¼š</p>
            <ul>
                <li><strong>è§¦å‘æ¡ä»¶</strong>ï¼šæ²»ç†æŠ•ç¥¨ã€é¢„è¨€æœºå¤±æ•ˆã€ç³»ç»Ÿæ€§æ”»å‡»</li>
                <li><strong>æ‰§è¡Œè¿‡ç¨‹</strong>ï¼š
                    <ol>
                        <li>å†»ç»“æ‰€æœ‰CDPæ“ä½œ</li>
                        <li>å›ºå®šæ‰€æœ‰èµ„äº§ä»·æ ¼</li>
                        <li>å…è®¸ç”¨æˆ·æŒ‰æœ€ç»ˆä»·æ ¼èµå›</li>
                    </ol>
                </li>
                <li><strong>ä¿æŠ¤æ•ˆæœ</strong>ï¼šå³ä½¿åœ¨æœ€åæƒ…å†µä¸‹ä¹Ÿèƒ½ä¿æŠ¤ç”¨æˆ·èµ„äº§</li>
                <li><strong>å®é™…ä½¿ç”¨</strong>ï¼šä»æœªè§¦å‘ï¼Œä½†å…¶å­˜åœ¨æœ¬èº«å°±æ˜¯å¨æ…‘</li>
            </ul>
        </div>
        
        <div class="practice-section">
            <h4>9.4.1 æ–­è·¯å™¨æ¨¡å¼ï¼ˆCircuit Breakerï¼‰</h4>
            
            <div class="code-block">
                <div class="code-header">
                    Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-solidity">contract CircuitBreakerStablecoin {
    // å¤šçº§æ–­è·¯å™¨çŠ¶æ€
    enum CircuitState { NORMAL, RESTRICTED, PAUSED, EMERGENCY }
    CircuitState public circuitState = CircuitState.NORMAL;
    
    // è‡ªåŠ¨è§¦å‘æ¡ä»¶
    uint256 public constant PRICE_DEVIATION_THRESHOLD = 500; // 5%
    uint256 public constant VOLUME_SPIKE_THRESHOLD = 10; // 10x normal
    uint256 public constant RAPID_MINT_THRESHOLD = 1e9 * 1e18; // 10äº¿
    
    // ç›‘æ§æŒ‡æ ‡
    uint256 public dailyMintVolume;
    uint256 public lastResetTimestamp;
    uint256 public priceDeviationCount;
    
    modifier circuitBreakerCheck() {
        _updateCircuitState();
        
        if (circuitState == CircuitState.PAUSED) {
            revert("System paused");
        } else if (circuitState == CircuitState.EMERGENCY) {
            revert("Emergency shutdown");
        } else if (circuitState == CircuitState.RESTRICTED) {
            // é™åˆ¶æ¨¡å¼ä¸‹çš„ç‰¹æ®Šé€»è¾‘
            require(msg.value <= 1000 * 1e18, "Transaction limit exceeded");
        }
        _;
    }
    
    function _updateCircuitState() private {
        // é‡ç½®æ¯æ—¥è®¡æ•°å™¨
        if (block.timestamp > lastResetTimestamp + 1 days) {
            dailyMintVolume = 0;
            lastResetTimestamp = block.timestamp;
            priceDeviationCount = 0;
        }
        
        // æ£€æŸ¥ä»·æ ¼åç¦»
        uint256 currentPrice = getOraclePrice();
        uint256 targetPrice = 1e18; // $1
        uint256 deviation = currentPrice > targetPrice ? 
            currentPrice - targetPrice : targetPrice - currentPrice;
            
        if (deviation * 10000 / targetPrice > PRICE_DEVIATION_THRESHOLD) {
            priceDeviationCount++;
            
            if (priceDeviationCount > 3) {
                circuitState = CircuitState.RESTRICTED;
            }
            if (priceDeviationCount > 5) {
                circuitState = CircuitState.PAUSED;
            }
        }
        
        // æ£€æŸ¥é“¸é€ é‡
        if (dailyMintVolume > RAPID_MINT_THRESHOLD) {
            circuitState = CircuitState.EMERGENCY;
            emit EmergencyShutdown(block.timestamp, dailyMintVolume);
        }
    }
    
    // æ¢å¤æœºåˆ¶
    function proposeRecovery() external onlyRole(GUARDIAN_ROLE) {
        require(circuitState != CircuitState.NORMAL, "System already normal");
        
        // åˆ›å»ºæ¢å¤ææ¡ˆï¼Œéœ€è¦å¤šç­¾æˆ–DAOæŠ•ç¥¨
        bytes32 proposalId = keccak256(abi.encodePacked("RECOVERY", block.timestamp));
        _createProposal(proposalId, ProposalType.RECOVERY);
    }
}</code></pre>
                </div>
            </div>
        </div>

        <h4>9.3.2 å‡çº§æ¨¡å¼ä¸ä»£ç†åˆçº¦å®‰å…¨</h4>
        
        <div class="warning-box">
            <p><strong>è­¦å‘Š</strong>ï¼šè®¸å¤šç¨³å®šå¸ä¾èµ–å¯å‡çº§ä»£ç†åˆçº¦ç»“æ„ã€‚ä¸å½“çš„å‡çº§æœºåˆ¶å¯èƒ½å¯¼è‡´æƒé™æ»¥ç”¨ã€åˆå§‹åŒ–æ¼æ´æˆ–å­˜å‚¨å†²çªã€‚</p>
        </div>
        
        <div class="theory-section">
            <p>å®‰å…¨çš„å‡çº§æœºåˆ¶å¯¹äºä¿®å¤æ¼æ´è‡³å…³é‡è¦ï¼Œä½†ä¹Ÿå¼•å…¥äº†æ–°çš„æ”»å‡»é¢ï¼š</p>
            
            <div class="code-block">
                <div class="code-header">
                    Solidity ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-solidity">// é€æ˜ä»£ç†æ¨¡å¼ï¼ˆOpenZeppelinæ ‡å‡†ï¼‰
contract TransparentUpgradeableProxy {
    // EIP-1967 æ ‡å‡†å­˜å‚¨æ§½
    bytes32 private constant _IMPLEMENTATION_SLOT = 
        0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc;
    bytes32 private constant _ADMIN_SLOT = 
        0xb53127684a568b3173ae13b9f8a6016e243e63b6e8ee1178d6a717850b5d6103;
    
    modifier ifAdmin() {
        if (msg.sender == _getAdmin()) {
            _;
        } else {
            _fallback();
        }
    }
    
    function upgradeTo(address newImplementation) external ifAdmin {
        _authorizeUpgrade(newImplementation);
        _upgradeToAndCall(newImplementation, bytes(""), false);
    }
    
    function _authorizeUpgrade(address newImplementation) internal {
        // å®‰å…¨æ£€æŸ¥
        require(newImplementation != address(0), "Invalid implementation");
        require(newImplementation.code.length > 0, "Implementation not contract");
        
        // å¯é€‰ï¼šæ£€æŸ¥æ–°å®ç°çš„åˆå§‹åŒ–çŠ¶æ€
        (bool success, bytes memory data) = newImplementation.staticcall(
            abi.encodeWithSignature("proxiableUUID()")
        );
        require(success && data.length == 32, "Not UUPS compliant");
    }
}

// UUPSæ¨¡å¼ï¼ˆæ›´gasé«˜æ•ˆä½†é£é™©æ›´é«˜ï¼‰
contract UUPSUpgradeable {
    function _authorizeUpgrade(address newImplementation) internal virtual;
    
    function upgradeTo(address newImplementation) external {
        _authorizeUpgrade(newImplementation);
        
        // å…³é”®å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢å‡çº§åˆ°æ¶æ„åˆçº¦
        require(
            bytes32(newImplementation.codehash) != bytes32(0),
            "New implementation must be contract"
        );
        
        // æ£€æŸ¥å­˜å‚¨å¸ƒå±€å…¼å®¹æ€§
        _checkStorageLayout(newImplementation);
        
        // æ‰§è¡Œå‡çº§
        assembly {
            sstore(_IMPLEMENTATION_SLOT, newImplementation)
        }
    }
    
    function _checkStorageLayout(address newImplementation) private view {
        // ä½¿ç”¨storage gapç¡®ä¿å‡çº§å®‰å…¨
        uint256[50] private __gap;
        
        // éªŒè¯å…³é”®å­˜å‚¨å˜é‡çš„ä½ç½®
        // è¿™éœ€è¦é“¾ä¸‹å·¥å…·æ”¯æŒ
    }
}</code></pre>
                </div>
            </div>
            
            <h4>9.4.3 å‡çº§æœºåˆ¶å®‰å…¨ï¼ˆ2024æœ€ä½³å®è·µï¼‰</h4>
            <p>å¯å‡çº§åˆçº¦åœ¨æä¾›çµæ´»æ€§çš„åŒæ—¶ä¹Ÿå¼•å…¥äº†æ–°çš„å®‰å…¨é£é™©ã€‚UUPSç›¸æ¯”é€æ˜ä»£ç†åœ¨gasæ•ˆç‡ä¸Šæœ‰ä¼˜åŠ¿ï¼Œä½†éœ€è¦æ›´è°¨æ…çš„å®ç°ã€‚</p>
            
            <div class="code-block collapsible">
                <div class="code-header" onclick="toggleCode(this)">
                    <span class="toggle-icon">â–¼</span>
                    <span>UUPSå‡çº§æ¨¡å¼å®‰å…¨å®ç°</span>
                </div>
                <pre class="collapsed"><code class="language-solidity">// ä½¿ç”¨OpenZeppelinçš„UUPSæ¨¡å¼
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol";

contract StablecoinV1 is UUPSUpgradeable, AccessControlUpgradeable {
    bytes32 public constant UPGRADER_ROLE = keccak256("UPGRADER_ROLE");
    bytes32 public constant MINTER_ROLE = keccak256("MINTER_ROLE");
    
    // å­˜å‚¨å˜é‡é¡ºåºå¾ˆé‡è¦ï¼
    mapping(address => uint256) private _balances;
    uint256 private _totalSupply;
    
    // é˜²æ­¢å®ç°åˆçº¦è¢«åˆå§‹åŒ–
    /// @custom:oz-upgrades-unsafe-allow constructor
    constructor() {
        _disableInitializers();
    }
    
    function initialize(address admin) public initializer {
        __UUPSUpgradeable_init();
        __AccessControl_init();
        
        _grantRole(DEFAULT_ADMIN_ROLE, admin);
        _grantRole(UPGRADER_ROLE, admin);
        
        // å…³é”®ï¼šåˆ†ç¦»å‡çº§æƒé™å’Œæ“ä½œæƒé™
        _setRoleAdmin(MINTER_ROLE, DEFAULT_ADMIN_ROLE);
        _setRoleAdmin(UPGRADER_ROLE, UPGRADER_ROLE); // åªæœ‰UPGRADERæ‰èƒ½ç®¡ç†UPGRADER
    }
    
    // é™åˆ¶å‡çº§æƒé™
    function _authorizeUpgrade(address newImplementation) 
        internal 
        override 
        onlyRole(UPGRADER_ROLE) 
    {
        // å¯é€‰ï¼šæ·»åŠ é¢å¤–çš„å‡çº§æ¡ä»¶æ£€æŸ¥
        require(!paused(), "Cannot upgrade while paused");
        
        // å¯é€‰ï¼šéªŒè¯æ–°å®ç°çš„åˆçº¦ä»£ç 
        require(
            IUpgradeableBeacon(newImplementation).implementation() != address(0),
            "Invalid implementation"
        );
    }
}

// æ—¶é—´é”æ²»ç†åˆçº¦
contract StablecoinGovernance {
    uint256 constant TIMELOCK_DURATION = 2 days;
    
    struct UpgradeProposal {
        address newImplementation;
        uint256 proposedAt;
        bool executed;
    }
    
    mapping(uint256 => UpgradeProposal) public proposals;
    uint256 public proposalCount;
    
    function proposeUpgrade(address newImplementation) external onlyRole(PROPOSER_ROLE) {
        proposals[proposalCount++] = UpgradeProposal({
            newImplementation: newImplementation,
            proposedAt: block.timestamp,
            executed: false
        });
        
        emit UpgradeProposed(proposalCount - 1, newImplementation);
    }
    
    function executeUpgrade(uint256 proposalId) external onlyRole(EXECUTOR_ROLE) {
        UpgradeProposal storage proposal = proposals[proposalId];
        require(!proposal.executed, "Already executed");
        require(
            block.timestamp >= proposal.proposedAt + TIMELOCK_DURATION,
            "Timelock not passed"
        );
        
        proposal.executed = true;
        
        // æ‰§è¡Œå‡çº§
        UUPSUpgradeable(stablecoin).upgradeTo(proposal.newImplementation);
    }
}</code></pre>
            </div>

            <h4>9.4.4 å¤šç­¾ä¸æ—¶é—´é”å®ç°</h4>
            <p>ç”Ÿäº§ç¯å¢ƒå¿…é¡»ä½¿ç”¨å¤šç­¾é’±åŒ…å’Œæ—¶é—´é”æ¥ç®¡ç†å…³é”®æ“ä½œï¼Œé¿å…å•ç‚¹æ•…éšœã€‚</p>
            
            <div class="code-block collapsible">
                <div class="code-header" onclick="toggleCode(this)">
                    <span class="toggle-icon">â–¼</span>
                    <span>ç”Ÿäº§çº§å¤šç­¾æ—¶é—´é”å®ç°</span>
                </div>
                <pre class="collapsed"><code class="language-solidity">// é›†æˆGnosis Safeçš„å¤šç­¾æ²»ç†
contract StablecoinMultisigGovernance {
    IGnosisSafe public immutable multisig;
    IStablecoin public immutable stablecoin;
    
    // ä¸åŒæ“ä½œçš„æ—¶é—´é”
    uint256 constant PARAM_CHANGE_DELAY = 1 days;
    uint256 constant UPGRADE_DELAY = 3 days;
    uint256 constant EMERGENCY_DELAY = 6 hours;
    
    enum OperationType {
        PARAM_CHANGE,
        UPGRADE,
        EMERGENCY_PAUSE
    }
    
    struct Operation {
        OperationType opType;
        bytes data;
        uint256 scheduledTime;
        bool executed;
    }
    
    mapping(bytes32 => Operation) public operations;
    
    modifier onlyMultisig() {
        require(msg.sender == address(multisig), "Only multisig");
        _;
    }
    
    function scheduleOperation(
        OperationType opType,
        bytes calldata data
    ) external onlyMultisig returns (bytes32) {
        uint256 delay = getDelay(opType);
        bytes32 id = keccak256(abi.encode(opType, data, block.timestamp));
        
        operations[id] = Operation({
            opType: opType,
            data: data,
            scheduledTime: block.timestamp + delay,
            executed: false
        });
        
        emit OperationScheduled(id, opType, block.timestamp + delay);
        return id;
    }
    
    function executeOperation(bytes32 id) external {
        Operation storage op = operations[id];
        require(!op.executed, "Already executed");
        require(block.timestamp >= op.scheduledTime, "Too early");
        
        op.executed = true;
        
        if (op.opType == OperationType.PARAM_CHANGE) {
            (address target, bytes memory callData) = abi.decode(op.data, (address, bytes));
            (bool success,) = target.call(callData);
            require(success, "Param change failed");
        } else if (op.opType == OperationType.UPGRADE) {
            address newImpl = abi.decode(op.data, (address));
            UUPSUpgradeable(address(stablecoin)).upgradeTo(newImpl);
        } else if (op.opType == OperationType.EMERGENCY_PAUSE) {
            Pausable(address(stablecoin)).pause();
        }
        
        emit OperationExecuted(id);
    }
    
    // ç´§æ€¥å–æ¶ˆï¼ˆéœ€è¦æ›´é«˜çš„å¤šç­¾é˜ˆå€¼ï¼‰
    function cancelOperation(bytes32 id) external onlyMultisig {
        require(multisig.getThreshold() >= 4, "Need higher threshold for cancel");
        delete operations[id];
        emit OperationCancelled(id);
    }
}

// è§’è‰²åŸºç¡€çš„æƒé™ç®¡ç†
contract RoleBasedStablecoin {
    using EnumerableSet for EnumerableSet.AddressSet;
    
    // ç»†ç²’åº¦è§’è‰²å®šä¹‰
    bytes32 public constant MINTER_ROLE = keccak256("MINTER");
    bytes32 public constant BURNER_ROLE = keccak256("BURNER");
    bytes32 public constant PAUSER_ROLE = keccak256("PAUSER");
    bytes32 public constant ORACLE_UPDATER_ROLE = keccak256("ORACLE_UPDATER");
    bytes32 public constant FEE_MANAGER_ROLE = keccak256("FEE_MANAGER");
    bytes32 public constant RISK_MANAGER_ROLE = keccak256("RISK_MANAGER");
    
    // æ¯ä¸ªè§’è‰²çš„æˆå‘˜é™åˆ¶
    mapping(bytes32 => uint256) public roleMaxMembers;
    mapping(bytes32 => EnumerableSet.AddressSet) private roleMembers;
    
    constructor() {
        // è®¾ç½®è§’è‰²æˆå‘˜ä¸Šé™
        roleMaxMembers[MINTER_ROLE] = 3;
        roleMaxMembers[BURNER_ROLE] = 3;
        roleMaxMembers[PAUSER_ROLE] = 5;
        roleMaxMembers[ORACLE_UPDATER_ROLE] = 2;
        roleMaxMembers[FEE_MANAGER_ROLE] = 2;
        roleMaxMembers[RISK_MANAGER_ROLE] = 3;
    }
    
    function grantRole(bytes32 role, address account) public override {
        require(
            roleMembers[role].length() < roleMaxMembers[role],
            "Role member limit reached"
        );
        
        super.grantRole(role, account);
        roleMembers[role].add(account);
        
        // å‘é€äº‹ä»¶ç”¨äºç›‘æ§
        emit RoleGranted(role, account, msg.sender);
    }
    
    // æ‰¹é‡æ“ä½œéœ€è¦å¤šä¸ªè§’è‰²ç¡®è®¤
    mapping(bytes32 => mapping(address => bool)) public batchOperationApprovals;
    uint256 constant BATCH_APPROVAL_THRESHOLD = 2;
    
    function approveBatchMint(bytes32 operationId) external onlyRole(MINTER_ROLE) {
        batchOperationApprovals[operationId][msg.sender] = true;
    }
    
    function executeBatchMint(
        address[] calldata recipients,
        uint256[] calldata amounts,
        bytes32 operationId
    ) external onlyRole(MINTER_ROLE) {
        // æ£€æŸ¥æ‰¹å‡†æ•°é‡
        uint256 approvals = 0;
        for (uint256 i = 0; i < roleMembers[MINTER_ROLE].length(); i++) {
            if (batchOperationApprovals[operationId][roleMembers[MINTER_ROLE].at(i)]) {
                approvals++;
            }
        }
        
        require(approvals >= BATCH_APPROVAL_THRESHOLD, "Insufficient approvals");
        
        // æ‰§è¡Œæ‰¹é‡é“¸é€ 
        for (uint256 i = 0; i < recipients.length; i++) {
            _mint(recipients[i], amounts[i]);
        }
        
        // æ¸…ç†æ‰¹å‡†è®°å½•
        for (uint256 i = 0; i < roleMembers[MINTER_ROLE].length(); i++) {
            delete batchOperationApprovals[operationId][roleMembers[MINTER_ROLE].at(i)];
        }
    }
}</code></pre>
            </div>
        </div>

        <h3 id="audit-testing">9.5 å®‰å…¨å®¡è®¡ä¸æµ‹è¯•</h3>
        
        <div class="intro-box" style="background-color: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0;">
            <h4>ğŸ” å®¡è®¡ï¼šæœ€åçš„å®ˆé—¨äºº</h4>
            <p>å®‰å…¨å®¡è®¡ä¸æ˜¯æ‰¾åˆ°æ‰€æœ‰æ¼æ´çš„é“¶å¼¹ï¼Œè€Œæ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§çš„éªŒè¯è¿‡ç¨‹ã€‚å®ƒç»“åˆäº†è‡ªåŠ¨åŒ–å·¥å…·ã€äººå·¥å®¡æŸ¥ã€æ•°å­¦è¯æ˜å’Œå®æˆ˜æµ‹è¯•ï¼Œä¸ºæ™ºèƒ½åˆçº¦éƒ¨ç½²å‰æä¾›æœ€åä¸€é“é˜²çº¿ã€‚</p>
            
            <div style="background-color: #e0f2fe; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <h5>ğŸ¯ ç°ä»£å®¡è®¡çš„å››å¤§æ”¯æŸ±ï¼š</h5>
                <ol>
                    <li><strong>è‡ªåŠ¨åŒ–æ‰«æ</strong>ï¼šé™æ€åˆ†æã€ç¬¦å·æ‰§è¡Œã€å½¢å¼åŒ–éªŒè¯</li>
                    <li><strong>äººå·¥å®¡æŸ¥</strong>ï¼šä¸šåŠ¡é€»è¾‘ã€è¾¹ç¼˜æ¡ˆä¾‹ã€æ¶æ„è®¾è®¡</li>
                    <li><strong>æ¨¡ç³Šæµ‹è¯•</strong>ï¼šéšæœºè¾“å…¥ã€å±æ€§æµ‹è¯•ã€å·®åˆ†æµ‹è¯•</li>
                    <li><strong>å®æˆ˜æ¼”ç»ƒ</strong>ï¼šç™½å¸½æ”»å‡»ã€Bugèµé‡‘ã€ç«äº‰å®¡è®¡</li>
                </ol>
            </div>
        </div>
        
        <div class="info-box">
            <p><strong>2024å¹´æœ€æ–°å·¥å…·</strong>ï¼šFoundryå·²æˆä¸ºç°ä»£æ™ºèƒ½åˆçº¦å®‰å…¨å¼€å‘çš„åŸºçŸ³ï¼Œå…¶å†…ç½®çš„Fuzz Testingå’Œç¬¦å·æ‰§è¡Œèƒ½åŠ›æ˜¯æ£€æµ‹è¾¹ç¼˜æ¡ˆä¾‹çš„å…³é”®ã€‚</p>
            
            <h4>ğŸ“Š ä¸»æµå®¡è®¡å·¥å…·å¯¹æ¯”ï¼ˆ2024ç‰ˆï¼‰</h4>
            <table style="width: 100%; border-collapse: collapse; margin-top: 15px;">
                <thead>
                    <tr style="background-color: #f3f4f6;">
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">å·¥å…·/æœåŠ¡</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">ç±»å‹</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">ä¼˜åŠ¿</th>
                        <th style="border: 1px solid #e5e7eb; padding: 12px;">æˆæœ¬</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>Foundry</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å¼€å‘æ¡†æ¶</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å¿«é€Ÿã€æ¨¡ç³Šæµ‹è¯•ã€ç¬¦å·æ‰§è¡Œ</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å…è´¹</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>Slither</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">é™æ€åˆ†æ</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å¿«é€Ÿæ‰«æã€ä½è¯¯æŠ¥ç‡</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å…è´¹</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>Mythril</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ç¬¦å·æ‰§è¡Œ</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">æ·±åº¦åˆ†æã€å¤æ‚æ¼æ´</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å…è´¹</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>Certora</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å½¢å¼åŒ–éªŒè¯</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">æ•°å­¦è¯æ˜ã€é«˜ç½®ä¿¡åº¦</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$$$</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>Code4rena</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">ç«äº‰å®¡è®¡</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">å¤šäººå®¡æŸ¥ã€å®æˆ˜ç»éªŒ</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">$50k+</td>
                    </tr>
                    <tr style="background-color: #f9fafb;">
                        <td style="border: 1px solid #e5e7eb; padding: 12px;"><strong>Immunefi</strong></td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">Bugèµé‡‘</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">æŒç»­ä¿æŠ¤ã€ç™½å¸½æ¿€åŠ±</td>
                        <td style="border: 1px solid #e5e7eb; padding: 12px;">æŒ‰æ¼æ´ä»˜è´¹</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="warning-box">
            <h4>âš ï¸ å®¡è®¡çš„å±€é™æ€§</h4>
            <ul>
                <li><strong>æ—¶é—´å¿«ç…§</strong>ï¼šå®¡è®¡åªé’ˆå¯¹ç‰¹å®šç‰ˆæœ¬çš„ä»£ç </li>
                <li><strong>å‡è®¾æ¡ä»¶</strong>ï¼šåŸºäºå®¡è®¡æ—¶çš„ç¯å¢ƒå’Œä¾èµ–</li>
                <li><strong>äººä¸ºå› ç´ </strong>ï¼šå®¡è®¡å¸ˆçš„ç»éªŒå’Œä¸“æ³¨åº¦å½±å“ç»“æœ</li>
                <li><strong>æœªçŸ¥æœªçŸ¥</strong>ï¼šæ–°å‹æ”»å‡»æ‰‹æ³•å¯èƒ½æœªè¢«è€ƒè™‘</li>
                <li><strong>ç»„åˆå¤æ‚æ€§</strong>ï¼šä¸å…¶ä»–åè®®äº¤äº’çš„é£é™©éš¾ä»¥å®Œå…¨è¯„ä¼°</li>
            </ul>
        </div>
        
        <div class="practice-section">
            <h4>9.5.1 è‡ªåŠ¨åŒ–å®‰å…¨æµ‹è¯•æ¡†æ¶</h4>
            
            <div class="code-block">
                <div class="code-header">
                    JavaScript ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-javascript">// Foundryæµ‹è¯•æ¡†æ¶ç¤ºä¾‹
// test/StablecoinSecurity.t.sol
pragma solidity ^0.8.19;

import "forge-std/Test.sol";
import "../src/Stablecoin.sol";

contract StablecoinSecurityTest is Test {
    Stablecoin public stablecoin;
    address public attacker = makeAddr("attacker");
    address public victim = makeAddr("victim");
    
    function setUp() public {
        stablecoin = new Stablecoin();
        
        // åˆå§‹åŒ–æµ‹è¯•ç¯å¢ƒ
        deal(address(stablecoin), victim, 1000e18);
        vm.label(attacker, "Attacker");
        vm.label(victim, "Victim");
    }
    
    // æ¨¡ç³Šæµ‹è¯•ï¼šæ£€æµ‹æ•´æ•°æº¢å‡º
    function testFuzz_NoOverflow(uint256 amount1, uint256 amount2) public {
        vm.assume(amount1 < type(uint256).max / 2);
        vm.assume(amount2 < type(uint256).max / 2);
        
        uint256 totalSupplyBefore = stablecoin.totalSupply();
        
        vm.prank(address(this));
        stablecoin.mint(attacker, amount1);
        stablecoin.mint(attacker, amount2);
        
        assertEq(
            stablecoin.totalSupply(),
            totalSupplyBefore + amount1 + amount2,
            "Total supply calculation error"
        );
    }
    
    // ä¸å˜é‡æµ‹è¯•
    function invariant_totalSupplyEqualsBalances() public {
        uint256 totalBalances = 0;
        address[] memory holders = stablecoin.getAllHolders();
        
        for (uint i = 0; i < holders.length; i++) {
            totalBalances += stablecoin.balanceOf(holders[i]);
        }
        
        assertEq(totalBalances, stablecoin.totalSupply(), 
            "Invariant violated: sum of balances != totalSupply");
    }
    
    // é‡å…¥æ”»å‡»æµ‹è¯•
    function test_ReentrancyProtection() public {
        ReentrancyAttacker attacker = new ReentrancyAttacker(address(stablecoin));
        
        deal(address(stablecoin), address(attacker), 1000e18);
        
        vm.expectRevert("ReentrancyGuard: reentrant call");
        attacker.attack();
    }
    
    // æƒé™æå‡æµ‹è¯•
    function test_UnauthorizedAccess() public {
        vm.startPrank(attacker);
        
        vm.expectRevert("Unauthorized");
        stablecoin.mint(attacker, 1000e18);
        
        vm.expectRevert("Unauthorized");
        stablecoin.pause();
        
        vm.expectRevert("Unauthorized");
        stablecoin.updateOracle(attacker);
        
        vm.stopPrank();
    }
}

// ä½¿ç”¨Echidnaè¿›è¡Œå±æ€§æµ‹è¯•
contract EchidnaTest {
    Stablecoin stablecoin;
    
    constructor() {
        stablecoin = new Stablecoin();
    }
    
    // Echidnaå°†å°è¯•ä½¿è¿™ä¸ªå‡½æ•°è¿”å›false
    function echidna_balance_under_supply() public view returns (bool) {
        return stablecoin.balanceOf(msg.sender) <= stablecoin.totalSupply();
    }
    
    function echidna_no_self_mint() public view returns (bool) {
        return stablecoin.balanceOf(address(stablecoin)) == 0;
    }
}</code></pre>
                </div>
            </div>
            
            <h4>9.5.2 é™æ€åˆ†æå·¥å…·é›†æˆ</h4>
            
            <div class="code-block">
                <div class="code-header">
                    Python ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-python"># è‡ªåŠ¨åŒ–å®‰å…¨æ‰«æè„šæœ¬
import subprocess
import json
import os
from typing import List, Dict, Any

class SecurityAnalyzer:
    def __init__(self, contract_path: str):
        self.contract_path = contract_path
        self.results = {}
    
    def run_slither(self) -> Dict[str, Any]:
        """è¿è¡ŒSlitheré™æ€åˆ†æ"""
        try:
            result = subprocess.run(
                ['slither', self.contract_path, '--json', 'slither-report.json'],
                capture_output=True,
                text=True
            )
            
            with open('slither-report.json', 'r') as f:
                data = json.load(f)
            
            # åˆ†æä¸¥é‡æ€§
            issues = {
                'high': [],
                'medium': [],
                'low': [],
                'informational': []
            }
            
            for detector in data.get('results', {}).get('detectors', []):
                severity = detector['impact']
                issues[severity].append({
                    'check': detector['check'],
                    'description': detector['description'],
                    'elements': len(detector['elements'])
                })
            
            self.results['slither'] = issues
            return issues
            
        except Exception as e:
            print(f"Slither analysis failed: {e}")
            return {}
    
    def run_mythril(self) -> Dict[str, Any]:
        """è¿è¡ŒMythrilç¬¦å·æ‰§è¡Œ"""
        try:
            result = subprocess.run(
                ['myth', 'analyze', self.contract_path, '-o', 'json'],
                capture_output=True,
                text=True
            )
            
            data = json.loads(result.stdout)
            
            issues = []
            for issue in data.get('issues', []):
                issues.append({
                    'title': issue['title'],
                    'severity': issue['severity'],
                    'description': issue['description'],
                    'function': issue.get('function', 'Unknown')
                })
            
            self.results['mythril'] = issues
            return issues
            
        except Exception as e:
            print(f"Mythril analysis failed: {e}")
            return {}
    
    def check_known_vulnerabilities(self) -> List[Dict[str, str]]:
        """æ£€æŸ¥å·²çŸ¥æ¼æ´æ¨¡å¼"""
        vulnerabilities = []
        
        with open(self.contract_path, 'r') as f:
            content = f.read()
        
        # æ£€æŸ¥å±é™©æ¨¡å¼
        patterns = {
            'tx.origin': 'Using tx.origin for authentication',
            'selfdestruct': 'Contract contains selfdestruct',
            'delegatecall': 'Unsafe delegatecall usage',
            'block.timestamp': 'Timestamp dependence',
            '.call{value:': 'Low-level call with value',
            'ecrecover': 'Signature malleability risk'
        }
        
        for pattern, description in patterns.items():
            if pattern in content:
                vulnerabilities.append({
                    'pattern': pattern,
                    'risk': description,
                    'severity': 'medium'
                })
        
        self.results['patterns'] = vulnerabilities
        return vulnerabilities
    
    def generate_report(self) -> str:
        """ç”Ÿæˆå®‰å…¨æŠ¥å‘Š"""
        report = ["# æ™ºèƒ½åˆçº¦å®‰å…¨åˆ†ææŠ¥å‘Š\n"]
        
        # Slitherç»“æœ
        if 'slither' in self.results:
            report.append("## Slitheråˆ†æç»“æœ\n")
            for severity, issues in self.results['slither'].items():
                if issues:
                    report.append(f"### {severity.upper()} ({len(issues)})")
                    for issue in issues:
                        report.append(f"- {issue['check']}: {issue['description']}")
            report.append("")
        
        # Mythrilç»“æœ
        if 'mythril' in self.results:
            report.append("## Mythrilåˆ†æç»“æœ\n")
            for issue in self.results['mythril']:
                report.append(f"### {issue['severity']}: {issue['title']}")
                report.append(f"- Function: {issue['function']}")
                report.append(f"- {issue['description']}\n")
        
        # æ¨¡å¼æ£€æŸ¥
        if 'patterns' in self.results:
            report.append("## å±é™©æ¨¡å¼æ£€æµ‹\n")
            for vuln in self.results['patterns']:
                report.append(f"- **{vuln['pattern']}**: {vuln['risk']}")
        
        return '\n'.join(report)

# ä½¿ç”¨ç¤ºä¾‹
analyzer = SecurityAnalyzer('contracts/Stablecoin.sol')
analyzer.run_slither()
analyzer.run_mythril()
analyzer.check_known_vulnerabilities()

report = analyzer.generate_report()
with open('security-report.md', 'w') as f:
    f.write(report)</code></pre>
                </div>
            </div>
            
            <h4>9.5.2 å½¢å¼åŒ–éªŒè¯ï¼ˆ2024å·¥å…·é“¾ï¼‰</h4>
            <p>å½¢å¼åŒ–éªŒè¯é€šè¿‡æ•°å­¦è¯æ˜æ¥éªŒè¯ä»£ç çš„æ­£ç¡®æ€§ã€‚Certora Proverå’ŒHalmosæ˜¯å½“å‰ä¸»æµå·¥å…·ã€‚</p>
            
            <div class="code-block collapsible">
                <div class="code-header" onclick="toggleCode(this)">
                    <span class="toggle-icon">â–¼</span>
                    <span>Certoraè§„èŒƒç¤ºä¾‹</span>
                </div>
                <pre class="collapsed"><code class="language-javascript">// stablecoin.spec - CertoraéªŒè¯è§„èŒƒ
methods {
    balanceOf(address) returns (uint256) envfree
    totalSupply() returns (uint256) envfree
    collateralOf(address) returns (uint256) envfree
    debtOf(address) returns (uint256) envfree
}

// ä¸å˜é‡1ï¼šæ€»ä¾›åº”é‡ç­‰äºæ‰€æœ‰ç”¨æˆ·ä½™é¢ä¹‹å’Œ
ghost mapping(address => uint256) ghostBalances {
    init_state axiom forall address a. ghostBalances[a] == 0;
}

ghost uint256 ghostTotalSupply {
    init_state axiom ghostTotalSupply == 0;
}

hook Sstore _balances[KEY address a] uint256 newBalance (uint256 oldBalance) STORAGE {
    ghostTotalSupply = ghostTotalSupply - ghostBalances[a] + newBalance;
    ghostBalances[a] = newBalance;
}

invariant totalSupplyIntegrity()
    ghostTotalSupply == totalSupply()

// ä¸å˜é‡2ï¼šç”¨æˆ·ä¸èƒ½é“¸é€ æ— æŠµæŠ¼çš„ç¨³å®šå¸
invariant collateralizationRequirement(address user)
    debtOf(user) > 0 => collateralOf(user) * getPrice() >= debtOf(user) * 150 / 100

// è§„åˆ™ï¼šæ¸…ç®—å¿…é¡»æ”¹å–„ç³»ç»Ÿå¥åº·åº¦
rule liquidationImproveHealth {
    address liquidator;
    address user;
    
    uint256 systemHealthBefore = getSystemHealth();
    
    liquidate(e, user);
    
    uint256 systemHealthAfter = getSystemHealth();
    
    assert systemHealthAfter >= systemHealthBefore;
}

// è§„åˆ™ï¼šè½¬è´¦ä¸æ”¹å˜æ€»ä¾›åº”é‡
rule transferPreservesTotalSupply {
    address from;
    address to;
    uint256 amount;
    
    uint256 totalBefore = totalSupply();
    
    transfer(e, from, to, amount);
    
    uint256 totalAfter = totalSupply();
    
    assert totalBefore == totalAfter;
}</code></pre>
            </div>
            
            <h4>9.5.3 æ¨¡ç³Šæµ‹è¯•ï¼ˆFoundry Fuzzingï¼‰</h4>
            <p>ä½¿ç”¨Foundryçš„å†…ç½®æ¨¡ç³Šæµ‹è¯•åŠŸèƒ½ï¼Œé€šè¿‡å¤§é‡éšæœºè¾“å…¥å¯»æ‰¾è¾¹ç¼˜æ¡ˆä¾‹ã€‚</p>
            
            <div class="code-block collapsible">
                <div class="code-header" onclick="toggleCode(this)">
                    <span class="toggle-icon">â–¼</span>
                    <span>Foundryå±æ€§æµ‹è¯•ç¤ºä¾‹</span>
                </div>
                <pre class="collapsed"><code class="language-solidity">// test/StablecoinInvariants.t.sol
contract StablecoinInvariantTest is Test {
    Stablecoin stablecoin;
    MockOracle oracle;
    
    // å®šä¹‰ç³»ç»Ÿä¸å˜é‡
    function invariant_totalSupplyEqualsSum() public {
        uint256 sum = 0;
        address[] memory users = stablecoin.getAllUsers();
        
        for (uint i = 0; i < users.length; i++) {
            sum += stablecoin.balanceOf(users[i]);
        }
        
        assertEq(stablecoin.totalSupply(), sum);
    }
    
    function invariant_allDebtsCollateralized() public {
        address[] memory users = stablecoin.getAllUsers();
        
        for (uint i = 0; i < users.length; i++) {
            uint256 debt = stablecoin.debtOf(users[i]);
            if (debt > 0) {
                uint256 collateralValue = stablecoin.getCollateralValue(users[i]);
                assertGe(collateralValue * 100, debt * 150); // 150% æŠµæŠ¼ç‡
            }
        }
    }
    
    // æœ‰çŠ¶æ€æ¨¡ç³Šæµ‹è¯•
    function testFuzz_liquidationScenarios(
        uint256 collateralAmount,
        uint256 debtAmount,
        uint256 priceDropPercent
    ) public {
        // é™åˆ¶è¾“å…¥èŒƒå›´
        collateralAmount = bound(collateralAmount, 1 ether, 1000 ether);
        debtAmount = bound(debtAmount, 100e18, 10000e18);
        priceDropPercent = bound(priceDropPercent, 1, 50);
        
        // è®¾ç½®åœºæ™¯
        address user = address(0x1);
        vm.startPrank(user);
        
        // æŠµæŠ¼å¹¶å€Ÿå‡º
        stablecoin.deposit{value: collateralAmount}();
        uint256 maxBorrow = stablecoin.getMaxBorrow(user);
        if (debtAmount <= maxBorrow) {
            stablecoin.borrow(debtAmount);
            
            // æ¨¡æ‹Ÿä»·æ ¼ä¸‹è·Œ
            uint256 newPrice = oracle.getPrice() * (100 - priceDropPercent) / 100;
            oracle.setPrice(newPrice);
            
            // æ£€æŸ¥æ¸…ç®—é€»è¾‘
            if (stablecoin.getHealthFactor(user) < 1e18) {
                vm.stopPrank();
                vm.prank(address(0x2));
                stablecoin.liquidate(user);
                
                // éªŒè¯æ¸…ç®—åçŠ¶æ€
                assertLe(stablecoin.debtOf(user), debtAmount / 2);
            }
        }
    }
}</code></pre>
            </div>
            
            <h4>9.5.4 AIé©±åŠ¨çš„å®‰å…¨åˆ†æï¼ˆ2024å‰æ²¿ï¼‰</h4>
            <p>åˆ©ç”¨å¤§å‹è¯­è¨€æ¨¡å‹å’Œæœºå™¨å­¦ä¹ æŠ€æœ¯å¢å¼ºæ™ºèƒ½åˆçº¦å®‰å…¨åˆ†æèƒ½åŠ›ã€‚</p>
            
            <div class="code-block collapsible">
                <div class="code-header" onclick="toggleCode(this)">
                    <span class="toggle-icon">â–¼</span>
                    <span>AIå®‰å…¨åˆ†æå·¥å…·é›†æˆ</span>
                </div>
                <pre class="collapsed"><code class="language-python"># AIé©±åŠ¨çš„æ™ºèƒ½åˆçº¦å®¡è®¡ç³»ç»Ÿ
import openai
import torch
from transformers import AutoModel, AutoTokenizer
import ast
import re
from typing import List, Dict, Tuple

class AIContractAnalyzer:
    def __init__(self):
        self.vulnerability_patterns = self.load_vulnerability_dataset()
        self.model = self.load_security_model()
        
    def analyze_contract_with_llm(self, contract_code: str) -> Dict[str, Any]:
        """ä½¿ç”¨LLMåˆ†æåˆçº¦ä»£ç """
        prompt = f"""
        åˆ†æä»¥ä¸‹Solidityæ™ºèƒ½åˆçº¦çš„å®‰å…¨æ€§ï¼Œç‰¹åˆ«å…³æ³¨ï¼š
        1. é‡å…¥æ”»å‡»é£é™©
        2. æ•´æ•°æº¢å‡º/ä¸‹æº¢
        3. è®¿é—®æ§åˆ¶é—®é¢˜
        4. é€»è¾‘é”™è¯¯
        5. Gasä¼˜åŒ–æœºä¼š
        
        åˆçº¦ä»£ç ï¼š
        ```solidity
        {contract_code}
        ```
        
        è¯·æä¾›è¯¦ç»†çš„å®‰å…¨åˆ†ææŠ¥å‘Šã€‚
        """
        
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[
                {"role": "system", "content": "ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ™ºèƒ½åˆçº¦å®‰å…¨å®¡è®¡ä¸“å®¶ã€‚"},
                {"role": "user", "content": prompt}
            ],
            temperature=0.1
        )
        
        return self.parse_llm_response(response.choices[0].message.content)
    
    def detect_vulnerability_patterns(self, contract_code: str) -> List[Dict]:
        """ä½¿ç”¨æœºå™¨å­¦ä¹ æ¨¡å‹æ£€æµ‹æ¼æ´æ¨¡å¼"""
        # å°†ä»£ç è½¬æ¢ä¸ºç‰¹å¾å‘é‡
        features = self.extract_code_features(contract_code)
        
        # ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹é¢„æµ‹
        with torch.no_grad():
            predictions = self.model(features)
            
        vulnerabilities = []
        for idx, prob in enumerate(predictions):
            if prob > 0.8:  # é«˜ç½®ä¿¡åº¦é˜ˆå€¼
                vuln_type = self.vulnerability_patterns[idx]
                vulnerabilities.append({
                    'type': vuln_type['name'],
                    'severity': vuln_type['severity'],
                    'confidence': float(prob),
                    'recommendation': vuln_type['fix']
                })
        
        return vulnerabilities
    
    def extract_code_features(self, contract_code: str) -> torch.Tensor:
        """æå–ä»£ç ç‰¹å¾ç”¨äºMLæ¨¡å‹"""
        features = []
        
        # å‡½æ•°è°ƒç”¨æ¨¡å¼
        external_calls = len(re.findall(r'\.call\(|\.delegatecall\(|\.transfer\(', contract_code))
        features.append(external_calls)
        
        # çŠ¶æ€å˜é‡ä¿®æ”¹
        state_changes = len(re.findall(r'\s=\s', contract_code))
        features.append(state_changes)
        
        # æ¡ä»¶æ£€æŸ¥
        requires = len(re.findall(r'require\(|assert\(', contract_code))
        features.append(requires)
        
        # å¾ªç¯å¤æ‚åº¦
        loops = len(re.findall(r'for\s*\(|while\s*\(', contract_code))
        features.append(loops)
        
        # æ›´å¤šç‰¹å¾æå–...
        
        return torch.tensor(features, dtype=torch.float32)
    
    def generate_security_score(self, vulnerabilities: List[Dict]) -> float:
        """ç”Ÿæˆå®‰å…¨è¯„åˆ†"""
        if not vulnerabilities:
            return 100.0
        
        severity_weights = {
            'critical': 25,
            'high': 15,
            'medium': 10,
            'low': 5,
            'informational': 2
        }
        
        total_penalty = sum(
            severity_weights.get(v['severity'], 0) * v['confidence'] 
            for v in vulnerabilities
        )
        
        return max(0, 100 - total_penalty)

# é›†æˆåˆ°CI/CDæµç¨‹
class SecurityPipeline:
    def __init__(self):
        self.ai_analyzer = AIContractAnalyzer()
        self.traditional_tools = ['slither', 'mythril', 'echidna']
        
    async def run_comprehensive_audit(self, contract_path: str) -> Dict:
        """è¿è¡Œå…¨é¢çš„å®‰å…¨å®¡è®¡"""
        results = {
            'ai_analysis': {},
            'static_analysis': {},
            'fuzzing_results': {},
            'formal_verification': {}
        }
        
        # 1. AIåˆ†æ
        with open(contract_path, 'r') as f:
            code = f.read()
        
        results['ai_analysis'] = self.ai_analyzer.analyze_contract_with_llm(code)
        vulnerabilities = self.ai_analyzer.detect_vulnerability_patterns(code)
        results['ai_analysis']['ml_vulnerabilities'] = vulnerabilities
        results['ai_analysis']['security_score'] = self.ai_analyzer.generate_security_score(vulnerabilities)
        
        # 2. ä¼ ç»Ÿå·¥å…·åˆ†æï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
        import asyncio
        traditional_results = await asyncio.gather(
            self.run_slither_async(contract_path),
            self.run_mythril_async(contract_path),
            self.run_echidna_async(contract_path)
        )
        
        # 3. ç»¼åˆåˆ†æç»“æœ
        results['combined_score'] = self.calculate_combined_score(results)
        results['recommendations'] = self.generate_recommendations(results)
        
        return results</code></pre>
            </div>
            
            <h4>9.5.5 å®¡è®¡æŠ¥å‘Šæœ€ä½³å®è·µ</h4>
            <p>ä¸“ä¸šçš„å®‰å…¨å®¡è®¡æŠ¥å‘Šåº”åŒ…å«å®Œæ•´çš„å¨èƒæ¨¡å‹ã€æµ‹è¯•æ–¹æ³•å’Œä¿®å¤å»ºè®®ã€‚</p>
            
            <div class="info-box">
                <p><strong>2024å®¡è®¡æ ‡å‡†</strong>ï¼šç°ä»£å®¡è®¡æµç¨‹åº”ç»“åˆè‡ªåŠ¨åŒ–å·¥å…·ã€å½¢å¼åŒ–éªŒè¯å’Œäººå·¥å®¡æŸ¥ã€‚é‡ç‚¹å…³æ³¨ç»æµæ¨¡å‹å®‰å…¨æ€§å’Œè·¨é“¾äº¤äº’é£é™©ã€‚</p>
            </div>
        </div>

        <h3 id="monitoring-response">9.6 å®æ—¶ç›‘æ§ä¸åº”æ€¥å“åº”</h3>
        
        <div class="theory-section">
            <h4>9.6.1 é“¾ä¸Šç›‘æ§ç³»ç»Ÿ</h4>
            
            <div class="code-block">
                <div class="code-header">
                    TypeScript ä»£ç  <span class="toggle-icon">â–¼</span>
                </div>
                <div class="code-content" style="display: none;">
                    <pre><code class="language-typescript">// å®æ—¶ç›‘æ§ç³»ç»Ÿ
import { ethers } from 'ethers';
import { WebhookClient } from 'discord.js';
import { Defender } from '@openzeppelin/defender-sdk';

class StablecoinMonitor {
    private provider: ethers.Provider;
    private contract: ethers.Contract;
    private alerts: WebhookClient;
    private defender: Defender;
    
    // ç›‘æ§é˜ˆå€¼
    private readonly LARGE_TRANSFER_THRESHOLD = ethers.parseEther('1000000'); // 100ä¸‡
    private readonly PRICE_DEVIATION_THRESHOLD = 0.02; // 2%
    private readonly UNUSUAL_GAS_MULTIPLIER = 3;
    
    constructor(config: MonitorConfig) {
        this.provider = new ethers.JsonRpcProvider(config.rpcUrl);
        this.contract = new ethers.Contract(
            config.contractAddress,
            config.abi,
            this.provider
        );
        this.alerts = new WebhookClient({ url: config.webhookUrl });
        this.defender = new Defender(config.defenderCredentials);
    }
    
    async startMonitoring() {
        // ç›‘æ§å¤§é¢è½¬è´¦
        this.contract.on('Transfer', async (from, to, value, event) => {
            if (value > this.LARGE_TRANSFER_THRESHOLD) {
                await this.alertLargeTransfer(from, to, value, event);
            }
            
            // æ£€æŸ¥å¯ç–‘æ¨¡å¼
            await this.checkSuspiciousPatterns(from, to, value);
        });
        
        // ç›‘æ§ä»·æ ¼åç¦»
        setInterval(() => this.checkPriceDeviation(), 60000); // æ¯åˆ†é’Ÿ
        
        // ç›‘æ§å¼‚å¸¸Gasä½¿ç”¨
        this.provider.on('block', async (blockNumber) => {
            await this.checkGasAnomalies(blockNumber);
        });
        
        // ç›‘æ§åˆçº¦æš‚åœäº‹ä»¶
        this.contract.on('Paused', async (account) => {
            await this.alertEmergency('Contract Paused', {
                by: account,
                timestamp: new Date().toISOString()
            });
        });
    }
    
    private async checkSuspiciousPatterns(
        from: string, 
        to: string, 
        value: bigint
    ) {
        // æ£€æŸ¥é—ªç”µè´·æ¨¡å¼
        const fromCode = await this.provider.getCode(from);
        const toCode = await this.provider.getCode(to);
        
        if (fromCode !== '0x' && toCode !== '0x') {
            // ä¸¤ä¸ªåˆçº¦ä¹‹é—´çš„å¤§é¢è½¬è´¦
            const block = await this.provider.getBlock('latest');
            const recentTxs = await this.getRecentTransactions(from, 10);
            
            // æ£€æŸ¥å¾ªç¯æ¨¡å¼
            const hasCircularPattern = recentTxs.some(tx => 
                tx.to?.toLowerCase() === to.toLowerCase() &&
                tx.from.toLowerCase() === from.toLowerCase()
            );
            
            if (hasCircularPattern) {
                await this.alertSuspicious('Potential Flash Loan Attack', {
                    from,
                    to,
                    value: ethers.formatEther(value),
                    pattern: 'circular transfers detected'
                });
            }
        }
        
        // æ£€æŸ¥æ–°åˆ›å»ºçš„åˆçº¦
        const toAge = await this.getContractAge(to);
        if (toCode !== '0x' && toAge < 3600) { // å°äº1å°æ—¶
            await this.alertSuspicious('Transfer to New Contract', {
                contract: to,
                age: `${toAge} seconds`,
                value: ethers.formatEther(value)
            });
        }
    }
    
    private async checkPriceDeviation() {
        try {
            const oraclePrice = await this.contract.getOraclePrice();
            const targetPrice = ethers.parseEther('1'); // $1
            
            const deviation = Number(
                ((oraclePrice - targetPrice) * 10000n) / targetPrice
            ) / 10000;
            
            if (Math.abs(deviation) > this.PRICE_DEVIATION_THRESHOLD) {
                await this.alertPriceDeviation(deviation, oraclePrice);
                
                // è‡ªåŠ¨è§¦å‘é˜²å¾¡æªæ–½
                if (Math.abs(deviation) > 0.05) { // 5%
                    await this.triggerEmergencyAction('pause');
                }
            }
        } catch (error) {
            console.error('Price check failed:', error);
        }
    }
    
    private async triggerEmergencyAction(action: string) {
        // ä½¿ç”¨OpenZeppelin Defenderæ‰§è¡Œç´§æ€¥æ“ä½œ
        try {
            const response = await this.defender.relaySigner.sendTransaction({
                to: this.contract.address,
                data: this.contract.interface.encodeFunctionData(action),
                speed: 'fast',
                gasLimit: 100000
            });
            
            await this.alertEmergency(`Emergency ${action} triggered`, {
                txHash: response.hash,
                reason: 'Automatic protection activated'
            });
        } catch (error) {
            console.error('Emergency action failed:', error);
        }
    }
    
    private async alertLargeTransfer(
        from: string, 
        to: string, 
        value: bigint, 
        event: any
    ) {
        const embed = {
            title: 'âš ï¸ Large Transfer Detected',
            color: 0xFFCC00,
            fields: [
                { name: 'From', value: from, inline: true },
                { name: 'To', value: to, inline: true },
                { name: 'Amount', value: `${ethers.formatEther(value)} tokens` },
                { name: 'Transaction', value: event.transactionHash },
                { name: 'Block', value: event.blockNumber.toString() }
            ],
            timestamp: new Date().toISOString()
        };
        
        await this.alerts.send({ embeds: [embed] });
    }
}

// åº”æ€¥å“åº”è®¡åˆ’
class IncidentResponse {
    private readonly actions = {
        'price-deviation': ['pause-minting', 'increase-fees', 'alert-team'],
        'large-withdrawal': ['check-reserves', 'prepare-liquidity', 'monitor-closely'],
        'smart-contract-exploit': ['pause-all', 'snapshot-state', 'prepare-upgrade'],
        'oracle-failure': ['switch-oracle', 'use-twap', 'manual-override']
    };
    
    async executeResponsePlan(incidentType: string, severity: 'low' | 'medium' | 'high' | 'critical') {
        const plan = this.actions[incidentType] || ['alert-team'];
        
        for (const action of plan) {
            await this.executeAction(action, severity);
        }
    }
    
    private async executeAction(action: string, severity: string) {
        console.log(`Executing ${action} for ${severity} incident`);
        // å®ç°å…·ä½“çš„å“åº”åŠ¨ä½œ
    }
}</code></pre>
                </div>
            </div>
        </div>

        <div class="exercise">
            <div class="exercise-header">
                <span class="exercise-icon">ğŸ’»</span>
                <h4>ç»ƒä¹ 9.1ï¼šå®ç°å®‰å…¨çš„ç¨³å®šå¸åˆçº¦</h4>
            </div>
            <p>å®ç°ä¸€ä¸ªåŒ…å«ä»¥ä¸‹å®‰å…¨ç‰¹æ€§çš„ç¨³å®šå¸åˆçº¦ï¼š</p>
            <ol>
                <li>å¤šç­¾åæ§åˆ¶çš„é“¸é€ æƒé™</li>
                <li>è‡ªåŠ¨æ–­è·¯å™¨ï¼ˆä»·æ ¼åç¦»è¶…è¿‡3%è‡ªåŠ¨æš‚åœï¼‰</li>
                <li>é˜²é‡å…¥ä¿æŠ¤</li>
                <li>å‡çº§æœºåˆ¶ï¼ˆä½¿ç”¨UUPSæ¨¡å¼ï¼‰</li>
                <li>ç´§æ€¥æš‚åœåŠŸèƒ½</li>
            </ol>
            
            <button class="answer-toggle" onclick="toggleAnswer(this)">æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</button>
            <div class="answer-content">
                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">solidity</span>
                    </div>
                    <div class="code-content">
                        <pre><code class="language-solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@openzeppelin/contracts-upgradeable/token/ERC20/ERC20Upgradeable.sol";
import "@openzeppelin/contracts-upgradeable/security/PausableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/AccessControlUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/security/ReentrancyGuardUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";

contract SecureStablecoin is 
    ERC20Upgradeable,
    PausableUpgradeable,
    AccessControlUpgradeable,
    ReentrancyGuardUpgradeable,
    UUPSUpgradeable 
{
    // è§’è‰²å®šä¹‰
    bytes32 public constant MINTER_ROLE = keccak256("MINTER_ROLE");
    bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
    bytes32 public constant UPGRADER_ROLE = keccak256("UPGRADER_ROLE");
    bytes32 public constant ORACLE_ROLE = keccak256("ORACLE_ROLE");
    
    // å¤šç­¾åç›¸å…³
    struct MintProposal {
        address to;
        uint256 amount;
        uint256 approvals;
        uint256 timestamp;
        bool executed;
        mapping(address => bool) hasApproved;
    }
    
    mapping(uint256 => MintProposal) public mintProposals;
    uint256 public proposalCounter;
    uint256 public constant REQUIRED_APPROVALS = 2;
    uint256 public constant PROPOSAL_TIMEOUT = 48 hours;
    
    // æ–­è·¯å™¨ç›¸å…³
    uint256 public constant PRICE_DEVIATION_THRESHOLD = 300; // 3%
    uint256 public lastPriceUpdateTime;
    uint256 public currentPrice;
    uint256 public priceDeviationCount;
    bool public circuitBreakerActive;
    
    // äº‹ä»¶
    event MintProposed(uint256 indexed proposalId, address to, uint256 amount);
    event MintApproved(uint256 indexed proposalId, address approver);
    event MintExecuted(uint256 indexed proposalId, address to, uint256 amount);
    event CircuitBreakerActivated(uint256 price, uint256 deviation);
    event PriceUpdated(uint256 newPrice, uint256 timestamp);
    
    /// @custom:oz-upgrades-unsafe-allow constructor
    constructor() {
        _disableInitializers();
    }
    
    function initialize() public initializer {
        __ERC20_init("Secure Stablecoin", "SSTABLE");
        __Pausable_init();
        __AccessControl_init();
        __ReentrancyGuard_init();
        __UUPSUpgradeable_init();
        
        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _grantRole(PAUSER_ROLE, msg.sender);
        _grantRole(UPGRADER_ROLE, msg.sender);
        
        currentPrice = 1e18; // $1
        lastPriceUpdateTime = block.timestamp;
    }
    
    // å¤šç­¾åé“¸é€ 
    function proposeMint(address to, uint256 amount) 
        external 
        onlyRole(MINTER_ROLE) 
        returns (uint256) 
    {
        uint256 proposalId = proposalCounter++;
        
        MintProposal storage proposal = mintProposals[proposalId];
        proposal.to = to;
        proposal.amount = amount;
        proposal.timestamp = block.timestamp;
        proposal.approvals = 1;
        proposal.hasApproved[msg.sender] = true;
        
        emit MintProposed(proposalId, to, amount);
        return proposalId;
    }
    
    function approveMint(uint256 proposalId) 
        external 
        onlyRole(MINTER_ROLE) 
    {
        MintProposal storage proposal = mintProposals[proposalId];
        
        require(!proposal.executed, "Already executed");
        require(!proposal.hasApproved[msg.sender], "Already approved");
        require(
            block.timestamp <= proposal.timestamp + PROPOSAL_TIMEOUT,
            "Proposal expired"
        );
        
        proposal.hasApproved[msg.sender] = true;
        proposal.approvals++;
        
        emit MintApproved(proposalId, msg.sender);
        
        if (proposal.approvals >= REQUIRED_APPROVALS) {
            _executeMint(proposalId);
        }
    }
    
    function _executeMint(uint256 proposalId) private {
        MintProposal storage proposal = mintProposals[proposalId];
        
        require(!proposal.executed, "Already executed");
        proposal.executed = true;
        
        _mint(proposal.to, proposal.amount);
        emit MintExecuted(proposalId, proposal.to, proposal.amount);
    }
    
    // ä»·æ ¼æ›´æ–°ä¸æ–­è·¯å™¨
    function updatePrice(uint256 newPrice) 
        external 
        onlyRole(ORACLE_ROLE) 
    {
        require(newPrice > 0, "Invalid price");
        
        uint256 targetPrice = 1e18; // $1
        uint256 deviation = newPrice > targetPrice ? 
            ((newPrice - targetPrice) * 10000) / targetPrice :
            ((targetPrice - newPrice) * 10000) / targetPrice;
        
        if (deviation > PRICE_DEVIATION_THRESHOLD) {
            priceDeviationCount++;
            
            if (!circuitBreakerActive) {
                circuitBreakerActive = true;
                _pause();
                emit CircuitBreakerActivated(newPrice, deviation);
            }
        } else {
            // ä»·æ ¼æ¢å¤æ­£å¸¸
            if (priceDeviationCount > 0) {
                priceDeviationCount--;
            }
            
            if (circuitBreakerActive && priceDeviationCount == 0) {
                circuitBreakerActive = false;
                _unpause();
            }
        }
        
        currentPrice = newPrice;
        lastPriceUpdateTime = block.timestamp;
        emit PriceUpdated(newPrice, block.timestamp);
    }
    
    // è¦†ç›–transferå‡½æ•°æ·»åŠ æ–­è·¯å™¨æ£€æŸ¥
    function transfer(address to, uint256 amount) 
        public 
        override 
        whenNotPaused 
        nonReentrant 
        returns (bool) 
    {
        // æ£€æŸ¥ä»·æ ¼æ›´æ–°æ—¶é—´
        require(
            block.timestamp - lastPriceUpdateTime < 1 hours,
            "Price oracle stale"
        );
        
        return super.transfer(to, amount);
    }
    
    // ç´§æ€¥åŠŸèƒ½
    function pause() external onlyRole(PAUSER_ROLE) {
        _pause();
    }
    
    function unpause() external onlyRole(PAUSER_ROLE) {
        require(!circuitBreakerActive, "Circuit breaker active");
        _unpause();
    }
    
    // UUPSå‡çº§æˆæƒ
    function _authorizeUpgrade(address newImplementation)
        internal
        override
        onlyRole(UPGRADER_ROLE)
    {
        // å¯ä»¥æ·»åŠ é¢å¤–çš„å‡çº§æ£€æŸ¥
        require(newImplementation != address(0), "Invalid implementation");
    }
    
    // ç´§æ€¥æå–ï¼ˆä»…é™ç®¡ç†å‘˜ï¼Œç”¨äºæç«¯æƒ…å†µï¼‰
    function emergencyWithdraw(address token) 
        external 
        onlyRole(DEFAULT_ADMIN_ROLE) 
    {
        require(paused(), "Not in emergency");
        
        if (token == address(0)) {
            payable(msg.sender).transfer(address(this).balance);
        } else {
            IERC20(token).transfer(
                msg.sender, 
                IERC20(token).balanceOf(address(this))
            );
        }
    }
}</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <div class="exercise">
            <div class="exercise-header">
                <span class="exercise-icon">ğŸ”</span>
                <h4>ç»ƒä¹ 9.2ï¼šå®‰å…¨å®¡è®¡å®æˆ˜</h4>
            </div>
            <p>å¯¹ä»¥ä¸‹å­˜åœ¨æ¼æ´çš„ç¨³å®šå¸åˆçº¦è¿›è¡Œå®‰å…¨å®¡è®¡ï¼Œæ‰¾å‡ºæ‰€æœ‰å®‰å…¨é—®é¢˜å¹¶æä¾›ä¿®å¤æ–¹æ¡ˆï¼š</p>
            
            <div class="code-block">
                <div class="code-header">
                    <span class="code-language">solidity</span>
                </div>
                <div class="code-content">
                    <pre><code class="language-solidity">contract VulnerableStablecoin {
    mapping(address => uint256) public balances;
    mapping(address => bool) public minters;
    address public owner;
    uint256 public totalSupply;
    
    constructor() {
        owner = msg.sender;
    }
    
    function mint(address to, uint256 amount) external {
        require(minters[msg.sender], "Not minter");
        balances[to] += amount;
        totalSupply += amount;
    }
    
    function transfer(address to, uint256 amount) external {
        require(balances[msg.sender] >= amount);
        balances[msg.sender] -= amount;
        balances[to] += amount;
        
        if (to.code.length > 0) {
            (bool success,) = to.call(
                abi.encodeWithSignature("onTokenReceived(address,uint256)", msg.sender, amount)
            );
        }
    }
    
    function addMinter(address minter) external {
        require(msg.sender == owner);
        minters[minter] = true;
    }
    
    function updateOwner(address newOwner) external {
        require(msg.sender == owner);
        owner = newOwner;
    }
}</code></pre>
                </div>
            </div>
            
            <button class="answer-toggle" onclick="toggleAnswer(this)">æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</button>
            <div class="answer-content">
                <h5>å‘ç°çš„å®‰å…¨é—®é¢˜ï¼š</h5>
                <ol>
                    <li><strong>é‡å…¥æ”»å‡»æ¼æ´</strong>ï¼štransferå‡½æ•°åœ¨æ›´æ–°ä½™é¢åè¿›è¡Œå¤–éƒ¨è°ƒç”¨</li>
                    <li><strong>æ•´æ•°æº¢å‡º</strong>ï¼šmintå‡½æ•°ä¸­çš„åŠ æ³•æ“ä½œæœªæ£€æŸ¥æº¢å‡º</li>
                    <li><strong>æƒé™ç®¡ç†ç¼ºé™·</strong>ï¼šå•ç‚¹æ•…éšœï¼Œowneræƒé™è¿‡å¤§</li>
                    <li><strong>ç¼ºå°‘äº‹ä»¶æ—¥å¿—</strong>ï¼šå…³é”®æ“ä½œæ²¡æœ‰äº‹ä»¶è®°å½•</li>
                    <li><strong>å¤–éƒ¨è°ƒç”¨æœªæ£€æŸ¥è¿”å›å€¼</strong>ï¼šcallè°ƒç”¨ç»“æœè¢«å¿½ç•¥</li>
                    <li><strong>æ²¡æœ‰æš‚åœæœºåˆ¶</strong>ï¼šç´§æ€¥æƒ…å†µä¸‹æ— æ³•åœæ­¢åˆçº¦</li>
                </ol>
                
                <h5>ä¿®å¤åçš„åˆçº¦ï¼š</h5>
                <div class="code-block">
                    <div class="code-header">
                        <span class="code-language">solidity</span>
                    </div>
                    <div class="code-content">
                        <pre><code class="language-solidity">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/access/AccessControl.sol";
import "@openzeppelin/contracts/security/Pausable.sol";

contract SecureStablecoinV2 is ReentrancyGuard, AccessControl, Pausable {
    mapping(address => uint256) public balances;
    uint256 public totalSupply;
    
    bytes32 public constant MINTER_ROLE = keccak256("MINTER_ROLE");
    bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
    
    // äº‹ä»¶
    event Transfer(address indexed from, address indexed to, uint256 amount);
    event Mint(address indexed to, uint256 amount);
    event MinterAdded(address indexed minter);
    event MinterRemoved(address indexed minter);
    
    constructor() {
        _grantRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _grantRole(PAUSER_ROLE, msg.sender);
    }
    
    function mint(address to, uint256 amount) 
        external 
        onlyRole(MINTER_ROLE) 
        whenNotPaused 
    {
        require(to != address(0), "Mint to zero address");
        require(amount > 0, "Amount must be positive");
        
        // ä½¿ç”¨checked math (Solidity 0.8+è‡ªåŠ¨æ£€æŸ¥)
        balances[to] += amount;
        totalSupply += amount;
        
        emit Mint(to, amount);
        emit Transfer(address(0), to, amount);
    }
    
    function transfer(address to, uint256 amount) 
        external 
        nonReentrant 
        whenNotPaused 
        returns (bool) 
    {
        require(to != address(0), "Transfer to zero address");
        require(to != address(this), "Transfer to contract itself");
        require(amount > 0, "Amount must be positive");
        require(balances[msg.sender] >= amount, "Insufficient balance");
        
        // CEIæ¨¡å¼ï¼šå…ˆæ›´æ–°çŠ¶æ€
        balances[msg.sender] -= amount;
        balances[to] += amount;
        
        emit Transfer(msg.sender, to, amount);
        
        // å®‰å…¨çš„å¤–éƒ¨è°ƒç”¨ï¼ˆå¦‚æœéœ€è¦ï¼‰
        if (to.code.length > 0) {
            try ITokenReceiver(to).onTokenReceived(msg.sender, amount) returns (bool success) {
                require(success, "Token receiver failed");
            } catch {
                revert("Token receiver reverted");
            }
        }
        
        return true;
    }
    
    function addMinter(address minter) 
        external 
        onlyRole(DEFAULT_ADMIN_ROLE) 
    {
        require(minter != address(0), "Invalid minter address");
        grantRole(MINTER_ROLE, minter);
        emit MinterAdded(minter);
    }
    
    function removeMinter(address minter) 
        external 
        onlyRole(DEFAULT_ADMIN_ROLE) 
    {
        revokeRole(MINTER_ROLE, minter);
        emit MinterRemoved(minter);
    }
    
    function pause() external onlyRole(PAUSER_ROLE) {
        _pause();
    }
    
    function unpause() external onlyRole(PAUSER_ROLE) {
        _unpause();
    }
}

interface ITokenReceiver {
    function onTokenReceived(address from, uint256 amount) external returns (bool);
}</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <h3>æœ¬ç« æ€»ç»“</h3>
        
        <div class="tip-box">
            <p><strong>ğŸ¯ è®°ä½ï¼š</strong>åœ¨åŒºå—é“¾ä¸–ç•Œä¸­ï¼Œéƒ¨ç½²å³å®šå¾‹ï¼Œæ¼æ´å³åˆ¤å†³ã€‚ä¸€è¡Œé”™è¯¯çš„ä»£ç å¯èƒ½å¯¼è‡´æ•°ç™¾ä¸‡ç¾å…ƒçš„æŸå¤±ï¼Œè€Œä¸”è¿™ç§æŸå¤±é€šå¸¸æ˜¯ä¸å¯é€†çš„ã€‚å®‰å…¨ä¸æ˜¯æˆæœ¬ï¼Œè€Œæ˜¯æŠ•èµ„ã€‚</p>
        </div>
        
        <div class="summary-box">
            <h4>å…³é”®è¦ç‚¹ï¼š</h4>
            <ul>
                <li><strong>å®‰å…¨æ˜¯æŒç»­çš„è¿‡ç¨‹</strong>ï¼šä»è®¾è®¡åˆ°éƒ¨ç½²åˆ°è¿ç»´çš„å…¨ç”Ÿå‘½å‘¨æœŸ</li>
                <li><strong>å¤šå±‚é˜²å¾¡</strong>ï¼šä»£ç å®‰å…¨ + æ¶æ„å®‰å…¨ + ç»æµå®‰å…¨</li>
                <li><strong>è‡ªåŠ¨åŒ–å·¥å…·</strong>ï¼šé™æ€åˆ†æã€åŠ¨æ€æµ‹è¯•ã€å½¢å¼åŒ–éªŒè¯ç›¸ç»“åˆ</li>
                <li><strong>åº”æ€¥å‡†å¤‡</strong>ï¼šæ–­è·¯å™¨ã€æš‚åœæœºåˆ¶ã€å‡çº§è·¯å¾„å¿…ä¸å¯å°‘</li>
                <li><strong>ç¤¾åŒºåä½œ</strong>ï¼šbugèµé‡‘ã€å®‰å…¨å®¡è®¡ã€äº‹ä»¶æŠ«éœ²çš„é‡è¦æ€§</li>
            </ul>
            
            <h4>æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•ï¼š</h4>
            <ul>
                <li>â˜‘ï¸ ä½¿ç”¨ç»è¿‡å®¡è®¡çš„æ ‡å‡†åº“ï¼ˆOpenZeppelinï¼‰</li>
                <li>â˜‘ï¸ å®æ–½å¤šé‡ç­¾åå’Œæ—¶é—´é”</li>
                <li>â˜‘ï¸ éƒ¨ç½²å‰è¿›è¡Œå…¨é¢çš„å®‰å…¨å®¡è®¡</li>
                <li>â˜‘ï¸ å»ºç«‹å®æ—¶ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ</li>
                <li>â˜‘ï¸ å‡†å¤‡åº”æ€¥å“åº”è®¡åˆ’</li>
                <li>â˜‘ï¸ ä¿æŒä»£ç ç®€æ´ï¼Œé¿å…è¿‡åº¦å¤æ‚</li>
                <li>â˜‘ï¸ å®šæœŸæ›´æ–°ä¾èµ–å’Œå®‰å…¨è¡¥ä¸</li>
            </ul>
            
            <h4>å®‰å…¨å­¦ä¹ è·¯çº¿å›¾ï¼š</h4>
            <div style="background-color: #f0f9ff; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <ol>
                    <li><strong>åŸºç¡€é˜¶æ®µï¼ˆ1-2ä¸ªæœˆï¼‰</strong>
                        <ul>
                            <li>å­¦ä¹ å¸¸è§æ¼æ´æ¨¡å¼ï¼ˆSWC Registryï¼‰</li>
                            <li>æŒæ¡å®‰å…¨å¼€å‘å·¥å…·ï¼ˆFoundryã€Slitherï¼‰</li>
                            <li>é˜…è¯»ç»å…¸å®¡è®¡æŠ¥å‘Š</li>
                        </ul>
                    </li>
                    <li><strong>è¿›é˜¶é˜¶æ®µï¼ˆ3-6ä¸ªæœˆï¼‰</strong>
                        <ul>
                            <li>å‚ä¸CTFæ¯”èµ›ï¼ˆEthernautã€Damn Vulnerable DeFiï¼‰</li>
                            <li>å­¦ä¹ å½¢å¼åŒ–éªŒè¯åŸºç¡€</li>
                            <li>åˆ†æçœŸå®æ”»å‡»æ¡ˆä¾‹</li>
                        </ul>
                    </li>
                    <li><strong>ä¸“ä¸šé˜¶æ®µï¼ˆ6ä¸ªæœˆ+ï¼‰</strong>
                        <ul>
                            <li>å‚ä¸ç«äº‰å®¡è®¡ï¼ˆCode4renaã€Sherlockï¼‰</li>
                            <li>æ„å»ºè‡ªåŠ¨åŒ–å®‰å…¨å·¥å…·</li>
                            <li>ç ”ç©¶æ–°å‹æ”»å‡»å‘é‡</li>
                        </ul>
                    </li>
                </ol>
            </div>
            
            <h4>ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼š</h4>
            <p>æŒæ¡äº†å®‰å…¨åŸºç¡€åï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨ç»æµæ”»å‡»â€”â€”è¿™æ˜¯ç¨³å®šå¸é¢ä¸´çš„å¦ä¸€ç±»é‡å¤§å¨èƒã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•è¯†åˆ«å’Œé˜²å¾¡å„ç§ç»æµæ“çºµæ‰‹æ®µï¼Œæ„å»ºæ›´åŠ ç¨³å¥çš„ç»æµæ¨¡å‹ã€‚</p>
        </div>
    
            
            <!-- ç« èŠ‚å¯¼èˆª -->
            <div class="chapter-nav">
                <a href="chapter8.html">â† ç¬¬8ç« </a>
                <a href="chapter10.html">ç¬¬10ç«  â†’</a>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-solidity.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="script.js"></script>
</body>
</html>