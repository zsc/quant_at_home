<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬å…«ç« ï¼šæ”¶ç›Šç­–ç•¥ - åŒºå—é“¾ç¨³å®šå¸æ•™ç¨‹</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="container">
            <a href="index.html" class="navbar-brand">ç¨³å®šå¸æ•™ç¨‹</a>
            <button class="navbar-toggle" onclick="toggleMobileNav()">â˜°</button>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">é¦–é¡µ</a>
                </li>
                <li class="nav-item">
                    <a href="intro.html" class="nav-link">å¼•è¨€</a>
                </li>
                <li class="nav-item dropdown">
                    <a href="#" class="nav-link">ç« èŠ‚</a>
                    <div class="dropdown-menu">
                        <a href="chapter1.html" class="dropdown-item">ç¬¬1ç« ï¼šåŒºå—é“¾åŸºç¡€</a>
                        <a href="chapter2.html" class="dropdown-item">ç¬¬2ç« ï¼šç¨³å®šå¸åˆ†ç±»</a>
                        <a href="chapter3.html" class="dropdown-item">ç¬¬3ç« ï¼šERC-20æ ‡å‡†</a>
                        <a href="chapter4.html" class="dropdown-item">ç¬¬4ç« ï¼šæŠµæŠ¼å‹è®¾è®¡</a>
                        <a href="chapter5.html" class="dropdown-item">ç¬¬5ç« ï¼šæ•°å­¦æ¨¡å‹</a>
                        <a href="chapter6.html" class="dropdown-item">ç¬¬6ç« ï¼šAMMé›†æˆ</a>
                        <a href="chapter7.html" class="dropdown-item">ç¬¬7ç« ï¼šå€Ÿè´·åè®®</a>
                        <a href="chapter8.html" class="dropdown-item">ç¬¬8ç« ï¼šæ”¶ç›Šç­–ç•¥</a>
                        <a href="chapter9.html" class="dropdown-item">ç¬¬9ç« ï¼šæ™ºèƒ½åˆçº¦å®‰å…¨</a>
                        <a href="chapter10.html" class="dropdown-item">ç¬¬10ç« ï¼šç»æµæ”»å‡»</a>
                        <a href="chapter11.html" class="dropdown-item">ç¬¬11ç« ï¼šæœªæ¥æ–¹å‘</a>
                        <a href="chapter12.html" class="dropdown-item">ç¬¬12ç« ï¼šç”Ÿäº§éƒ¨ç½²</a>
                        <a href="chapter13.html" class="dropdown-item">ç¬¬13ç« ï¼šç”Ÿæ€é›†æˆ</a>
                    </div>
                </li>
                <li class="nav-item">
                    <a href="#resources" class="nav-link">èµ„æº</a>
                </li>
            </ul>
        </div>
    </nav>
    
    <!-- å¤´éƒ¨ -->
    <header id="top">
        <div class="container">
            <h1>ç¬¬å…«ç« ï¼šæ”¶ç›Šç­–ç•¥</h1>
        </div>
    </header>
    
    <!-- ä¸»è¦å†…å®¹ -->
    <div class="container">
        <div class="chapter">
<h2>ç¬¬å…«ç« ï¼šæ”¶ç›Šç­–ç•¥ï¼ˆYield Strategiesï¼‰</h2>
        
        <p>åœ¨DeFiä¸–ç•Œä¸­ï¼Œå¦‚ä½•è®©ç¨³å®šå¸äº§ç”Ÿæ”¶ç›Šæ˜¯æ¯ä¸ªæŠ•èµ„è€…å’Œåè®®éƒ½å…³å¿ƒçš„æ ¸å¿ƒé—®é¢˜ã€‚æœ¬ç« å°†ç³»ç»Ÿæ€§åœ°æ¢è®¨ç¨³å®šå¸æ”¶ç›Šç”Ÿæˆçš„å„ç§ç­–ç•¥ï¼Œä»æœ€ç®€å•çš„å€Ÿè´·æ”¶ç›Šåˆ°å¤æ‚çš„è‡ªåŠ¨åŒ–ç­–ç•¥ç»„åˆã€‚æˆ‘ä»¬å°†æ·±å…¥åˆ†æYearnã€Convexç­‰æ”¶ç›Šèšåˆå™¨çš„å·¥ä½œåŸç†ï¼Œç†è§£è‡ªåŠ¨å¤æŠ•çš„æ•°å­¦ä¼˜åŒ–ï¼Œæ¢è®¨è·¨é“¾æ”¶ç›Šå¥—åˆ©çš„æœºä¼šä¸é£é™©ã€‚æ›´é‡è¦çš„æ˜¯ï¼Œæˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•è¯„ä¼°ä¸åŒæ”¶ç›Šç­–ç•¥çš„é£é™©æ”¶ç›Šæ¯”ï¼Œæ„å»ºç¨³å¥çš„æ”¶ç›Šä¼˜åŒ–ç³»ç»Ÿã€‚</p>
        
        <div class="intro-box">
            <strong>æœ¬ç« æ¦‚è§ˆï¼š</strong>
            <ul>
                <li>ç¨³å®šå¸æ”¶ç›Šæ¥æºåˆ†ç±»ä¸é£é™©è¯„ä¼°</li>
                <li>æ”¶ç›Šèšåˆå™¨æ¶æ„ä¸è‡ªåŠ¨åŒ–ç­–ç•¥</li>
                <li>é«˜çº§æ”¶ç›Šä¼˜åŒ–æŠ€æœ¯ï¼ˆæ æ†æŒ–çŸ¿ã€deltaä¸­æ€§ï¼‰</li>
                <li>é£é™©è¯„ä¼°æ¨¡å‹ä¸å›æµ‹æ¡†æ¶</li>
                <li>AIé©±åŠ¨çš„åŠ¨æ€æ”¶ç›Šä¼˜åŒ–ç­–ç•¥</li>
            </ul>
        </div>

        <h3 id="yield-fundamentals">8.1 æ”¶ç›Šç­–ç•¥åŸºç¡€</h3>
        
        <h4>8.1.1 ç¨³å®šå¸æ”¶ç›Šæ¥æºåˆ†ç±»</h4>
        <div class="concept">
            <p><strong>æŒ‰ç¨³å®šå¸ç±»å‹åˆ†ç±»çš„æ”¶ç›Šæ¥æºï¼š</strong></p>
            
            <h5>1. æ³•å¸æŠµæŠ¼å‹ç¨³å®šå¸ï¼ˆUSDCã€USDTï¼‰</h5>
            <ul>
                <li><strong>é“¾ä¸‹å‚¨å¤‡æ”¶ç›Š</strong>ï¼š
                    <ul>
                        <li>ç¾å›½å›½å€ºæ”¶ç›Šï¼šå½“å‰5%+ï¼ˆ2024å¹´é«˜åˆ©ç‡ç¯å¢ƒï¼‰</li>
                        <li>å•†ä¸šç¥¨æ®æ”¶ç›Šï¼šé£é™©è°ƒæ•´å3-4%</li>
                        <li>æ¡ˆä¾‹ï¼šCircleå°†USDCå‚¨å¤‡100%æŠ•èµ„äºçŸ­æœŸç¾å€ºå’Œç°é‡‘</li>
                    </ul>
                </li>
                <li><strong>RWAï¼ˆçœŸå®ä¸–ç•Œèµ„äº§ï¼‰æ•´åˆ</strong>ï¼š
                    <ul>
                        <li>MakerDAOçš„RWAé‡‘åº“ï¼šé€šè¿‡Centrifugeç­‰åè®®æŠ•èµ„å®ä½“èµ„äº§</li>
                        <li>2024å¹´è¶‹åŠ¿ï¼šä»£å¸åŒ–ç¾å€ºï¼ˆå¦‚Ondo Financeçš„OUSGï¼‰</li>
                        <li>é£é™©ï¼šç›‘ç®¡åˆè§„ã€èµ„äº§éªŒè¯ã€æµåŠ¨æ€§é™åˆ¶</li>
                    </ul>
                </li>
            </ul>
            
            <div class="info-box" style="background-color: #e0f2fe; margin: 15px 0;">
                <h5>ğŸ“Š 2024å¹´RWAæ”¶ç›Šæ•°æ®æ´å¯Ÿ</h5>
                <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                    <tr>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">é¡¹ç›®</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">èµ„äº§ç±»å‹</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">APY</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">TVL</th>
                        <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">é£é™©ç­‰çº§</th>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">MakerDAO RWA</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ç¾å›½çŸ­æœŸå›½å€º</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">5.2%</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$3.2B</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ä½</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">Ondo Finance</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">OUSGï¼ˆå›½å€ºETFï¼‰</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">4.8%</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$180M</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ä½</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">Maple Finance</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ä¼ä¸šè´·æ¬¾</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">9-12%</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$150M</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ä¸­</td>
                    </tr>
                    <tr>
                        <td style="border: 1px solid #ddd; padding: 8px;">Centrifuge</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">èµ„äº§æ”¯æŒè¯åˆ¸</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">6-8%</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">$240M</td>
                        <td style="border: 1px solid #ddd; padding: 8px;">ä¸­</td>
                    </tr>
                </table>
                <p style="margin-top: 10px;"><strong>å…³é”®è¶‹åŠ¿ï¼š</strong>ä¼ ç»Ÿé‡‘èæœºæ„è¿›åœºï¼ŒBlackRockçš„BUIDLåŸºé‡‘åœ¨Ethereumä¸Šæ¨å‡ºï¼Œæ ‡å¿—ç€RWAæ­£å¼è¿›å…¥ä¸»æµã€‚</p>
            </div>
            
            <h5>2. åŠ å¯†èµ„äº§è¶…é¢æŠµæŠ¼å‹ï¼ˆDAIã€LUSDï¼‰</h5>
            <ul>
                <li><strong>ç¨³å®šè´¹/å€Ÿæ¬¾åˆ©æ¯</strong>ï¼š
                    <ul>
                        <li>DAIï¼šæ ¹æ®æŠµæŠ¼å“ç±»å‹2-8%å¹´åŒ–</li>
                        <li>LUSDï¼šä¸€æ¬¡æ€§0.5%é“¸é€ è´¹ï¼Œæ— æŒç»­åˆ©æ¯</li>
                        <li>æ”¶ç›Šåˆ†é…ï¼šDAIé€šè¿‡DSRè¿”è¿˜ï¼ŒLUSDé€šè¿‡LQTYè´¨æŠ¼</li>
                    </ul>
                </li>
                <li><strong>æ¸…ç®—ç½šé‡‘æ”¶ç›Š</strong>ï¼š
                    <ul>
                        <li>æ¸…ç®—äº‹ä»¶äº§ç”Ÿçš„ç½šé‡‘ï¼ˆé€šå¸¸10-13%ï¼‰</li>
                        <li>éƒ¨åˆ†å½’åè®®ï¼Œéƒ¨åˆ†å½’æ¸…ç®—äºº</li>
                    </ul>
                </li>
            </ul>
            
            <h5>3. ç®—æ³•ç¨³å®šå¸ï¼ˆå†å²æ•™è®­ï¼‰</h5>
            <ul>
                <li><strong>Seigniorageï¼ˆé“¸å¸ç¨ï¼‰æ¨¡å‹</strong>ï¼š
                    <ul>
                        <li>ç†è®ºï¼šæ‰©å¼ æ—¶é“¸é€ æ–°å¸åˆ†é…ç»™è´¨æŠ¼è€…</li>
                        <li>å¤±è´¥æ¡ˆä¾‹ï¼šBasis Cashã€Iron Finance</li>
                        <li>æ ¸å¿ƒç¼ºé™·ï¼šæ­»äº¡èºæ—‹é£é™©æ— æ³•é¿å…</li>
                    </ul>
                </li>
            </ul>
            
            <h5>4. DeFiåŸç”Ÿæ”¶ç›Š</h5>
            <ul>
                <li><strong>å€Ÿè´·åè®®</strong>ï¼š
                    <ul>
                        <li>åŸºç¡€åˆ©ç‡ï¼š2-5% APYï¼ˆå¸‚åœºä¾›éœ€å†³å®šï¼‰</li>
                        <li>åˆ©ç”¨ç‡é©±åŠ¨ï¼šé«˜éœ€æ±‚æ—¶å¯è¾¾20%+</li>
                        <li>é£é™©åˆ†å±‚ï¼šAaveçš„E-Modeã€éš”ç¦»æ¨¡å¼</li>
                    </ul>
                </li>
                <li><strong>æµåŠ¨æ€§æä¾›</strong>ï¼š
                    <ul>
                        <li>äº¤æ˜“è´¹ç”¨ï¼šCurveç¨³å®šå¸æ± 0.01-0.04%</li>
                        <li>æµåŠ¨æ€§æ¿€åŠ±ï¼šveCRV boostå¯è¾¾2.5x</li>
                        <li>æ— å¸¸æŸå¤±ï¼šç¨³å®šå¸å¯¹é€šå¸¸<0.1%</li>
                    </ul>
                </li>
                <li><strong>å¥—åˆ©æœºä¼š</strong>ï¼š
                    <ul>
                        <li>åˆ©ç‡å¥—åˆ©ï¼šè·¨åè®®åˆ©å·®ï¼ˆå¦‚Aave vs Compoundï¼‰</li>
                        <li>ä»·æ ¼å¥—åˆ©ï¼šç¨³å®šå¸è„±é”šå¥—åˆ©ï¼ˆå¦‚USDT 0.99ä¹°å…¥ï¼‰</li>
                        <li>é—ªç”µè´·å¥—åˆ©ï¼šé›¶èµ„æœ¬è¦æ±‚çš„åŸå­å¥—åˆ©</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <div class="info-box">
            <h4>ğŸ’¡ DSRï¼ˆDAI Savings Rateï¼‰æ·±åº¦è§£æ</h4>
            <p>DSRæ˜¯MakerDAOçš„æ ¸å¿ƒè´§å¸æ”¿ç­–å·¥å…·ï¼Œå…¶åˆ©ç‡å†³ç­–æœºåˆ¶ï¼š</p>
            <ul>
                <li><strong>ç›®æ ‡</strong>ï¼šç»´æŒDAIçš„1ç¾å…ƒé”šå®š</li>
                <li><strong>æœºåˆ¶</strong>ï¼šDAIä¾›è¿‡äºæ±‚æ—¶æé«˜DSRå¸å¼•æŒæœ‰ï¼›ä¾›ä¸åº”æ±‚æ—¶é™ä½DSR</li>
                <li><strong>èµ„é‡‘æ¥æº</strong>ï¼šç¨³å®šè´¹æ”¶å…¥ã€æ¸…ç®—ç½šé‡‘ã€RWAæ”¶ç›Š</li>
                <li><strong>2024å¹´åˆ›æ–°</strong>ï¼šEnhanced DSRï¼ˆsDAIï¼‰å®ç°è‡ªåŠ¨å¤åˆ©</li>
            </ul>
        </div>

        <h4>8.1.2 å¤šç»´åº¦é£é™©çŸ©é˜µ</h4>
        <div class="info-box">
            <h4>é£é™©ç»´åº¦åˆ†ææ¡†æ¶ï¼š</h4>
            
            <table class="risk-table">
                <tr>
                    <th>é£é™©ç±»å‹</th>
                    <th>æè¿°</th>
                    <th>è¯„ä¼°æŒ‡æ ‡</th>
                    <th>ç¼“è§£æªæ–½</th>
                </tr>
                <tr>
                    <td><strong>æŠ€æœ¯é£é™©</strong></td>
                    <td>
                        â€¢ æ™ºèƒ½åˆçº¦æ¼æ´<br>
                        â€¢ é¢„è¨€æœºæ“çºµ<br>
                        â€¢ è·¨é“¾æ¡¥æ•…éšœ
                    </td>
                    <td>
                        â€¢ å®¡è®¡æ•°é‡å’Œè´¨é‡<br>
                        â€¢ ä»£ç å¤æ‚åº¦<br>
                        â€¢ ä¾èµ–æ·±åº¦
                    </td>
                    <td>
                        â€¢ å¤šé‡å®¡è®¡<br>
                        â€¢ å½¢å¼åŒ–éªŒè¯<br>
                        â€¢ ä¿é™©è¦†ç›–
                    </td>
                </tr>
                <tr>
                    <td><strong>ç»æµæ¨¡å‹é£é™©</strong></td>
                    <td>
                        â€¢ è„±é”šé£é™©ï¼ˆDe-pegï¼‰<br>
                        â€¢ æ­»äº¡èºæ—‹<br>
                        â€¢ æŒ¤å…‘é£é™©
                    </td>
                    <td>
                        â€¢ å†å²æ³¢åŠ¨ç‡<br>
                        â€¢ æµåŠ¨æ€§æ·±åº¦<br>
                        â€¢ æŒä»“é›†ä¸­åº¦
                    </td>
                    <td>
                        â€¢ åŠ¨æ€è´¹ç‡è°ƒæ•´<br>
                        â€¢ ç´§æ€¥æš‚åœæœºåˆ¶<br>
                        â€¢ æµåŠ¨æ€§ç¼“å†²æ± 
                    </td>
                </tr>
                <tr>
                    <td><strong>æ²»ç†é£é™©</strong></td>
                    <td>
                        â€¢ æ¶æ„ææ¡ˆ<br>
                        â€¢ æŠ•ç¥¨æ”»å‡»<br>
                        â€¢ å‚æ•°æ“çºµ
                    </td>
                    <td>
                        â€¢ æŠ•ç¥¨é›†ä¸­åº¦<br>
                        â€¢ æ—¶é—´é”é•¿åº¦<br>
                        â€¢ å¤šç­¾è¦æ±‚
                    </td>
                    <td>
                        â€¢ æ—¶é—´é”å»¶è¿Ÿ<br>
                        â€¢ å¤šç­¾æ§åˆ¶<br>
                        â€¢ æŠ•ç¥¨é—¨æ§›
                    </td>
                </tr>
                <tr>
                    <td><strong>ç»„åˆæ€§é£é™©</strong></td>
                    <td>
                        â€¢ åº•å±‚åè®®å¤±è´¥<br>
                        â€¢ è¿é”æ¸…ç®—<br>
                        â€¢ ç³»ç»Ÿæ€§é£é™©ä¼ å¯¼
                    </td>
                    <td>
                        â€¢ ä¾èµ–åè®®æ•°é‡<br>
                        â€¢ TVLç›¸å…³æ€§<br>
                        â€¢ æ¸…ç®—é˜ˆå€¼
                    </td>
                    <td>
                        â€¢ åˆ†æ•£åŒ–éƒ¨ç½²<br>
                        â€¢ éš”ç¦»æ± è®¾è®¡<br>
                        â€¢ ç†”æ–­æœºåˆ¶
                    </td>
                </tr>
            </table>
            
            <h4 style="margin-top: 20px;">é£é™©è°ƒæ•´åæ”¶ç›Šåˆ†çº§ï¼š</h4>
            <table class="risk-table">
                <tr>
                    <th>ç­–ç•¥ç±»å‹</th>
                    <th>åä¹‰APY</th>
                    <th>é£é™©è¯„åˆ†</th>
                    <th>å¤æ™®æ¯”ç‡</th>
                    <th>æ¨èé…ç½®</th>
                </tr>
                <tr>
                    <td style="color: #22c55e;">ç¨³å¥å‹</td>
                    <td>3-6%</td>
                    <td>1-3</td>
                    <td>>2.0</td>
                    <td>40-60%</td>
                </tr>
                <tr>
                    <td style="color: #eab308;">å¹³è¡¡å‹</td>
                    <td>6-15%</td>
                    <td>4-6</td>
                    <td>1.0-2.0</td>
                    <td>20-40%</td>
                </tr>
                <tr>
                    <td style="color: #f97316;">è¿›å–å‹</td>
                    <td>15-30%</td>
                    <td>7-8</td>
                    <td>0.5-1.0</td>
                    <td>10-20%</td>
                </tr>
                <tr>
                    <td style="color: #dc2626;">æŠ•æœºå‹</td>
                    <td>30%+</td>
                    <td>9-10</td>
                    <td><0.5</td>
                    <td><10%</td>
                </tr>
            </table>
        </div>

        <h4>8.1.3 æ”¶ç›Šè®¡ç®—ä¸å¤åˆ©æ•ˆåº”</h4>
        <div class="concept">
            <h5>æ ¸å¿ƒæ¦‚å¿µç²¾ç¡®å®šä¹‰ï¼š</h5>
            <ul>
                <li><strong>APR (Annual Percentage Rate)</strong>ï¼šå¹´åŒ–åˆ©ç‡ï¼Œä¸è€ƒè™‘å¤åˆ©æ•ˆåº”</li>
                <li><strong>APY (Annual Percentage Yield)</strong>ï¼šå¹´åŒ–æ”¶ç›Šç‡ï¼Œè€ƒè™‘å¤åˆ©æ•ˆåº”</li>
                <li><strong>vAPR (Vector APR)</strong>ï¼šå¤šæºæ”¶ç›Šçš„å‘é‡è¡¨ç¤ºï¼Œå¦‚ vAPR = [äº¤æ˜“è´¹APR, æ¿€åŠ±APR, è´¿èµ‚APR]</li>
                <li><strong>è¿ç»­å¤åˆ©æé™</strong>ï¼šAPY = e^APR - 1ï¼ˆç†è®ºä¸Šç•Œï¼‰</li>
            </ul>
            
            <div class="formula" style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <p><strong>å¤åˆ©å…¬å¼æ¨å¯¼ï¼š</strong></p>
                <p>ç¦»æ•£å¤åˆ©ï¼šAPY = (1 + APR/n)^n - 1</p>
                <p>è¿ç»­å¤åˆ©ï¼šAPY = lim(nâ†’âˆ) [(1 + APR/n)^n - 1] = e^APR - 1</p>
                <p><strong>æœ€ä¼˜å¤åˆ©é¢‘ç‡ï¼š</strong>è€ƒè™‘Gasæˆæœ¬åçš„å‡€æ”¶ç›Šæœ€å¤§åŒ–</p>
                <p>Optimal n = argmax[Vâ‚€(1 + APR/n)^n - nÂ·GasCost - Vâ‚€]</p>
            </div>
        </div>
        
        <div class="code-section">
            <div class="code-header">
                <span class="code-title">é«˜çº§æ”¶ç›Šè®¡ç®—ä¸ä¼˜åŒ–</span>
                <button class="collapse-btn" onclick="toggleCode(this)">å±•å¼€</button>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-python">
import numpy as np
import pandas as pd
from typing import Dict, List, Tuple, Optional
from scipy.optimize import minimize_scalar

class AdvancedYieldCalculator:
    """é«˜çº§ç¨³å®šå¸æ”¶ç›Šè®¡ç®—å™¨"""
    
    @staticmethod
    def calculate_apy(apr: float, compounds_per_year: int = 365) -> float:
        """
        å°†APRè½¬æ¢ä¸ºAPYï¼ˆæ ‡å‡†å…¬å¼ï¼‰
        
        Args:
            apr: å¹´åŒ–ç™¾åˆ†æ¯”ç‡ (0.05 = 5%)
            compounds_per_year: æ¯å¹´å¤åˆ©æ¬¡æ•°
            
        Returns:
            apy: å¹´åŒ–ç™¾åˆ†æ¯”æ”¶ç›Šç‡
        """
        return (1 + apr / compounds_per_year) ** compounds_per_year - 1
    
    @staticmethod
    def continuous_compound_apy(apr: float) -> float:
        """è®¡ç®—è¿ç»­å¤åˆ©çš„APYï¼ˆç†è®ºä¸Šé™ï¼‰"""
        return np.exp(apr) - 1
    
    @staticmethod
    def calculate_vector_apr(yield_sources: Dict[str, float], 
                           weights: Optional[Dict[str, float]] = None) -> Dict[str, float]:
        """
        è®¡ç®—å¤šæºæ”¶ç›Šçš„å‘é‡APR
        
        Args:
            yield_sources: å„æ”¶ç›Šæ¥æºçš„APR
            weights: å„æ”¶ç›Šæºçš„æƒé‡ï¼ˆå¯é€‰ï¼‰
            
        Returns:
            ç»¼åˆæ”¶ç›ŠæŒ‡æ ‡
        """
        if weights is None:
            weights = {k: 1.0 for k in yield_sources.keys()}
        
        # è®¡ç®—åŠ æƒAPR
        weighted_apr = sum(apr * weights.get(source, 1.0) 
                          for source, apr in yield_sources.items())
        
        # è®¡ç®—å„ç»„æˆéƒ¨åˆ†è´¡çŒ®
        contributions = {
            source: apr * weights.get(source, 1.0) / weighted_apr 
            for source, apr in yield_sources.items()
        }
        
        return {
            'total_apr': weighted_apr,
            'components': yield_sources,
            'contributions': contributions,
            'risk_adjusted_apr': weighted_apr * 0.8  # ç®€åŒ–çš„é£é™©è°ƒæ•´
        }
    
    @staticmethod
    def optimal_compound_frequency(
        principal: float,
        apr: float,
        gas_cost_usd: float,
        gas_price_gwei: float = 30,
        eth_price: float = 2000
    ) -> Dict[str, float]:
        """
        è®¡ç®—è€ƒè™‘Gasæˆæœ¬çš„æœ€ä¼˜å¤åˆ©é¢‘ç‡
        
        Args:
            principal: æœ¬é‡‘ï¼ˆUSDï¼‰
            apr: å¹´åŒ–åˆ©ç‡
            gas_cost_usd: æ¯æ¬¡å¤åˆ©æ“ä½œçš„Gasæˆæœ¬
            gas_price_gwei: Gasä»·æ ¼
            eth_price: ETHä»·æ ¼
            
        Returns:
            æœ€ä¼˜å¤åˆ©é¢‘ç‡å’Œç›¸å…³æŒ‡æ ‡
        """
        def net_profit(compounds_per_year):
            if compounds_per_year < 1:
                return -float('inf')
            
            # å¤åˆ©æ”¶ç›Š
            gross_return = principal * ((1 + apr/compounds_per_year)**compounds_per_year - 1)
            
            # Gasæˆæœ¬
            total_gas_cost = compounds_per_year * gas_cost_usd
            
            # å‡€æ”¶ç›Š
            return gross_return - total_gas_cost
        
        # å¯»æ‰¾æœ€ä¼˜é¢‘ç‡
        result = minimize_scalar(
            lambda x: -net_profit(x),
            bounds=(1, 365),
            method='bounded'
        )
        
        optimal_frequency = int(result.x)
        optimal_net_return = -result.fun
        
        # è®¡ç®—ä¸åŒé¢‘ç‡ä¸‹çš„æ”¶ç›Šå¯¹æ¯”
        frequencies = [1, 12, 52, 365]  # å¹´ã€æœˆã€å‘¨ã€æ—¥
        comparisons = {}
        
        for freq in frequencies:
            gross = principal * ((1 + apr/freq)**freq - 1)
            gas = freq * gas_cost_usd
            net = gross - gas
            comparisons[f'{freq}x/year'] = {
                'gross_return': gross,
                'gas_cost': gas,
                'net_return': net,
                'net_apy': net / principal
            }
        
        return {
            'optimal_frequency': optimal_frequency,
            'optimal_interval_days': 365 / optimal_frequency,
            'optimal_net_apy': optimal_net_return / principal,
            'comparisons': comparisons,
            'break_even_principal': gas_cost_usd * 365 / apr  # ç›ˆäºå¹³è¡¡æœ¬é‡‘
        }
    
    @staticmethod
    def calculate_impermanent_loss(
        price_ratio: float,
        pool_type: str = "constant_product"
    ) -> float:
        """
        è®¡ç®—æ— å¸¸æŸå¤±
        
        Args:
            price_ratio: ä»·æ ¼å˜åŒ–æ¯”ç‡ (ç»“æŸä»·æ ¼/åˆå§‹ä»·æ ¼)
            pool_type: æ± ç±»å‹ (constant_product, stableswap)
            
        Returns:
            il: æ— å¸¸æŸå¤±ç™¾åˆ†æ¯”
        """
        if pool_type == "constant_product":
            # Uniswap V2å…¬å¼
            il = 2 * np.sqrt(price_ratio) / (1 + price_ratio) - 1
        elif pool_type == "stableswap":
            # Curveç¨³å®šå¸æ± è¿‘ä¼¼å…¬å¼
            # å¯¹äºç¨³å®šå¸ï¼Œä»·æ ¼åç¦»è¾ƒå°æ—¶ILæä½
            deviation = abs(price_ratio - 1)
            il = -0.5 * deviation ** 2 if deviation < 0.1 else None
        
        return il
    
    @staticmethod
    def calculate_leveraged_yield(
        base_apy: float,
        borrow_apy: float,
        leverage: float,
        liquidation_threshold: float = 0.75
    ) -> Dict[str, float]:
        """
        è®¡ç®—æ æ†æ”¶ç›Šç­–ç•¥çš„æ”¶ç›Šå’Œé£é™©
        
        Args:
            base_apy: åŸºç¡€å­˜æ¬¾æ”¶ç›Šç‡
            borrow_apy: å€Ÿæ¬¾åˆ©ç‡
            leverage: æ æ†å€æ•°
            liquidation_threshold: æ¸…ç®—é˜ˆå€¼
            
        Returns:
            ç»“æœå­—å…¸åŒ…å«ï¼šå‡€APYã€æ¸…ç®—ä»·æ ¼ç­‰
        """
        # å‡€æ”¶ç›Š = å­˜æ¬¾æ”¶ç›Š * æ æ† - å€Ÿæ¬¾æˆæœ¬ * (æ æ† - 1)
        gross_apy = base_apy * leverage
        borrow_cost = borrow_apy * (leverage - 1)
        net_apy = gross_apy - borrow_cost
        
        # è®¡ç®—æ¸…ç®—é£é™©
        # å‡è®¾æŠµæŠ¼å“ä»·å€¼ä¸‹è·ŒX%è§¦å‘æ¸…ç®—
        max_drawdown = (1 - liquidation_threshold) / leverage
        
        return {
            'net_apy': net_apy,
            'gross_apy': gross_apy,
            'borrow_cost': borrow_cost,
            'max_safe_drawdown': max_drawdown,
            'liquidation_price_ratio': 1 - max_drawdown
        }

# ç¤ºä¾‹ï¼šæ¯”è¾ƒä¸åŒç­–ç•¥
strategies = {
    'Aave USDC': {'apr': 0.03, 'risk': 'low'},
    'Curve 3pool LP': {'apr': 0.05, 'risk': 'medium'},
    'Convex staking': {'apr': 0.12, 'risk': 'medium'},
    'Leveraged farming': {'apr': 0.25, 'risk': 'high'}
}

calculator = YieldCalculator()

print("ç­–ç•¥æ”¶ç›Šå¯¹æ¯”ï¼ˆè€ƒè™‘æ—¥å¤åˆ©ï¼‰ï¼š")
print("-" * 60)
for name, params in strategies.items():
    apy = calculator.calculate_apy(params['apr'], 365)
    print(f"{name:20} | APR: {params['apr']*100:.1f}% | APY: {apy*100:.2f}% | é£é™©: {params['risk']}")

# æ æ†ç­–ç•¥åˆ†æ
print("\næ æ†ç­–ç•¥åˆ†æï¼š")
print("-" * 60)
leverages = [1.5, 2.0, 3.0]
for lev in leverages:
    result = calculator.calculate_leveraged_yield(
        base_apy=0.08,  # 8%åŸºç¡€æ”¶ç›Š
        borrow_apy=0.05,  # 5%å€Ÿæ¬¾æˆæœ¬
        leverage=lev
    )
    print(f"æ æ† {lev}x:")
    print(f"  å‡€APY: {result['net_apy']*100:.2f}%")
    print(f"  æœ€å¤§å®‰å…¨å›æ’¤: {result['max_safe_drawdown']*100:.1f}%")
    print(f"  æ¸…ç®—ä»·æ ¼æ¯”: {result['liquidation_price_ratio']:.3f}")
</code></pre>
            </div>
        </div>

        <h3 id="yield-aggregators">8.2 æ”¶ç›Šèšåˆå™¨æ¶æ„</h3>
        
        <h4>8.2.1 æ ¸å¿ƒç»„ä»¶è®¾è®¡æ¨¡å¼</h4>
        <div class="concept">
            <p><strong>æ”¶ç›Šèšåˆå™¨æ¶æ„çš„è®¾è®¡æ¨¡å¼è§£æï¼š</strong></p>
            
            <h5>1. é‡‘åº“ï¼ˆVaultï¼‰- å¤–è§‚æ¨¡å¼ï¼ˆFacade Patternï¼‰</h5>
            <ul>
                <li><strong>èŒè´£</strong>ï¼šç»Ÿä¸€çš„ç”¨æˆ·æ¥å£ï¼Œéšè—å†…éƒ¨å¤æ‚æ€§</li>
                <li><strong>æ ¸å¿ƒåŠŸèƒ½</strong>ï¼š
                    <ul>
                        <li>å­˜å–æ¬¾ç®¡ç†ï¼ˆdeposit/withdrawï¼‰</li>
                        <li>ä»½é¢ä»£å¸è®¡ç®—ï¼ˆERC-4626æ ‡å‡†ï¼‰</li>
                        <li>è´¹ç”¨æ”¶å–ä¸åˆ†é…</li>
                    </ul>
                </li>
                <li><strong>è®¾è®¡è¦ç‚¹</strong>ï¼šä¿æŒæ¥å£ç®€æ´ï¼Œå°†å¤æ‚é€»è¾‘å§”æ‰˜ç»™å­æ¨¡å—</li>
            </ul>
            
            <div class="example-box" style="background-color: #f0fdf4; margin: 15px 0;">
                <h5>ğŸ¯ ERC-4626çš„é©å‘½æ€§æ„ä¹‰</h5>
                <p><strong>ä¸ºä»€ä¹ˆERC-4626æ”¹å˜äº†æ”¶ç›Šèšåˆå™¨çš„æ¸¸æˆè§„åˆ™ï¼Ÿ</strong></p>
                <ul>
                    <li><strong>æ ‡å‡†åŒ–å‰ï¼ˆ2022å¹´ä»¥å‰ï¼‰</strong>ï¼š
                        <ul>
                            <li>æ¯ä¸ªåè®®è‡ªå®šä¹‰æ¥å£</li>
                            <li>é›†æˆæˆæœ¬é«˜ï¼Œæ˜“å‡ºé”™</li>
                            <li>æµåŠ¨æ€§ç¢ç‰‡åŒ–ä¸¥é‡</li>
                        </ul>
                    </li>
                    <li><strong>æ ‡å‡†åŒ–åï¼ˆERC-4626ï¼‰</strong>ï¼š
                        <ul>
                            <li>ç»Ÿä¸€çš„deposit/redeemæ¥å£</li>
                            <li>ä»½é¢è®¡ç®—æ ‡å‡†åŒ–ï¼ˆshares vs assetsï¼‰</li>
                            <li>å¯ç»„åˆæ€§å¤§å¹…æå‡</li>
                        </ul>
                    </li>
                </ul>
                <div class="formula" style="background: #f3f4f6; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <p><strong>æ ¸å¿ƒå…¬å¼ï¼š</strong></p>
                    <p>shares = assets Ã— totalSupply / totalAssets</p>
                    <p>assets = shares Ã— totalAssets / totalSupply</p>
                    <p><em>æ³¨ï¼šç²¾åº¦å¤„ç†å’Œèˆå…¥æ–¹å‘æ˜¯å®ç°çš„å…³é”®ç»†èŠ‚</em></p>
                </div>
            </div>
            
            <h5>2. ç­–ç•¥ï¼ˆStrategyï¼‰- ç­–ç•¥æ¨¡å¼ï¼ˆStrategy Patternï¼‰</h5>
            <ul>
                <li><strong>èŒè´£</strong>ï¼šå°è£…ç‰¹å®šçš„æ”¶ç›Šç”Ÿæˆé€»è¾‘</li>
                <li><strong>æ¥å£æ ‡å‡†</strong>ï¼š
                    <pre style="background: #f3f4f6; padding: 10px; border-radius: 5px;">
interface IStrategy {
    function harvest() external returns (uint256 profit);
    function totalAssets() external view returns (uint256);
    function withdraw(uint256 amount) external returns (uint256);
    function migrate(address newStrategy) external;
}</pre>
                </li>
                <li><strong>å®ç°ç¤ºä¾‹</strong>ï¼šAaveStrategyã€CompoundStrategyã€ConvexStrategy</li>
            </ul>
            
            <h5>3. æ§åˆ¶å™¨ï¼ˆControllerï¼‰- ä¸­ä»‹è€…æ¨¡å¼ï¼ˆMediator Patternï¼‰</h5>
            <ul>
                <li><strong>èŒè´£</strong>ï¼šåè°ƒVaultä¸å¤šä¸ªStrategyä¹‹é—´çš„äº¤äº’</li>
                <li><strong>æ ¸å¿ƒå†³ç­–</strong>ï¼š
                    <ul>
                        <li>èµ„é‡‘åˆ†é…ç®—æ³•ï¼ˆåŸºäºAPYã€é£é™©ã€Gasæˆæœ¬ï¼‰</li>
                        <li>å†å¹³è¡¡è§¦å‘æ¡ä»¶</li>
                        <li>é£é™©é™é¢ç®¡ç†</li>
                    </ul>
                </li>
            </ul>
            
            <h5>4. æ²»ç†ï¼ˆGovernanceï¼‰- è§‚å¯Ÿè€…æ¨¡å¼ï¼ˆObserver Patternï¼‰</h5>
            <ul>
                <li><strong>èŒè´£</strong>ï¼šå‚æ•°è°ƒæ•´ã€ç­–ç•¥ç™½åå•ã€ç´§æ€¥å“åº”</li>
                <li><strong>æ—¶é—´é”æœºåˆ¶</strong>ï¼šé˜²æ­¢æ¶æ„æ“ä½œ</li>
                <li><strong>å¤šç­¾è¦æ±‚</strong>ï¼šå…³é”®æ“ä½œéœ€è¦å¤šæ–¹ç¡®è®¤</li>
            </ul>
        </div>
        
        <div class="info-box">
            <h4>ğŸ“Š ä¸»æµèšåˆå™¨æ¶æ„å¯¹æ¯”</h4>
            <table class="comparison-table">
                <tr>
                    <th>ç‰¹æ€§</th>
                    <th>Yearn V3</th>
                    <th>Beefy Finance</th>
                    <th>Concentrator</th>
                </tr>
                <tr>
                    <td>æ ‡å‡†é‡‡ç”¨</td>
                    <td>ERC-4626</td>
                    <td>è‡ªå®šä¹‰</td>
                    <td>ERC-4626</td>
                </tr>
                <tr>
                    <td>å¤šé“¾æ”¯æŒ</td>
                    <td>æœ‰é™ï¼ˆä¸»è¦ETHï¼‰</td>
                    <td>20+æ¡é“¾</td>
                    <td>ä»¥å¤ªåŠä¸“æ³¨</td>
                </tr>
                <tr>
                    <td>è‡ªåŠ¨å¤æŠ•</td>
                    <td>Keeperç½‘ç»œ</td>
                    <td>ä»»ä½•äººå¯è§¦å‘</td>
                    <td>MEVæ‹å–</td>
                </tr>
                <tr>
                    <td>ç­–ç•¥å¤æ‚åº¦</td>
                    <td>é«˜ï¼ˆå¤šå±‚åµŒå¥—ï¼‰</td>
                    <td>ä¸­ï¼ˆå•ä¸€ç­–ç•¥ï¼‰</td>
                    <td>é«˜ï¼ˆConvexä¸“ç²¾ï¼‰</td>
                </tr>
                <tr>
                    <td>è´¹ç”¨ç»“æ„</td>
                    <td>2%ç®¡ç†+20%ç»©æ•ˆ</td>
                    <td>0%ç®¡ç†+4.5%ç»©æ•ˆ</td>
                    <td>10%ç»©æ•ˆ</td>
                </tr>
            </table>
        </div>

        <h4>8.2.2 Yearn V3æ¶æ„æ·±åº¦è§£æ</h4>
        <div class="code-section">
            <div class="code-header">
                <span class="code-title">Yearn V3é‡‘åº“å®ç°</span>
                <button class="collapse-btn" onclick="toggleCode(this)">å±•å¼€</button>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-solidity">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "@openzeppelin/contracts/token/ERC4626/ERC4626.sol";
import "@openzeppelin/contracts/security/ReentrancyGuard.sol";
import "@openzeppelin/contracts/access/AccessControl.sol";

/**
 * @title YieldVault
 * @notice åŸºäºERC4626çš„æ”¶ç›Šé‡‘åº“å®ç°
 * @dev æ”¯æŒå¤šç­–ç•¥ã€è‡ªåŠ¨å¤æŠ•ã€é£é™©ç®¡ç†
 */
contract YieldVault is ERC4626, ReentrancyGuard, AccessControl {
    using SafeERC20 for IERC20;
    
    // è§’è‰²å®šä¹‰
    bytes32 public constant STRATEGIST_ROLE = keccak256("STRATEGIST_ROLE");
    bytes32 public constant GUARDIAN_ROLE = keccak256("GUARDIAN_ROLE");
    bytes32 public constant KEEPER_ROLE = keccak256("KEEPER_ROLE");
    
    // ç­–ç•¥ç»“æ„
    struct Strategy {
        address implementation;     // ç­–ç•¥åˆçº¦åœ°å€
        uint256 debtRatio;         // ç­–ç•¥å€ºåŠ¡æ¯”ä¾‹ (BPS)
        uint256 lastReport;        // ä¸Šæ¬¡æŠ¥å‘Šæ—¶é—´
        uint256 totalDebt;         // ç­–ç•¥æ€»å€ºåŠ¡
        uint256 totalGain;         // ç´¯è®¡æ”¶ç›Š
        uint256 totalLoss;         // ç´¯è®¡æŸå¤±
        uint256 rateLimit;         // é€Ÿç‡é™åˆ¶
        bool active;               // æ˜¯å¦æ¿€æ´»
    }
    
    // çŠ¶æ€å˜é‡
    mapping(address => Strategy) public strategies;
    address[] public withdrawalQueue;  // ææ¬¾é˜Ÿåˆ—
    
    uint256 public totalDebtRatio;     // æ€»å€ºåŠ¡æ¯”ä¾‹
    uint256 public creditThreshold;    // ä¿¡è´·é˜ˆå€¼
    uint256 public lockedProfit;       // é”å®šåˆ©æ¶¦
    uint256 public lastReport;         // ä¸Šæ¬¡æŠ¥å‘Šæ—¶é—´
    uint256 public lockedProfitDegradation; // åˆ©æ¶¦é‡Šæ”¾é€Ÿç‡
    
    // è´¹ç”¨å‚æ•°
    uint256 public performanceFee = 1000;  // 10%ç»©æ•ˆè´¹
    uint256 public managementFee = 200;    // 2%ç®¡ç†è´¹
    address public feeRecipient;
    
    // å®‰å…¨å‚æ•°
    uint256 public emergencyShutdown;
    uint256 public depositLimit;
    
    // äº‹ä»¶
    event StrategyAdded(address indexed strategy, uint256 debtRatio);
    event StrategyReported(
        address indexed strategy,
        uint256 gain,
        uint256 loss,
        uint256 debtPaid,
        uint256 totalDebt
    );
    event EmergencyShutdown(bool active);
    
    constructor(
        IERC20 _asset,
        string memory _name,
        string memory _symbol
    ) ERC4626(_asset) ERC20(_name, _symbol) {
        _setupRole(DEFAULT_ADMIN_ROLE, msg.sender);
        _setupRole(STRATEGIST_ROLE, msg.sender);
        _setupRole(GUARDIAN_ROLE, msg.sender);
        
        lockedProfitDegradation = 1e18 / 86400; // 24å°æ—¶çº¿æ€§é‡Šæ”¾
    }
    
    /**
     * @notice æ·»åŠ æˆ–æ›´æ–°ç­–ç•¥
     * @param strategy ç­–ç•¥åœ°å€
     * @param debtRatio å€ºåŠ¡æ¯”ä¾‹ (BPS, max 10000)
     * @param rateLimit æ¯ä¸ªåŒºå—çš„é€Ÿç‡é™åˆ¶
     */
    function addStrategy(
        address strategy,
        uint256 debtRatio,
        uint256 rateLimit
    ) external onlyRole(STRATEGIST_ROLE) {
        require(strategy != address(0), "!zero");
        require(totalDebtRatio + debtRatio <= 10000, "!debtRatio");
        
        if (strategies[strategy].implementation == address(0)) {
            // æ–°ç­–ç•¥
            withdrawalQueue.push(strategy);
        }
        
        strategies[strategy] = Strategy({
            implementation: strategy,
            debtRatio: debtRatio,
            lastReport: block.timestamp,
            totalDebt: 0,
            totalGain: 0,
            totalLoss: 0,
            rateLimit: rateLimit,
            active: true
        });
        
        totalDebtRatio += debtRatio;
        emit StrategyAdded(strategy, debtRatio);
    }
    
    /**
     * @notice ç­–ç•¥æ”¶å‰²å’Œå†å¹³è¡¡
     * @param strategy è¦æ”¶å‰²çš„ç­–ç•¥
     * @return harvested æ”¶å‰²çš„æ”¶ç›Š
     */
    function harvest(address strategy) 
        external 
        onlyRole(KEEPER_ROLE)
        returns (uint256 harvested) 
    {
        Strategy storage strat = strategies[strategy];
        require(strat.active, "!active");
        
        // è®¡ç®—ç­–ç•¥åº”æœ‰çš„å€ºåŠ¡
        uint256 targetDebt = totalAssets() * strat.debtRatio / 10000;
        uint256 currentDebt = strat.totalDebt;
        
        // å‡†å¤‡ç»™ç­–ç•¥çš„ä¿¡è´·
        uint256 credit;
        if (targetDebt > currentDebt) {
            credit = Math.min(
                targetDebt - currentDebt,
                asset.balanceOf(address(this))
            );
        }
        
        // ç­–ç•¥æŠ¥å‘Š
        (uint256 gain, uint256 loss, uint256 debtPayment) = 
            IStrategy(strategy).report(credit);
        
        // æ›´æ–°ç­–ç•¥å€ºåŠ¡
        strat.totalDebt = strat.totalDebt + credit - debtPayment;
        strat.totalGain += gain;
        strat.totalLoss += loss;
        strat.lastReport = block.timestamp;
        
        // å¤„ç†æ”¶ç›Š
        if (gain > 0) {
            // æ”¶å–ç»©æ•ˆè´¹
            uint256 performanceFeeAmount = gain * performanceFee / 10000;
            if (performanceFeeAmount > 0 && feeRecipient != address(0)) {
                _mint(feeRecipient, convertToShares(performanceFeeAmount));
            }
            
            // é”å®šå‰©ä½™åˆ©æ¶¦ï¼Œçº¿æ€§é‡Šæ”¾
            lockedProfit += gain - performanceFeeAmount;
        }
        
        // å¤„ç†æŸå¤±
        if (loss > 0) {
            // ä»é”å®šåˆ©æ¶¦ä¸­æ‰£é™¤
            if (lockedProfit >= loss) {
                lockedProfit -= loss;
            } else {
                lockedProfit = 0;
            }
        }
        
        emit StrategyReported(strategy, gain, loss, debtPayment, strat.totalDebt);
        
        return gain;
    }
    
    /**
     * @notice è®¡ç®—æ€»èµ„äº§ï¼ˆåŒ…æ‹¬ç­–ç•¥ä¸­çš„èµ„äº§ï¼‰
     */
    function totalAssets() public view override returns (uint256) {
        uint256 total = asset.balanceOf(address(this));
        
        // åŠ ä¸Šæ‰€æœ‰ç­–ç•¥çš„å€ºåŠ¡
        for (uint256 i = 0; i < withdrawalQueue.length; i++) {
            Strategy memory strat = strategies[withdrawalQueue[i]];
            if (strat.active) {
                total += strat.totalDebt;
            }
        }
        
        // å‡å»é”å®šä½†æœªé‡Šæ”¾çš„åˆ©æ¶¦
        total -= _calculateLockedProfit();
        
        return total;
    }
    
    /**
     * @notice è®¡ç®—å½“å‰é”å®šçš„åˆ©æ¶¦
     */
    function _calculateLockedProfit() internal view returns (uint256) {
        if (lockedProfit == 0) return 0;
        
        uint256 timeSinceLastReport = block.timestamp - lastReport;
        uint256 degradation = lockedProfitDegradation * timeSinceLastReport;
        
        if (degradation >= 1e18) {
            return 0;
        } else {
            return lockedProfit * (1e18 - degradation) / 1e18;
        }
    }
    
    /**
     * @notice ç´§æ€¥å…³åœ
     */
    function setEmergencyShutdown(bool _shutdown) 
        external 
        onlyRole(GUARDIAN_ROLE) 
    {
        emergencyShutdown = _shutdown ? 1 : 0;
        emit EmergencyShutdown(_shutdown);
        
        if (_shutdown) {
            // å¬å›æ‰€æœ‰ç­–ç•¥èµ„é‡‘
            for (uint256 i = 0; i < withdrawalQueue.length; i++) {
                address strategy = withdrawalQueue[i];
                if (strategies[strategy].totalDebt > 0) {
                    IStrategy(strategy).emergencyWithdraw();
                }
            }
        }
    }
    
    /**
     * @notice ææ¬¾æ—¶çš„ç­–ç•¥èµ„é‡‘å¬å›
     */
    function _withdrawFromStrategies(uint256 amount) internal {
        uint256 withdrawn = 0;
        
        // æŒ‰ç…§ææ¬¾é˜Ÿåˆ—é¡ºåºå¬å›èµ„é‡‘
        for (uint256 i = 0; i < withdrawalQueue.length && withdrawn < amount; i++) {
            address strategy = withdrawalQueue[i];
            Strategy storage strat = strategies[strategy];
            
            if (!strat.active || strat.totalDebt == 0) continue;
            
            uint256 toWithdraw = Math.min(amount - withdrawn, strat.totalDebt);
            uint256 actualWithdrawn = IStrategy(strategy).withdraw(toWithdraw);
            
            strat.totalDebt -= actualWithdrawn;
            withdrawn += actualWithdrawn;
        }
        
        require(withdrawn >= amount, "!insufficient");
    }
}

/**
 * @title IStrategy
 * @notice ç­–ç•¥æ¥å£
 */
interface IStrategy {
    function report(uint256 credit) external returns (
        uint256 gain,
        uint256 loss,
        uint256 debtPayment
    );
    
    function withdraw(uint256 amount) external returns (uint256);
    
    function emergencyWithdraw() external;
    
    function estimatedTotalAssets() external view returns (uint256);
}

/**
 * @title ConvexStrategy
 * @notice Convex Financeç­–ç•¥ç¤ºä¾‹
 */
contract ConvexStrategy is IStrategy {
    using SafeERC20 for IERC20;
    
    YieldVault public immutable vault;
    IERC20 public immutable want;  // ç¨³å®šå¸
    
    // Convexç›¸å…³åˆçº¦
    IConvexBooster public constant booster = IConvexBooster(0xF403C135812408BFbE8713b5A23a04b3D48AAE31);
    IConvexRewards public rewardPool;
    uint256 public pid;  // Convexæ± ID
    
    // æ”¶ç›Šä»£å¸
    IERC20 public constant CRV = IERC20(0xD533a949740bb3306d119CC777fa900bA034cd52);
    IERC20 public constant CVX = IERC20(0x4e3FBD56CD56c3e72c1403e103b45Db9da5B9D2B);
    
    modifier onlyVault() {
        require(msg.sender == address(vault), "!vault");
        _;
    }
    
    constructor(
        address _vault,
        uint256 _pid
    ) {
        vault = YieldVault(_vault);
        want = IERC20(vault.asset());
        pid = _pid;
        
        // è·å–å¥–åŠ±æ± åœ°å€
        (,,,address _rewardPool,,) = booster.poolInfo(pid);
        rewardPool = IConvexRewards(_rewardPool);
        
        // æˆæƒ
        want.safeApprove(address(booster), type(uint256).max);
    }
    
    function estimatedTotalAssets() public view override returns (uint256) {
        return rewardPool.balanceOf(address(this));
    }
    
    function report(uint256 credit) external override onlyVault returns (
        uint256 gain,
        uint256 loss,
        uint256 debtPayment
    ) {
        // é¢†å–å¥–åŠ±
        if (rewardPool.earned(address(this)) > 0) {
            rewardPool.getReward(address(this), true);
        }
        
        // å–å‡ºå¥–åŠ±ä»£å¸
        uint256 crvBalance = CRV.balanceOf(address(this));
        uint256 cvxBalance = CVX.balanceOf(address(this));
        
        if (crvBalance > 0) {
            _sellCRV(crvBalance);
        }
        if (cvxBalance > 0) {
            _sellCVX(cvxBalance);
        }
        
        // è®¡ç®—æ”¶ç›Š
        uint256 totalAssets = estimatedTotalAssets();
        uint256 debt = vault.strategies(address(this)).totalDebt;
        
        if (totalAssets > debt) {
            gain = totalAssets - debt;
        } else if (totalAssets < debt) {
            loss = debt - totalAssets;
        }
        
        // å¤„ç†creditï¼ˆæ–°å¢æŠ•èµ„ï¼‰
        if (credit > 0) {
            want.safeTransferFrom(address(vault), address(this), credit);
            _deposit(credit);
        }
        
        // è¿”è¿˜å¤šä½™èµ„é‡‘
        uint256 wantBalance = want.balanceOf(address(this));
        if (wantBalance > 0) {
            want.safeTransfer(address(vault), wantBalance);
            debtPayment = wantBalance;
        }
    }
    
    function withdraw(uint256 amount) external override onlyVault returns (uint256) {
        uint256 balance = want.balanceOf(address(this));
        
        if (balance < amount) {
            uint256 toWithdraw = amount - balance;
            rewardPool.withdrawAndUnwrap(toWithdraw, false);
        }
        
        uint256 withdrawn = Math.min(amount, want.balanceOf(address(this)));
        want.safeTransfer(address(vault), withdrawn);
        
        return withdrawn;
    }
    
    function emergencyWithdraw() external override onlyVault {
        rewardPool.withdrawAndUnwrap(rewardPool.balanceOf(address(this)), false);
        want.safeTransfer(address(vault), want.balanceOf(address(this)));
    }
    
    function _deposit(uint256 amount) internal {
        booster.deposit(pid, amount, true);
    }
    
    function _sellCRV(uint256 amount) internal {
        // é€šè¿‡Curveæˆ–Uniswapå–å‡ºCRVæ¢å–wantä»£å¸
        // å®ç°ç•¥...
    }
    
    function _sellCVX(uint256 amount) internal {
        // é€šè¿‡DEXå–å‡ºCVXæ¢å–wantä»£å¸
        // å®ç°ç•¥...
    }
}
</code></pre>
            </div>
        </div>

        <h3 id="advanced-yield">8.3 é«˜çº§æ”¶ç›Šä¼˜åŒ–</h3>
        
        <h4>8.3.1 è‡ªåŠ¨å¤æŠ•æœºåˆ¶</h4>
        <div class="concept">
            <p><strong>å¤æŠ•ä¼˜åŒ–çš„å…³é”®è€ƒè™‘ï¼š</strong></p>
            <ul>
                <li><strong>è§¦å‘æ¡ä»¶</strong>ï¼š
                    <ul>
                        <li>æ—¶é—´è§¦å‘ï¼šå›ºå®šé—´éš”ï¼ˆå¦‚æ¯24å°æ—¶ï¼‰</li>
                        <li>é˜ˆå€¼è§¦å‘ï¼šæ”¶ç›Šè¾¾åˆ°æœ€å°å€¼</li>
                        <li>Gasä¼˜åŒ–è§¦å‘ï¼šè€ƒè™‘ç½‘ç»œæ‹¥å µ</li>
                    </ul>
                </li>
                <li><strong>æ‰¹é‡æ“ä½œ</strong>ï¼š
                    <ul>
                        <li>å¤šç­–ç•¥åˆå¹¶æ”¶å‰²</li>
                        <li>è·¯å¾„ä¼˜åŒ–å‡å°‘äº¤æ˜“æ¬¡æ•°</li>
                        <li>ä½¿ç”¨multicallæ‰¹é‡æ‰§è¡Œ</li>
                    </ul>
                </li>
                <li><strong>MEVä¿æŠ¤</strong>ï¼š
                    <ul>
                        <li>ä½¿ç”¨Flashbotsç§æœ‰æ± </li>
                        <li>æ—¶é—´éšæœºåŒ–</li>
                        <li>æœ€å°æ”¶ç›Šæ£€æŸ¥</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <div class="warning-box" style="background-color: #fef2f2; margin: 20px 0;">
            <h5>âš ï¸ è‡ªåŠ¨å¤æŠ•çš„éšè—é™·é˜±</h5>
            <p><strong>æ¡ˆä¾‹åˆ†æï¼š2023å¹´æŸæ”¶ç›Šèšåˆå™¨çš„å¤æŠ•æ”»å‡»</strong></p>
            <ul>
                <li><strong>æ”»å‡»æ‰‹æ³•</strong>ï¼š
                    <ul>
                        <li>æ”»å‡»è€…ç›‘æ§å¤æŠ•äº¤æ˜“æ¨¡å¼</li>
                        <li>åœ¨å¤æŠ•å‰å¤§é‡ä¹°å…¥æ”¶ç›Šä»£å¸</li>
                        <li>å¤æŠ•æ¨é«˜ä»·æ ¼åç«‹å³å–å‡º</li>
                        <li>æŸå¤±ï¼šç”¨æˆ·æ”¶ç›Šå‡å°‘15%</li>
                    </ul>
                </li>
                <li><strong>é˜²å¾¡æªæ–½</strong>ï¼š
                    <ul>
                        <li>TWAPä»·æ ¼æ£€æŸ¥</li>
                        <li>æ»‘ç‚¹ä¿æŠ¤ï¼ˆæœ€å¤§2%ï¼‰</li>
                        <li>å»¶è¿Ÿæ‰§è¡Œæœºåˆ¶</li>
                        <li>ç§æœ‰å†…å­˜æ± äº¤æ˜“</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <div class="info-box" style="background-color: #ecfdf5; margin: 20px 0;">
            <h5>ğŸ’¡ å¤æŠ•é¢‘ç‡çš„æ•°å­¦ä¼˜åŒ–</h5>
            <p><strong>å®è¯ç ”ç©¶ï¼šåŸºäº2024å¹´Ethereumä¸»ç½‘æ•°æ®</strong></p>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">æœ¬é‡‘è§„æ¨¡</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">Gasæˆæœ¬</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">æœ€ä¼˜é¢‘ç‡</th>
                    <th style="border: 1px solid #ddd; padding: 8px; background-color: #f3f4f6;">å‡€æ”¶ç›Šæå‡</th>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">$1,000</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">$20/æ¬¡</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">æ¯æœˆ1æ¬¡</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">+0.2%</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">$10,000</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">$20/æ¬¡</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">æ¯å‘¨1æ¬¡</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">+0.8%</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">$100,000</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">$20/æ¬¡</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">æ¯å¤©1æ¬¡</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">+1.2%</td>
                </tr>
                <tr>
                    <td style="border: 1px solid #ddd; padding: 8px;">$1,000,000+</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">$20/æ¬¡</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">æ¯8å°æ—¶</td>
                    <td style="border: 1px solid #ddd; padding: 8px;">+1.5%</td>
                </tr>
            </table>
            <p style="margin-top: 10px;"><strong>å…³é”®æ´å¯Ÿï¼š</strong>Layer 2çš„ä½æˆæœ¬ä½¿å¾—å°é¢èµ„é‡‘ä¹Ÿèƒ½å®ç°é«˜é¢‘å¤æŠ•ï¼ŒArbitrumä¸Š$1,000å³å¯å®ç°æ—¥å¤æŠ•ã€‚</p>
        </div>

        <h4>8.3.2 è·¨é“¾æ”¶ç›Šä¼˜åŒ–</h4>
        <div class="code-section">
            <div class="code-header">
                <span class="code-title">è·¨é“¾æ”¶ç›Šè·¯ç”±å™¨</span>
                <button class="collapse-btn" onclick="toggleCode(this)">å±•å¼€</button>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-solidity">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

import "@layerzerolabs/contracts/interfaces/ILayerZeroEndpoint.sol";
import "@openzeppelin/contracts/security/Pausable.sol";

/**
 * @title CrossChainYieldRouter
 * @notice è·¨é“¾æ”¶ç›Šä¼˜åŒ–è·¯ç”±å™¨
 * @dev è‡ªåŠ¨å¯»æ‰¾æœ€ä¼˜æ”¶ç›Šæœºä¼šå¹¶è·¨é“¾éƒ¨ç½²èµ„é‡‘
 */
contract CrossChainYieldRouter is Pausable {
    using SafeERC20 for IERC20;
    
    struct ChainInfo {
        uint16 chainId;           // LayerZeroé“¾ID
        address yieldVault;       // è¯¥é“¾ä¸Šçš„æ”¶ç›Šé‡‘åº“
        uint256 currentAPY;       // å½“å‰APYï¼ˆBPSï¼‰
        uint256 tvlCap;          // TVLä¸Šé™
        uint256 currentTVL;      // å½“å‰TVL
        bool active;             // æ˜¯å¦æ¿€æ´»
    }
    
    struct PendingRebalance {
        uint16 fromChain;
        uint16 toChain;
        uint256 amount;
        uint256 timestamp;
        bytes32 txHash;
    }
    
    // LayerZeroç«¯ç‚¹
    ILayerZeroEndpoint public immutable lzEndpoint;
    
    // é“¾ä¿¡æ¯æ˜ å°„
    mapping(uint16 => ChainInfo) public chains;
    uint16[] public supportedChains;
    
    // è·¨é“¾æ¶ˆæ¯ç±»å‹
    uint8 constant MSG_DEPOSIT = 1;
    uint8 constant MSG_WITHDRAW = 2;
    uint8 constant MSG_REBALANCE = 3;
    uint8 constant MSG_UPDATE_APY = 4;
    
    // å†å¹³è¡¡å‚æ•°
    uint256 public rebalanceThreshold = 200; // 2% APYå·®å¼‚è§¦å‘å†å¹³è¡¡
    uint256 public minRebalanceAmount = 10000e6; // æœ€å°å†å¹³è¡¡é‡‘é¢ $10k
    uint256 public rebalanceCooldown = 3600; // 1å°æ—¶å†·å´æœŸ
    mapping(bytes32 => uint256) public lastRebalance;
    
    // å¾…å¤„ç†çš„å†å¹³è¡¡
    mapping(bytes32 => PendingRebalance) public pendingRebalances;
    
    // Gasè´¹ç”¨ä¼°ç®—
    mapping(uint16 => uint256) public gasEstimates;
    
    event ChainAdded(uint16 indexed chainId, address yieldVault);
    event RebalanceInitiated(
        uint16 indexed fromChain,
        uint16 indexed toChain,
        uint256 amount,
        uint256 apyDiff
    );
    event RebalanceCompleted(bytes32 indexed rebalanceId);
    event APYUpdated(uint16 indexed chainId, uint256 newAPY);
    
    constructor(address _lzEndpoint) {
        lzEndpoint = ILayerZeroEndpoint(_lzEndpoint);
    }
    
    /**
     * @notice è®¡ç®—æœ€ä¼˜æ”¶ç›Šåˆ†é…
     * @return allocations æ¯æ¡é“¾çš„æœ€ä¼˜åˆ†é…æ¯”ä¾‹
     */
    function calculateOptimalAllocation() 
        public 
        view 
        returns (uint256[] memory allocations) 
    {
        uint256 totalTVL = 0;
        uint256[] memory availableSpace = new uint256[](supportedChains.length);
        uint256[] memory apys = new uint256[](supportedChains.length);
        
        // æ”¶é›†é“¾ä¿¡æ¯
        for (uint256 i = 0; i < supportedChains.length; i++) {
            ChainInfo memory chain = chains[supportedChains[i]];
            if (chain.active) {
                availableSpace[i] = chain.tvlCap > chain.currentTVL ? 
                    chain.tvlCap - chain.currentTVL : 0;
                apys[i] = chain.currentAPY;
                totalTVL += chain.currentTVL;
            }
        }
        
        allocations = new uint256[](supportedChains.length);
        
        // è´ªå¿ƒç®—æ³•ï¼šä¼˜å…ˆå¡«å……é«˜APYçš„é“¾
        uint256 remainingTVL = totalTVL;
        while (remainingTVL > 0) {
            uint256 bestChain = type(uint256).max;
            uint256 bestAPY = 0;
            
            // æ‰¾åˆ°æœ€é«˜APYä¸”æœ‰ç©ºé—´çš„é“¾
            for (uint256 i = 0; i < supportedChains.length; i++) {
                if (availableSpace[i] > 0 && apys[i] > bestAPY) {
                    bestAPY = apys[i];
                    bestChain = i;
                }
            }
            
            if (bestChain == type(uint256).max) break;
            
            // åˆ†é…èµ„é‡‘
            uint256 toAllocate = Math.min(availableSpace[bestChain], remainingTVL);
            allocations[bestChain] += toAllocate;
            availableSpace[bestChain] -= toAllocate;
            remainingTVL -= toAllocate;
        }
        
        return allocations;
    }
    
    /**
     * @notice æ£€æŸ¥å¹¶æ‰§è¡Œå†å¹³è¡¡
     * @param maxGasPrice æœ€å¤§å¯æ¥å—çš„gasä»·æ ¼
     */
    function checkAndRebalance(uint256 maxGasPrice) external {
        require(tx.gasprice <= maxGasPrice, "Gas price too high");
        
        uint256[] memory optimalAllocations = calculateOptimalAllocation();
        
        for (uint256 i = 0; i < supportedChains.length; i++) {
            uint16 fromChain = supportedChains[i];
            ChainInfo memory fromInfo = chains[fromChain];
            
            if (!fromInfo.active) continue;
            
            // è®¡ç®—éœ€è¦ç§»å‡ºçš„é‡‘é¢
            uint256 currentAllocation = fromInfo.currentTVL;
            uint256 targetAllocation = optimalAllocations[i];
            
            if (currentAllocation > targetAllocation + minRebalanceAmount) {
                // éœ€è¦ç§»å‡ºèµ„é‡‘
                uint256 toMove = currentAllocation - targetAllocation;
                
                // æ‰¾åˆ°æœ€ä½³ç›®æ ‡é“¾
                uint16 bestTarget = _findBestTargetChain(toMove, fromChain);
                
                if (bestTarget != 0) {
                    _initiateRebalance(fromChain, bestTarget, toMove);
                }
            }
        }
    }
    
    /**
     * @notice å‘èµ·è·¨é“¾å†å¹³è¡¡
     */
    function _initiateRebalance(
        uint16 fromChain,
        uint16 toChain,
        uint256 amount
    ) internal {
        // æ£€æŸ¥å†·å´æœŸ
        bytes32 pairKey = keccak256(abi.encodePacked(fromChain, toChain));
        require(
            block.timestamp >= lastRebalance[pairKey] + rebalanceCooldown,
            "Rebalance cooldown"
        );
        
        // è®¡ç®—è·¨é“¾æˆæœ¬
        uint256 estimatedCost = _estimateCrossChainCost(fromChain, toChain, amount);
        uint256 apyDiff = chains[toChain].currentAPY - chains[fromChain].currentAPY;
        uint256 expectedGain = amount * apyDiff / 10000 / 365; // æ—¥æ”¶ç›Šå·®
        
        require(expectedGain > estimatedCost * 10, "Rebalance not profitable");
        
        // æ„å»ºè·¨é“¾æ¶ˆæ¯
        bytes memory payload = abi.encode(
            MSG_REBALANCE,
            fromChain,
            toChain,
            amount,
            block.timestamp
        );
        
        // å‘é€è·¨é“¾æ¶ˆæ¯
        _lzSend(
            fromChain,
            payload,
            payable(msg.sender),
            address(0),
            bytes(""),
            msg.value
        );
        
        // è®°å½•å¾…å¤„ç†çš„å†å¹³è¡¡
        bytes32 rebalanceId = keccak256(payload);
        pendingRebalances[rebalanceId] = PendingRebalance({
            fromChain: fromChain,
            toChain: toChain,
            amount: amount,
            timestamp: block.timestamp,
            txHash: rebalanceId
        });
        
        lastRebalance[pairKey] = block.timestamp;
        
        emit RebalanceInitiated(fromChain, toChain, amount, apyDiff);
    }
    
    /**
     * @notice LayerZeroæ¥æ”¶å‡½æ•°
     */
    function lzReceive(
        uint16 _srcChainId,
        bytes calldata _srcAddress,
        uint64 _nonce,
        bytes calldata _payload
    ) external {
        require(msg.sender == address(lzEndpoint), "Invalid endpoint");
        
        uint8 msgType = uint8(bytes1(_payload[0:1]));
        
        if (msgType == MSG_UPDATE_APY) {
            _handleAPYUpdate(_srcChainId, _payload);
        } else if (msgType == MSG_REBALANCE) {
            _handleRebalance(_srcChainId, _payload);
        }
    }
    
    /**
     * @notice å¤„ç†APYæ›´æ–°
     */
    function _handleAPYUpdate(uint16 chainId, bytes calldata payload) internal {
        (, uint256 newAPY, uint256 newTVL) = abi.decode(
            payload,
            (uint8, uint256, uint256)
        );
        
        chains[chainId].currentAPY = newAPY;
        chains[chainId].currentTVL = newTVL;
        
        emit APYUpdated(chainId, newAPY);
    }
    
    /**
     * @notice ä¼°ç®—è·¨é“¾æˆæœ¬
     */
    function _estimateCrossChainCost(
        uint16 fromChain,
        uint16 toChain,
        uint256 amount
    ) internal view returns (uint256) {
        // LayerZeroè´¹ç”¨
        uint256 lzFee = gasEstimates[toChain] * tx.gasprice;
        
        // æ¡¥æ¥è´¹ç”¨ï¼ˆé€šå¸¸æ˜¯0.1%ï¼‰
        uint256 bridgeFee = amount * 10 / 10000;
        
        // ç›®æ ‡é“¾æ‰§è¡Œè´¹ç”¨
        uint256 executionFee = gasEstimates[toChain] * 1e9; // å‡è®¾10 Gwei
        
        return lzFee + bridgeFee + executionFee;
    }
}
</code></pre>
            </div>
        </div>

        <h4>8.3.3 Deltaä¸­æ€§ç­–ç•¥ä¸2024å¹´åˆ›æ–°</h4>
        <div class="info-box">
            <h4>Deltaä¸­æ€§ç­–ç•¥æ¼”è¿›ï¼šä»ä¼ ç»Ÿåˆ°LSTfi/LRTfi</h4>
            
            <h5>1. ä¼ ç»ŸDeltaä¸­æ€§ç­–ç•¥</h5>
            <div class="formula">
                <p><strong>æ„å»ºæ–¹å¼ï¼š</strong></p>
                <ul>
                    <li>ç°è´§æŒä»“ï¼š+1 ETHï¼ˆåœ¨Aaveä½œä¸ºæŠµæŠ¼å“ï¼‰</li>
                    <li>æ°¸ç»­åˆçº¦ï¼š-1 ETHï¼ˆåœ¨dYdX/GMXåšç©ºï¼‰</li>
                    <li>å‡€æ•å£ï¼š0ï¼ˆä»·æ ¼ä¸­æ€§ï¼‰</li>
                </ul>
                
                <p><strong>æ”¶ç›Šæ¥æºï¼š</strong></p>
                <ul>
                    <li>ç¨³å®šå¸å€Ÿè´·APYï¼š3-8%</li>
                    <li>èµ„é‡‘è´¹ç‡ï¼šç‰›å¸‚æ—¶10-50%å¹´åŒ–</li>
                    <li>åè®®æ¿€åŠ±ï¼šé¢å¤–2-5%</li>
                </ul>
            </div>
            
            <h5>2. LSTfi Deltaä¸­æ€§ï¼ˆæµåŠ¨æ€§è´¨æŠ¼ä»£å¸é‡‘èï¼‰</h5>
            <div class="concept">
                <p><strong>æ ¸å¿ƒåˆ›æ–°ï¼š</strong>åˆ©ç”¨é«˜åº¦ç›¸å…³èµ„äº§å¯¹é™ä½é£é™©</p>
                <ul>
                    <li><strong>èµ„äº§å¯¹é€‰æ‹©</strong>ï¼š
                        <ul>
                            <li>stETH/ETHï¼ˆç›¸å…³æ€§>0.99ï¼‰</li>
                            <li>rETH/ETHï¼ˆRocket Poolï¼‰</li>
                            <li>cbETH/ETHï¼ˆCoinbaseï¼‰</li>
                        </ul>
                    </li>
                    <li><strong>æ”¶ç›Šä¼˜åŠ¿</strong>ï¼š
                        <ul>
                            <li>è´¨æŠ¼æ”¶ç›Šï¼š4-5% ETHæœ¬ä½</li>
                            <li>LPè´¹ç”¨ï¼š0.05-0.3%</li>
                            <li>æä½æ— å¸¸æŸå¤±ï¼š<0.01%å¹´åŒ–</li>
                        </ul>
                    </li>
                    <li><strong>é£é™©ç‰¹å¾</strong>ï¼š
                        <ul>
                            <li>ç½šæ²¡é£é™©ï¼ˆslashingï¼‰ï¼šéªŒè¯è€…é”™è¯¯</li>
                            <li>æµåŠ¨æ€§é£é™©ï¼šææ¬¾å»¶è¿Ÿ</li>
                            <li>æ™ºèƒ½åˆçº¦é£é™©ï¼šLSTåè®®æ¼æ´</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <h5>3. LRTfi Deltaä¸­æ€§ï¼ˆæµåŠ¨æ€§å†è´¨æŠ¼ä»£å¸é‡‘èï¼‰</h5>
            <div class="warning-box">
                <p><strong>âš ï¸ å‰æ²¿ä½†é«˜é£é™©ï¼š</strong>EigenLayerç”Ÿæ€çš„æœ€æ–°å‘å±•</p>
                <ul>
                    <li><strong>å¤šé‡æ”¶ç›Šå åŠ </strong>ï¼š
                        <ul>
                            <li>ETHè´¨æŠ¼æ”¶ç›Šï¼š4-5%</li>
                            <li>å†è´¨æŠ¼æ”¶ç›Šï¼šé¢å¤–3-8%</li>
                            <li>AVSï¼ˆä¸»åŠ¨éªŒè¯æœåŠ¡ï¼‰å¥–åŠ±ï¼šå˜åŠ¨</li>
                        </ul>
                    </li>
                    <li><strong>é£é™©å åŠ æ•ˆåº”</strong>ï¼š
                        <ul>
                            <li>åŸºç¡€å±‚ç½šæ²¡é£é™©</li>
                            <li>AVSå±‚ç½šæ²¡é£é™©</li>
                            <li>æµåŠ¨æ€§æ–­è£‚é£é™©</li>
                        </ul>
                    </li>
                    <li><strong>ä»£è¡¨é¡¹ç›®</strong>ï¼š
                        <ul>
                            <li>Pendleï¼šæ”¶ç›Šä»£å¸åŒ–</li>
                            <li>Eigenpieï¼šLRTèšåˆå™¨</li>
                            <li>Renzoï¼šæµåŠ¨æ€§å†è´¨æŠ¼</li>
                        </ul>
                    </li>
                </ul>
            </div>
            
            <div class="example-box" style="background-color: #fff7ed; margin: 20px 0;">
                <h5>ğŸ“ˆ Pendleçš„åˆ›æ–°ï¼šæ”¶ç›Šä»£å¸åŒ–ä¸å›ºå®šæ”¶ç›Š</h5>
                <p><strong>å¦‚ä½•åœ¨æ³¢åŠ¨çš„DeFiä¸­åˆ›é€ å›ºå®šæ”¶ç›Šäº§å“ï¼Ÿ</strong></p>
                <ul>
                    <li><strong>PTï¼ˆPrincipal Tokenï¼‰</strong>ï¼šæœ¬é‡‘ä»£å¸
                        <ul>
                            <li>ä»£è¡¨åˆ°æœŸæ—¶çš„æœ¬é‡‘</li>
                            <li>ä»·æ ¼ = æœ¬é‡‘ Ã— æŠ˜ç°å› å­</li>
                            <li>æä¾›å›ºå®šæ”¶ç›Šï¼ˆå¦‚ä¹°å…¥0.95 PTï¼Œåˆ°æœŸè·å¾—1.0ï¼‰</li>
                        </ul>
                    </li>
                    <li><strong>YTï¼ˆYield Tokenï¼‰</strong>ï¼šæ”¶ç›Šä»£å¸
                        <ul>
                            <li>ä»£è¡¨æœŸé—´å†…çš„æ‰€æœ‰æ”¶ç›Š</li>
                            <li>ä»·æ ¼ = é¢„æœŸæ€»æ”¶ç›Šçš„ç°å€¼</li>
                            <li>æä¾›æ æ†æ”¶ç›Šæ•å£</li>
                        </ul>
                    </li>
                </ul>
                <div class="formula" style="background: #f3f4f6; padding: 10px; border-radius: 5px; margin: 10px 0;">
                    <p><strong>å®šä»·å…¬å¼ï¼š</strong></p>
                    <p>PTä»·æ ¼ = 1 / (1 + r)^t</p>
                    <p>YTä»·æ ¼ = âˆ«[0,T] y(t) Ã— e^(-rÃ—t) dt</p>
                    <p>å…¶ä¸­ï¼šr = æ— é£é™©åˆ©ç‡ï¼Œy(t) = é¢„æœŸæ”¶ç›Šç‡å‡½æ•°</p>
                </div>
                <p><strong>å®é™…æ¡ˆä¾‹ï¼ˆ2024å¹´Q1ï¼‰ï¼š</strong></p>
                <ul>
                    <li>stETH-PTï¼ˆ6ä¸ªæœˆï¼‰ï¼š5.2%å›ºå®šAPY</li>
                    <li>stETH-YTï¼š12-25%æ³¢åŠ¨APYï¼ˆå–å†³äºETHè´¨æŠ¼ç‡ï¼‰</li>
                    <li>å¸‚åœºè§„æ¨¡ï¼šTVLè¶…è¿‡$5B</li>
                </ul>
            </div>
        </div>
        
        <div class="code-section">
            <div class="code-header">
                <span class="code-title">Deltaä¸­æ€§ç­–ç•¥ç›‘æ§ä¸å†å¹³è¡¡</span>
                <button class="collapse-btn" onclick="toggleCode(this)">å±•å¼€</button>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-python">
import numpy as np
import pandas as pd
from typing import Dict, Tuple
from dataclasses import dataclass
import ccxt  # äº¤æ˜“æ‰€API
import asyncio

@dataclass
class Position:
    """æŒä»“ä¿¡æ¯"""
    asset: str
    amount: float
    entry_price: float
    current_price: float
    venue: str  # 'spot' or 'perp'
    
    @property
    def value(self) -> float:
        return self.amount * self.current_price
    
    @property
    def pnl(self) -> float:
        return (self.current_price - self.entry_price) * self.amount

class DeltaNeutralManager:
    """Deltaä¸­æ€§ç­–ç•¥ç®¡ç†å™¨"""
    
    def __init__(self, spot_venue: str, perp_venue: str):
        self.spot_venue = spot_venue
        self.perp_venue = perp_venue
        self.target_delta = 0.0
        self.rebalance_threshold = 0.05  # 5% deltaåç¦»è§¦å‘å†å¹³è¡¡
        
    def calculate_portfolio_delta(self, positions: List[Position]) -> float:
        """è®¡ç®—ç»„åˆçš„æ€»Deltaæ•å£"""
        total_delta = 0.0
        
        for pos in positions:
            if pos.venue == 'spot':
                # ç°è´§å¤šå¤´delta = +1
                total_delta += pos.amount
            elif pos.venue == 'perp':
                # æ°¸ç»­ç©ºå¤´delta = -1
                total_delta += pos.amount  # amountä¸ºè´Ÿè¡¨ç¤ºç©ºå¤´
                
        return total_delta
    
    def calculate_funding_pnl(self, 
                            funding_rate: float,
                            position_size: float,
                            hours: int = 8) -> float:
        """è®¡ç®—èµ„é‡‘è´¹ç‡æ”¶ç›Š"""
        # å¤§å¤šæ•°äº¤æ˜“æ‰€8å°æ—¶ç»“ç®—ä¸€æ¬¡
        periods = hours / 8
        return position_size * funding_rate * periods
    
    def check_rebalance_needed(self, positions: List[Position]) -> Tuple[bool, float]:
        """æ£€æŸ¥æ˜¯å¦éœ€è¦å†å¹³è¡¡"""
        current_delta = self.calculate_portfolio_delta(positions)
        delta_ratio = abs(current_delta) / sum(abs(p.amount) for p in positions)
        
        needs_rebalance = delta_ratio > self.rebalance_threshold
        return needs_rebalance, current_delta
    
    def calculate_rebalance_trades(self, 
                                 current_delta: float,
                                 spot_price: float,
                                 perp_price: float) -> Dict[str, float]:
        """è®¡ç®—å†å¹³è¡¡æ‰€éœ€çš„äº¤æ˜“"""
        # è®¡ç®—éœ€è¦è°ƒæ•´çš„æ•°é‡
        adjustment = -current_delta / 2  # å¹³åˆ†åˆ°ç°è´§å’Œæ°¸ç»­
        
        return {
            'spot_adjustment': adjustment,
            'perp_adjustment': -adjustment,
            'estimated_cost': abs(adjustment) * 0.001 * spot_price  # 0.1%æ»‘ç‚¹ä¼°è®¡
        }
    
    def monitor_lst_basis(self, lst_price: float, eth_price: float) -> Dict[str, float]:
        """ç›‘æ§LSTåŸºå·®ï¼ˆç”¨äºLSTfiç­–ç•¥ï¼‰"""
        basis = lst_price / eth_price - 1
        annualized_basis = basis * 365 / 7  # å‡è®¾7å¤©å¹³å‡å›å½’
        
        return {
            'current_basis': basis,
            'annualized_return': annualized_basis,
            'deviation_warning': abs(basis) > 0.02,  # 2%åç¦»è­¦å‘Š
            'suggested_action': 'increase' if basis > 0.01 else 'reduce' if basis < -0.01 else 'hold'
        }

# ä½¿ç”¨ç¤ºä¾‹
async def run_delta_neutral_strategy():
    manager = DeltaNeutralManager('aave', 'gmx')
    
    # æ¨¡æ‹ŸæŒä»“
    positions = [
        Position('ETH', 10, 2000, 2100, 'spot'),      # ç°è´§å¤šå¤´
        Position('ETH', -10, 2000, 2100, 'perp'),     # æ°¸ç»­ç©ºå¤´
        Position('stETH', 5, 1995, 2095, 'spot'),     # LSTæŒä»“
    ]
    
    # æ£€æŸ¥å†å¹³è¡¡
    needs_rebalance, current_delta = manager.check_rebalance_needed(positions)
    
    if needs_rebalance:
        trades = manager.calculate_rebalance_trades(current_delta, 2100, 2100)
        print(f"éœ€è¦å†å¹³è¡¡: Delta = {current_delta:.4f}")
        print(f"å»ºè®®äº¤æ˜“: {trades}")
    
    # ç›‘æ§LSTåŸºå·®
    lst_monitor = manager.monitor_lst_basis(2095, 2100)
    print(f"stETH/ETHåŸºå·®: {lst_monitor['current_basis']:.4%}")
    print(f"å¹´åŒ–æ”¶ç›Š: {lst_monitor['annualized_return']:.2%}")

# è¿è¡Œç¤ºä¾‹
# asyncio.run(run_delta_neutral_strategy())
</code></pre>
            </div>
        </div>

        <h3 id="risk-assessment">8.4 é£é™©è¯„ä¼°ä¸ç®¡ç†</h3>
        
        <h4>8.4.1 é‡åŒ–é£é™©æ¡†æ¶</h4>
        <div class="code-section">
            <div class="code-header">
                <span class="code-title">é£é™©è¯„ä¼°æ¨¡å‹</span>
                <button class="collapse-btn" onclick="toggleCode(this)">å±•å¼€</button>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-python">
import numpy as np
from dataclasses import dataclass
from typing import List, Dict, Tuple
from enum import Enum

class RiskType(Enum):
    SMART_CONTRACT = "æ™ºèƒ½åˆçº¦é£é™©"
    LIQUIDITY = "æµåŠ¨æ€§é£é™©"
    ORACLE = "é¢„è¨€æœºé£é™©"
    GOVERNANCE = "æ²»ç†é£é™©"
    ECONOMIC = "ç»æµæ¨¡å‹é£é™©"
    OPERATIONAL = "æ“ä½œé£é™©"

@dataclass
class RiskFactor:
    """é£é™©å› å­"""
    type: RiskType
    severity: float  # 0-1
    probability: float  # 0-1
    mitigation: str
    
    @property
    def score(self) -> float:
        """é£é™©åˆ†æ•° = ä¸¥é‡æ€§ Ã— æ¦‚ç‡"""
        return self.severity * self.probability

class YieldStrategyRiskAssessment:
    """æ”¶ç›Šç­–ç•¥é£é™©è¯„ä¼°æ¡†æ¶"""
    
    def __init__(self):
        self.risk_weights = {
            RiskType.SMART_CONTRACT: 0.3,
            RiskType.LIQUIDITY: 0.2,
            RiskType.ORACLE: 0.2,
            RiskType.GOVERNANCE: 0.1,
            RiskType.ECONOMIC: 0.15,
            RiskType.OPERATIONAL: 0.05
        }
    
    def calculate_var_cvar(self, returns: np.ndarray, confidence: float = 0.95) -> Dict[str, float]:
        """
        è®¡ç®—VaRï¼ˆé£é™©ä»·å€¼ï¼‰å’ŒCVaRï¼ˆæ¡ä»¶é£é™©ä»·å€¼ï¼‰
        
        Args:
            returns: å†å²æ”¶ç›Šç‡æ•°ç»„
            confidence: ç½®ä¿¡æ°´å¹³
            
        Returns:
            VaRå’ŒCVaRå€¼
        """
        # è®¡ç®—VaR
        var_percentile = (1 - confidence) * 100
        var = np.percentile(returns, var_percentile)
        
        # è®¡ç®—CVaRï¼ˆè¶…è¿‡VaRçš„å¹³å‡æŸå¤±ï¼‰
        cvar = returns[returns <= var].mean()
        
        return {
            'var': abs(var),
            'cvar': abs(cvar),
            'var_percentile': var_percentile,
            'worst_case': returns.min(),
            'risk_ratio': abs(cvar / var) if var != 0 else np.inf
        }
    
    def simulate_impermanent_loss(self, 
                                price_range: Tuple[float, float],
                                steps: int = 100) -> pd.DataFrame:
        """
        æ¨¡æ‹Ÿä¸åŒä»·æ ¼å˜åŒ–ä¸‹çš„æ— å¸¸æŸå¤±
        
        Args:
            price_range: ä»·æ ¼å˜åŒ–èŒƒå›´ï¼ˆå¦‚(0.5, 2.0)è¡¨ç¤º-50%åˆ°+100%ï¼‰
            steps: æ¨¡æ‹Ÿæ­¥æ•°
            
        Returns:
            åŒ…å«ä»·æ ¼æ¯”ç‡å’ŒILçš„DataFrame
        """
        price_ratios = np.linspace(price_range[0], price_range[1], steps)
        
        # è®¡ç®—ä¸åŒAMMçš„IL
        il_data = {
            'price_ratio': price_ratios,
            'uniswap_v2': [self._calculate_il_v2(r) for r in price_ratios],
            'stable_swap': [self._calculate_il_stable(r) for r in price_ratios],
            'uniswap_v3_narrow': [self._calculate_il_v3(r, 0.99, 1.01) for r in price_ratios],
            'uniswap_v3_wide': [self._calculate_il_v3(r, 0.95, 1.05) for r in price_ratios]
        }
        
        return pd.DataFrame(il_data)
    
    def _calculate_il_v2(self, price_ratio: float) -> float:
        """Uniswap V2æ— å¸¸æŸå¤±å…¬å¼"""
        return 2 * np.sqrt(price_ratio) / (1 + price_ratio) - 1
    
    def _calculate_il_stable(self, price_ratio: float) -> float:
        """ç¨³å®šå¸æ± è¿‘ä¼¼æ— å¸¸æŸå¤±"""
        deviation = abs(price_ratio - 1)
        if deviation < 0.1:  # 10%ä»¥å†…ä½¿ç”¨äºŒæ¬¡è¿‘ä¼¼
            return -0.5 * deviation ** 2
        else:
            # è¶…è¿‡10%ä½¿ç”¨æ ‡å‡†å…¬å¼
            return self._calculate_il_v2(price_ratio)
    
    def _calculate_il_v3(self, price_ratio: float, 
                        lower_bound: float, upper_bound: float) -> float:
        """Uniswap V3é›†ä¸­æµåŠ¨æ€§ILï¼ˆç®€åŒ–ï¼‰"""
        if lower_bound <= price_ratio <= upper_bound:
            # åœ¨èŒƒå›´å†…ï¼ŒILæ¥è¿‘V2
            return self._calculate_il_v2(price_ratio)
        else:
            # è¶…å‡ºèŒƒå›´ï¼Œå…¨éƒ¨è½¬æ¢ä¸ºå•ä¸€èµ„äº§
            return -1.0 if price_ratio < lower_bound else -0.5
    
    def assess_depeg_risk(self, 
                         stablecoin: str,
                         collateral_ratio: float,
                         liquidity_depth: float,
                         concentration: float) -> Dict[str, float]:
        """
        è¯„ä¼°ç¨³å®šå¸è„±é”šé£é™©
        
        Args:
            stablecoin: ç¨³å®šå¸åç§°
            collateral_ratio: æŠµæŠ¼ç‡
            liquidity_depth: æµåŠ¨æ€§æ·±åº¦ï¼ˆUSDï¼‰
            concentration: æŒä»“é›†ä¸­åº¦ï¼ˆå‰10åœ°å€å æ¯”ï¼‰
            
        Returns:
            è„±é”šé£é™©è¯„åˆ†
        """
        # åŸºç¡€é£é™©åˆ†æ•°
        base_score = 0.0
        
        # æŠµæŠ¼ç‡è¯„åˆ†ï¼ˆè¶Šé«˜è¶Šå®‰å…¨ï¼‰
        if collateral_ratio < 1.0:
            base_score += 50  # éƒ¨åˆ†å‚¨å¤‡é«˜é£é™©
        elif collateral_ratio < 1.5:
            base_score += 20  # ç•¥å¾®è¶…é¢æŠµæŠ¼
        else:
            base_score += 5   # å……åˆ†è¶…é¢æŠµæŠ¼
            
        # æµåŠ¨æ€§è¯„åˆ†ï¼ˆè¶Šæ·±è¶Šå®‰å…¨ï¼‰
        if liquidity_depth < 10e6:  # <$10M
            base_score += 30
        elif liquidity_depth < 100e6:  # <$100M
            base_score += 15
        else:
            base_score += 5
            
        # é›†ä¸­åº¦è¯„åˆ†ï¼ˆè¶Šåˆ†æ•£è¶Šå®‰å…¨ï¼‰
        if concentration > 0.5:  # >50%
            base_score += 20
        elif concentration > 0.3:  # >30%
            base_score += 10
        else:
            base_score += 5
            
        # ç‰¹å®šç¨³å®šå¸è°ƒæ•´
        stablecoin_factors = {
            'USDT': 1.2,    # å†å²ä¸é€æ˜
            'USDC': 0.8,    # ç›‘ç®¡åˆè§„
            'DAI': 1.0,     # å»ä¸­å¿ƒåŒ–
            'FRAX': 1.3,    # éƒ¨åˆ†ç®—æ³•
            'LUSD': 0.9     # è¶…é¢æŠµæŠ¼
        }
        
        factor = stablecoin_factors.get(stablecoin.upper(), 1.0)
        final_score = base_score * factor
        
        return {
            'depeg_risk_score': final_score,
            'risk_level': self._score_to_level(final_score),
            'collateral_contribution': base_score * 0.5,
            'liquidity_contribution': base_score * 0.3,
            'concentration_contribution': base_score * 0.2,
            'recommendation': self._get_depeg_recommendation(final_score)
        }
    
    def _score_to_level(self, score: float) -> str:
        """å°†åˆ†æ•°è½¬æ¢ä¸ºé£é™©ç­‰çº§"""
        if score < 20:
            return "ä½é£é™©"
        elif score < 40:
            return "ä¸­ä½é£é™©"
        elif score < 60:
            return "ä¸­é£é™©"
        elif score < 80:
            return "é«˜é£é™©"
        else:
            return "æé«˜é£é™©"
    
    def _get_depeg_recommendation(self, score: float) -> str:
        """åŸºäºé£é™©åˆ†æ•°çš„å»ºè®®"""
        if score < 20:
            return "é€‚åˆä½œä¸ºä¸»è¦å‚¨å¤‡èµ„äº§"
        elif score < 40:
            return "å¯ä»¥æŒæœ‰ï¼Œå»ºè®®åˆ†æ•£é…ç½®"
        elif score < 60:
            return "è°¨æ…æŒæœ‰ï¼Œè®¾ç½®æ­¢æŸ"
        else:
            return "ä¸å»ºè®®æŒæœ‰ï¼Œå¯»æ‰¾æ›¿ä»£å“"
    
    def assess_strategy_risk(
        self,
        protocol_name: str,
        tvl: float,
        age_days: int,
        audit_score: float,
        complexity_score: float
    ) -> Dict:
        """
        è¯„ä¼°ç­–ç•¥æ•´ä½“é£é™©
        
        Args:
            protocol_name: åè®®åç§°
            tvl: æ€»é”ä»“ä»·å€¼ï¼ˆUSDï¼‰
            age_days: åè®®è¿è¡Œå¤©æ•°
            audit_score: å®¡è®¡åˆ†æ•°ï¼ˆ0-10ï¼‰
            complexity_score: å¤æ‚åº¦åˆ†æ•°ï¼ˆ0-10ï¼‰
        """
        risk_factors = []
        
        # æ™ºèƒ½åˆçº¦é£é™©è¯„ä¼°
        contract_risk_score = self._assess_smart_contract_risk(
            age_days, audit_score, complexity_score
        )
        risk_factors.append(RiskFactor(
            type=RiskType.SMART_CONTRACT,
            severity=0.9,  # åˆçº¦é£é™©é€šå¸¸å¾ˆä¸¥é‡
            probability=contract_risk_score,
            mitigation="å¤šé‡å®¡è®¡ã€å½¢å¼åŒ–éªŒè¯ã€ä¿é™©è¦†ç›–"
        ))
        
        # æµåŠ¨æ€§é£é™©è¯„ä¼°
        liquidity_risk_score = self._assess_liquidity_risk(tvl)
        risk_factors.append(RiskFactor(
            type=RiskType.LIQUIDITY,
            severity=0.7,
            probability=liquidity_risk_score,
            mitigation="åˆ†æ•£æŠ•èµ„ã€è®¾ç½®ææ¬¾é™åˆ¶ã€ç»´æŒç¼“å†²èµ„é‡‘"
        ))
        
        # é¢„è¨€æœºé£é™©è¯„ä¼°
        oracle_risk_score = self._assess_oracle_risk(protocol_name)
        risk_factors.append(RiskFactor(
            type=RiskType.ORACLE,
            severity=0.8,
            probability=oracle_risk_score,
            mitigation="å¤šé¢„è¨€æœºèšåˆã€TWAPã€ç†”æ–­æœºåˆ¶"
        ))
        
        # è®¡ç®—ç»¼åˆé£é™©åˆ†æ•°
        total_risk_score = self._calculate_total_risk(risk_factors)
        
        # é£é™©ç­‰çº§åˆ¤å®š
        risk_level = self._determine_risk_level(total_risk_score)
        
        # å»ºè®®é…ç½®æ¯”ä¾‹
        suggested_allocation = self._suggest_allocation(total_risk_score)
        
        return {
            'protocol': protocol_name,
            'risk_factors': risk_factors,
            'total_risk_score': total_risk_score,
            'risk_level': risk_level,
            'suggested_allocation': suggested_allocation,
            'risk_adjusted_apy': self._calculate_risk_adjusted_return(
                base_apy=0.15,  # å‡è®¾15%åŸºç¡€APY
                risk_score=total_risk_score
            )
        }
    
    def _assess_smart_contract_risk(
        self,
        age_days: int,
        audit_score: float,
        complexity_score: float
    ) -> float:
        """è¯„ä¼°æ™ºèƒ½åˆçº¦é£é™©æ¦‚ç‡"""
        # åŸºç¡€é£é™©
        base_risk = 0.3
        
        # æ ¹æ®è¿è¡Œæ—¶é—´è°ƒæ•´ï¼ˆLindyæ•ˆåº”ï¼‰
        if age_days < 30:
            time_factor = 2.0
        elif age_days < 180:
            time_factor = 1.5
        elif age_days < 365:
            time_factor = 1.2
        else:
            time_factor = 0.8
        
        # æ ¹æ®å®¡è®¡åˆ†æ•°è°ƒæ•´
        audit_factor = (10 - audit_score) / 10
        
        # æ ¹æ®å¤æ‚åº¦è°ƒæ•´
        complexity_factor = complexity_score / 10
        
        risk_probability = base_risk * time_factor * audit_factor * (1 + complexity_factor)
        
        return min(risk_probability, 1.0)
    
    def _assess_liquidity_risk(self, tvl: float) -> float:
        """è¯„ä¼°æµåŠ¨æ€§é£é™©"""
        # TVLè¶Šä½ï¼ŒæµåŠ¨æ€§é£é™©è¶Šé«˜
        if tvl < 1e6:  # < $1M
            return 0.8
        elif tvl < 10e6:  # < $10M
            return 0.5
        elif tvl < 100e6:  # < $100M
            return 0.3
        elif tvl < 1e9:  # < $1B
            return 0.1
        else:
            return 0.05
    
    def _assess_oracle_risk(self, protocol_name: str) -> float:
        """è¯„ä¼°é¢„è¨€æœºé£é™©"""
        # ç®€åŒ–ç¤ºä¾‹ï¼šæ ¹æ®åè®®ä½¿ç”¨çš„é¢„è¨€æœºç±»å‹
        chainlink_protocols = ['aave', 'compound', 'maker']
        internal_oracle_protocols = ['curve', 'uniswap']
        
        if protocol_name.lower() in chainlink_protocols:
            return 0.1  # Chainlinkç›¸å¯¹å®‰å…¨
        elif protocol_name.lower() in internal_oracle_protocols:
            return 0.3  # å†…éƒ¨é¢„è¨€æœºé£é™©è¾ƒé«˜
        else:
            return 0.5  # æœªçŸ¥é¢„è¨€æœºé£é™©
    
    def _calculate_total_risk(self, risk_factors: List[RiskFactor]) -> float:
        """è®¡ç®—åŠ æƒæ€»é£é™©åˆ†æ•°"""
        total_score = 0
        
        for factor in risk_factors:
            weight = self.risk_weights.get(factor.type, 0.1)
            total_score += factor.score * weight
        
        return total_score
    
    def _determine_risk_level(self, risk_score: float) -> str:
        """ç¡®å®šé£é™©ç­‰çº§"""
        if risk_score < 0.2:
            return "ä½é£é™©"
        elif risk_score < 0.4:
            return "ä¸­ä½é£é™©"
        elif risk_score < 0.6:
            return "ä¸­é£é™©"
        elif risk_score < 0.8:
            return "é«˜é£é™©"
        else:
            return "æé«˜é£é™©"
    
    def _suggest_allocation(self, risk_score: float) -> float:
        """å»ºè®®é…ç½®æ¯”ä¾‹"""
        # åå‘å…³ç³»ï¼šé£é™©è¶Šé«˜ï¼Œå»ºè®®é…ç½®è¶Šä½
        if risk_score < 0.2:
            return 0.4  # æœ€å¤š40%
        elif risk_score < 0.4:
            return 0.25
        elif risk_score < 0.6:
            return 0.15
        elif risk_score < 0.8:
            return 0.05
        else:
            return 0  # ä¸å»ºè®®é…ç½®
    
    def _calculate_risk_adjusted_return(
        self,
        base_apy: float,
        risk_score: float
    ) -> float:
        """è®¡ç®—é£é™©è°ƒæ•´åæ”¶ç›Šç‡ï¼ˆç±»ä¼¼å¤æ™®æ¯”ç‡ï¼‰"""
        # å‡è®¾æ— é£é™©åˆ©ç‡ä¸º2%
        risk_free_rate = 0.02
        
        # é£é™©è°ƒæ•´
        # é£é™©è¶Šé«˜ï¼Œè¦æ±‚çš„é£é™©æº¢ä»·è¶Šé«˜
        risk_premium = (base_apy - risk_free_rate) * (1 - risk_score)
        
        return risk_free_rate + risk_premium

# ç¤ºä¾‹ï¼šè¯„ä¼°ä¸åŒåè®®
assessor = YieldStrategyRiskAssessment()

protocols = [
    {
        'name': 'Aave',
        'tvl': 5e9,
        'age_days': 1000,
        'audit_score': 9,
        'complexity_score': 6
    },
    {
        'name': 'NewDeFi',
        'tvl': 5e6,
        'age_days': 30,
        'audit_score': 7,
        'complexity_score': 8
    },
    {
        'name': 'CurveFinance',
        'tvl': 3e9,
        'age_days': 800,
        'audit_score': 8.5,
        'complexity_score': 9
    }
]

print("æ”¶ç›Šç­–ç•¥é£é™©è¯„ä¼°æŠ¥å‘Š")
print("=" * 80)

for protocol in protocols:
    result = assessor.assess_strategy_risk(**protocol)
    
    print(f"\nåè®®: {result['protocol']}")
    print(f"é£é™©ç­‰çº§: {result['risk_level']}")
    print(f"æ€»é£é™©åˆ†æ•°: {result['total_risk_score']:.3f}")
    print(f"å»ºè®®é…ç½®æ¯”ä¾‹: {result['suggested_allocation']*100:.1f}%")
    print(f"é£é™©è°ƒæ•´åAPY: {result['risk_adjusted_apy']*100:.2f}%")
    
    print("\né£é™©å› å­æ˜ç»†:")
    for factor in result['risk_factors']:
        print(f"  - {factor.type.value}: åˆ†æ•°={factor.score:.3f}, "
              f"ä¸¥é‡æ€§={factor.severity:.1f}, æ¦‚ç‡={factor.probability:.2f}")
        print(f"    ç¼“è§£æªæ–½: {factor.mitigation}")

# ç»„åˆé£é™©åˆ†æ
print("\n" + "="*80)
print("ç»„åˆé…ç½®å»ºè®®ï¼š")

total_allocation = sum(result['suggested_allocation'] for result in 
                      [assessor.assess_strategy_risk(**p) for p in protocols])

for protocol in protocols:
    result = assessor.assess_strategy_risk(**protocol)
    normalized_allocation = result['suggested_allocation'] / total_allocation
    print(f"{protocol['name']:15} {normalized_allocation*100:>6.1f}%")
</code></pre>
            </div>
        </div>

        <h4>8.4.2 å®æ—¶ç›‘æ§ä¸é¢„è­¦ç³»ç»Ÿ</h4>
        <div class="code-section">
            <div class="code-header">
                <span class="code-title">æ”¶ç›Šç›‘æ§åˆçº¦</span>
                <button class="collapse-btn" onclick="toggleCode(this)">å±•å¼€</button>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-solidity">
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

/**
 * @title YieldMonitor
 * @notice å®æ—¶ç›‘æ§æ”¶ç›Šç­–ç•¥å¥åº·åº¦
 */
contract YieldMonitor {
    using SafeMath for uint256;
    
    struct StrategyHealth {
        uint256 targetAPY;        // ç›®æ ‡APY
        uint256 actualAPY;        // å®é™…APY
        uint256 tvl;              // æ€»é”ä»“ä»·å€¼
        uint256 utilizationRate;  // èµ„é‡‘åˆ©ç”¨ç‡
        uint256 lastUpdate;       // æœ€åæ›´æ–°æ—¶é—´
        bool isHealthy;           // å¥åº·çŠ¶æ€
        uint256 riskScore;        // é£é™©åˆ†æ•°(0-10000)
    }
    
    struct Alert {
        uint256 timestamp;
        AlertType alertType;
        address strategy;
        string message;
        uint256 severity;  // 1-5
    }
    
    enum AlertType {
        APY_DEVIATION,      // APYåç¦»
        TVL_DRAIN,          // TVLå¿«é€Ÿä¸‹é™
        UTILIZATION_LOW,    // åˆ©ç”¨ç‡è¿‡ä½
        RISK_INCREASE,      // é£é™©ä¸Šå‡
        CONTRACT_PAUSED,    // åˆçº¦æš‚åœ
        ORACLE_FAILURE      // é¢„è¨€æœºæ•…éšœ
    }
    
    mapping(address => StrategyHealth) public strategies;
    Alert[] public alerts;
    
    // é˜ˆå€¼å‚æ•°
    uint256 public apyDeviationThreshold = 2000;  // 20%åç¦»è§¦å‘è­¦æŠ¥
    uint256 public tvlDrainThreshold = 1000;      // 10%å¿«é€Ÿæµå¤±è§¦å‘è­¦æŠ¥
    uint256 public minUtilizationRate = 5000;     // 50%æœ€ä½åˆ©ç”¨ç‡
    uint256 public maxRiskScore = 7000;           // 70é£é™©åˆ†æ•°ä¸Šé™
    
    // ç›‘æ§å‚æ•°
    mapping(address => uint256) public lastTVL;
    mapping(address => uint256) public tvlCheckpoint;
    
    event HealthUpdate(address indexed strategy, bool isHealthy, uint256 riskScore);
    event AlertRaised(address indexed strategy, AlertType alertType, uint256 severity);
    
    /**
     * @notice æ›´æ–°ç­–ç•¥å¥åº·çŠ¶æ€
     */
    function updateStrategyHealth(
        address strategy,
        uint256 actualAPY,
        uint256 tvl,
        uint256 utilizationRate
    ) external {
        StrategyHealth storage health = strategies[strategy];
        
        // æ£€æŸ¥APYåç¦»
        if (health.targetAPY > 0) {
            uint256 deviation = _calculateDeviation(actualAPY, health.targetAPY);
            if (deviation > apyDeviationThreshold) {
                _raiseAlert(
                    strategy,
                    AlertType.APY_DEVIATION,
                    "APY deviation exceeds threshold",
                    3
                );
            }
        }
        
        // æ£€æŸ¥TVLæµå¤±
        if (lastTVL[strategy] > 0) {
            uint256 tvlChange = _calculateChange(tvl, lastTVL[strategy]);
            if (tvlChange > tvlDrainThreshold) {
                _raiseAlert(
                    strategy,
                    AlertType.TVL_DRAIN,
                    "Rapid TVL decrease detected",
                    4
                );
            }
        }
        
        // æ£€æŸ¥åˆ©ç”¨ç‡
        if (utilizationRate < minUtilizationRate) {
            _raiseAlert(
                strategy,
                AlertType.UTILIZATION_LOW,
                "Low utilization rate",
                2
            );
        }
        
        // è®¡ç®—é£é™©åˆ†æ•°
        uint256 riskScore = _calculateRiskScore(
            actualAPY,
            tvl,
            utilizationRate,
            deviation
        );
        
        // æ›´æ–°å¥åº·çŠ¶æ€
        health.actualAPY = actualAPY;
        health.tvl = tvl;
        health.utilizationRate = utilizationRate;
        health.lastUpdate = block.timestamp;
        health.riskScore = riskScore;
        health.isHealthy = riskScore < maxRiskScore;
        
        lastTVL[strategy] = tvl;
        
        emit HealthUpdate(strategy, health.isHealthy, riskScore);
    }
    
    /**
     * @notice è®¡ç®—é£é™©åˆ†æ•°
     */
    function _calculateRiskScore(
        uint256 actualAPY,
        uint256 tvl,
        uint256 utilizationRate,
        uint256 apyDeviation
    ) internal pure returns (uint256) {
        uint256 score = 0;
        
        // APYåç¦»è´¡çŒ®ï¼ˆæƒé‡40%ï¼‰
        score = score.add(apyDeviation.mul(40).div(100));
        
        // ä½TVLè´¡çŒ®ï¼ˆæƒé‡30%ï¼‰
        if (tvl < 1e6 * 1e6) {  // < $1M
            score = score.add(3000);
        } else if (tvl < 10e6 * 1e6) {  // < $10M
            score = score.add(1500);
        }
        
        // ä½åˆ©ç”¨ç‡è´¡çŒ®ï¼ˆæƒé‡20%ï¼‰
        if (utilizationRate < 5000) {
            score = score.add(2000);
        }
        
        // é«˜APYé£é™©ï¼ˆæƒé‡10%ï¼‰
        if (actualAPY > 5000) {  // > 50% APY
            score = score.add(1000);
        }
        
        return Math.min(score, 10000);
    }
    
    /**
     * @notice æ‰¹é‡å¥åº·æ£€æŸ¥
     */
    function batchHealthCheck(address[] calldata _strategies) external view 
        returns (bool[] memory isHealthy, uint256[] memory riskScores) 
    {
        isHealthy = new bool[](_strategies.length);
        riskScores = new uint256[](_strategies.length);
        
        for (uint256 i = 0; i < _strategies.length; i++) {
            StrategyHealth memory health = strategies[_strategies[i]];
            isHealthy[i] = health.isHealthy;
            riskScores[i] = health.riskScore;
        }
    }
    
    /**
     * @notice è·å–æœ€è¿‘çš„è­¦æŠ¥
     */
    function getRecentAlerts(uint256 count) external view 
        returns (Alert[] memory) 
    {
        uint256 length = alerts.length;
        if (count > length) count = length;
        
        Alert[] memory recentAlerts = new Alert[](count);
        for (uint256 i = 0; i < count; i++) {
            recentAlerts[i] = alerts[length - 1 - i];
        }
        
        return recentAlerts;
    }
}
</code></pre>
            </div>
        </div>

        <div class="exercise">
            <h3>ç»ƒä¹ 8.1ï¼šå®ç°æ”¶ç›Šä¼˜åŒ–å™¨</h3>
            <p>åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨æ”¶ç›Šä¼˜åŒ–å™¨ï¼Œæ”¯æŒï¼š</p>
            <ul>
                <li>å¤šç­–ç•¥æ”¶ç›Šæ¯”è¾ƒ</li>
                <li>è‡ªåŠ¨å†å¹³è¡¡</li>
                <li>Gasæˆæœ¬ä¼˜åŒ–</li>
                <li>æ»‘ç‚¹ä¿æŠ¤</li>
            </ul>
            
            <div class="answer">
                <button class="toggle-answer" onclick="toggleAnswer(this)">æŸ¥çœ‹å‚è€ƒç­”æ¡ˆ</button>
                <div class="answer-content" style="display: none;">
                    <pre><code class="language-solidity">
contract AutoYieldOptimizer {
    struct Strategy {
        address target;
        uint256 allocation;
        uint256 lastAPY;
        uint256 gasEstimate;
    }
    
    mapping(address => Strategy) public strategies;
    uint256 public constant REBALANCE_THRESHOLD = 200; // 2%
    
    function rebalance() external {
        // 1. æ”¶é›†æ‰€æœ‰ç­–ç•¥çš„å½“å‰APY
        // 2. è®¡ç®—æœ€ä¼˜åˆ†é…
        // 3. æ‰§è¡Œå†å¹³è¡¡
        // 4. æ‰£é™¤Gasæˆæœ¬
    }
    
    function calculateOptimalAllocation() internal view 
        returns (uint256[] memory) {
        // å®ç°å‡¸ä¼˜åŒ–ç®—æ³•
        // è€ƒè™‘APYã€é£é™©ã€Gasæˆæœ¬
    }
}
</code></pre>
                </div>
            </div>
        </div>

        <div class="exercise">
            <h3>ç»ƒä¹ 8.2ï¼šDeltaä¸­æ€§ç­–ç•¥å®ç°</h3>
            <p>æ„å»ºä¸€ä¸ªDeltaä¸­æ€§æ”¶ç›Šç­–ç•¥ï¼š</p>
            <ul>
                <li>ç°è´§-æœŸè´§å¯¹å†²</li>
                <li>èµ„é‡‘è´¹ç‡å¥—åˆ©</li>
                <li>è‡ªåŠ¨é£é™©ç®¡ç†</li>
                <li>æ”¶ç›Šå¤æŠ•</li>
            </ul>
        </div>

        <div class="exercise">
            <h3>ç»ƒä¹ 8.3ï¼šè·¨é“¾æ”¶ç›Šèšåˆå™¨</h3>
            <p>è®¾è®¡ä¸€ä¸ªè·¨é“¾æ”¶ç›Šèšåˆç³»ç»Ÿï¼š</p>
            <ul>
                <li>æ”¯æŒ5æ¡ä¸»æµé“¾</li>
                <li>è‡ªåŠ¨å¯»æ‰¾æœ€ä¼˜æ”¶ç›Š</li>
                <li>æœ€å°åŒ–è·¨é“¾æˆæœ¬</li>
                <li>å¤„ç†è·¨é“¾å¤±è´¥</li>
            </ul>
        </div>

        <h3 id="ai-defi-integration">8.5 å‰æ²¿è§†è§’ï¼šAIä¸DeFiæ”¶ç›Šç­–ç•¥çš„èåˆ</h3>
        
        <div class="info-box">
            <h4>ğŸ¤– AIåœ¨DeFiæ”¶ç›Šä¼˜åŒ–ä¸­çš„åº”ç”¨</h4>
            <p>éšç€AIæŠ€æœ¯çš„å‘å±•ï¼Œæœºå™¨å­¦ä¹ å’Œæ·±åº¦å­¦ä¹ æ­£åœ¨é‡å¡‘DeFiæ”¶ç›Šç­–ç•¥çš„è®¾è®¡å’Œæ‰§è¡Œã€‚</p>
        </div>
        
        <h4>8.5.1 AIé©±åŠ¨çš„æ”¶ç›Šé¢„æµ‹</h4>
        <div class="concept">
            <h5>åº”ç”¨åœºæ™¯ï¼š</h5>
            <ul>
                <li><strong>APYé¢„æµ‹æ¨¡å‹</strong>ï¼š
                    <ul>
                        <li>LSTMé¢„æµ‹çŸ­æœŸåˆ©ç‡å˜åŒ–</li>
                        <li>è€ƒè™‘TVLã€åˆ©ç”¨ç‡ã€å¸‚åœºæƒ…ç»ªç­‰å¤šç»´ç‰¹å¾</li>
                        <li>å®æ—¶è°ƒæ•´ç­–ç•¥é…ç½®</li>
                    </ul>
                </li>
                <li><strong>æµåŠ¨æ€§éœ€æ±‚é¢„æµ‹</strong>ï¼š
                    <ul>
                        <li>é¢„æµ‹å¤§é¢ææ¬¾æ—¶é—´</li>
                        <li>ä¼˜åŒ–æµåŠ¨æ€§ç¼“å†²</li>
                        <li>é™ä½æœºä¼šæˆæœ¬</li>
                    </ul>
                </li>
                <li><strong>å¸‚åœºå¼‚å¸¸æ£€æµ‹</strong>ï¼š
                    <ul>
                        <li>è¯†åˆ«ä»·æ ¼æ“çºµæ¨¡å¼</li>
                        <li>æ£€æµ‹é—ªç”µè´·æ”»å‡»å‰å…†</li>
                        <li>è‡ªåŠ¨è§¦å‘é˜²å¾¡æœºåˆ¶</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <div class="code-section">
            <div class="code-header">
                <span class="code-title">AIæ”¶ç›Šé¢„æµ‹æ¨¡å‹ç¤ºä¾‹</span>
                <button class="collapse-btn" onclick="toggleCode(this)">å±•å¼€</button>
            </div>
            <div class="code-content" style="display: none;">
                <pre><code class="language-python">
import torch
import torch.nn as nn
import numpy as np
from typing import Dict, List, Tuple
import pandas as pd

class YieldPredictionLSTM(nn.Module):
    """LSTMæ¨¡å‹ç”¨äºæ”¶ç›Šç‡é¢„æµ‹"""
    
    def __init__(self, input_size: int, hidden_size: int = 128, num_layers: int = 2):
        super(YieldPredictionLSTM, self).__init__()
        self.hidden_size = hidden_size
        self.num_layers = num_layers
        
        self.lstm = nn.LSTM(input_size, hidden_size, num_layers, batch_first=True)
        self.fc = nn.Linear(hidden_size, 1)
        self.dropout = nn.Dropout(0.2)
        
    def forward(self, x):
        # LSTMå±‚
        lstm_out, _ = self.lstm(x)
        
        # å–æœ€åä¸€ä¸ªæ—¶é—´æ­¥çš„è¾“å‡º
        last_output = lstm_out[:, -1, :]
        
        # å…¨è¿æ¥å±‚
        output = self.fc(self.dropout(last_output))
        return output

class AIYieldOptimizer:
    """AIé©±åŠ¨çš„æ”¶ç›Šä¼˜åŒ–å™¨"""
    
    def __init__(self, lookback_window: int = 24):
        self.lookback_window = lookback_window
        self.model = YieldPredictionLSTM(input_size=10)  # 10ä¸ªç‰¹å¾
        self.scaler = None
        
    def prepare_features(self, protocol_data: pd.DataFrame) -> np.ndarray:
        """
        å‡†å¤‡æ¨¡å‹è¾“å…¥ç‰¹å¾
        
        Features:
        - TVLå˜åŒ–ç‡
        - åˆ©ç”¨ç‡
        - å†å²APY
        - Gasä»·æ ¼
        - å¸‚åœºæ³¢åŠ¨ç‡
        - äº¤æ˜“é‡
        - æŒä»“é›†ä¸­åº¦
        - åè®®å¹´é¾„
        - å®¡è®¡åˆ†æ•°
        - ç¤¾äº¤åª’ä½“æƒ…ç»ª
        """
        features = []
        
        # TVLå˜åŒ–ç‡
        features.append(protocol_data['tvl'].pct_change().fillna(0))
        
        # åˆ©ç”¨ç‡
        features.append(protocol_data['utilization_rate'])
        
        # å†å²APYï¼ˆç§»åŠ¨å¹³å‡ï¼‰
        features.append(protocol_data['apy'].rolling(window=7).mean())
        
        # Gasä»·æ ¼ï¼ˆæ ‡å‡†åŒ–ï¼‰
        features.append(protocol_data['gas_price'] / 100)
        
        # å¸‚åœºæ³¢åŠ¨ç‡ï¼ˆä½¿ç”¨æ”¶ç›Šç‡æ ‡å‡†å·®ï¼‰
        features.append(protocol_data['apy'].rolling(window=7).std())
        
        # å…¶ä»–ç‰¹å¾...
        
        return np.column_stack(features)
    
    def predict_optimal_allocation(self, 
                                 protocols: List[str],
                                 historical_data: Dict[str, pd.DataFrame],
                                 risk_tolerance: float = 0.5) -> Dict[str, float]:
        """
        é¢„æµ‹æœ€ä¼˜èµ„é‡‘åˆ†é…
        
        Args:
            protocols: åè®®åˆ—è¡¨
            historical_data: å†å²æ•°æ®
            risk_tolerance: é£é™©å®¹å¿åº¦(0-1)
            
        Returns:
            å„åè®®çš„æœ€ä¼˜é…ç½®æ¯”ä¾‹
        """
        predictions = {}
        risk_scores = {}
        
        # ä¸ºæ¯ä¸ªåè®®é¢„æµ‹æœªæ¥æ”¶ç›Š
        for protocol in protocols:
            data = historical_data[protocol]
            features = self.prepare_features(data)
            
            # é¢„æµ‹æœªæ¥24å°æ—¶APY
            with torch.no_grad():
                future_apy = self.model(torch.FloatTensor(features[-self.lookback_window:]))
                predictions[protocol] = future_apy.item()
            
            # è®¡ç®—é£é™©åˆ†æ•°
            risk_scores[protocol] = self._calculate_risk_score(data)
        
        # ä¼˜åŒ–é…ç½®ï¼ˆè€ƒè™‘é£é™©è°ƒæ•´åæ”¶ç›Šï¼‰
        allocations = self._optimize_allocation(
            predictions, 
            risk_scores, 
            risk_tolerance
        )
        
        return allocations
    
    def _calculate_risk_score(self, data: pd.DataFrame) -> float:
        """è®¡ç®—åè®®é£é™©åˆ†æ•°"""
        # åŸºäºå†å²æ•°æ®çš„å¤šç»´åº¦é£é™©è¯„ä¼°
        volatility = data['apy'].std()
        max_drawdown = (data['tvl'].max() - data['tvl'].min()) / data['tvl'].max()
        
        risk_score = 0.6 * volatility + 0.4 * max_drawdown
        return min(risk_score, 1.0)
    
    def _optimize_allocation(self, 
                           predictions: Dict[str, float],
                           risk_scores: Dict[str, float],
                           risk_tolerance: float) -> Dict[str, float]:
        """
        åŸºäºé¢„æµ‹å’Œé£é™©çš„é…ç½®ä¼˜åŒ–
        ä½¿ç”¨ç®€åŒ–çš„é©¬ç§‘ç»´èŒ¨ç»„åˆç†è®º
        """
        # è®¡ç®—é£é™©è°ƒæ•´åæ”¶ç›Š
        risk_adjusted_returns = {}
        for protocol, pred_apy in predictions.items():
            risk = risk_scores[protocol]
            # Sharpe-like ratio
            risk_adjusted_returns[protocol] = pred_apy / (1 + risk * (1 - risk_tolerance))
        
        # å½’ä¸€åŒ–ä¸ºé…ç½®æ¯”ä¾‹
        total = sum(risk_adjusted_returns.values())
        allocations = {
            protocol: value / total 
            for protocol, value in risk_adjusted_returns.items()
        }
        
        return allocations

# å®æ—¶å¼‚å¸¸æ£€æµ‹
class AnomalyDetector:
    """åŸºäºè‡ªç¼–ç å™¨çš„å¼‚å¸¸æ£€æµ‹"""
    
    def __init__(self, input_dim: int):
        self.encoder = nn.Sequential(
            nn.Linear(input_dim, 64),
            nn.ReLU(),
            nn.Linear(64, 32),
            nn.ReLU(),
            nn.Linear(32, 16)
        )
        
        self.decoder = nn.Sequential(
            nn.Linear(16, 32),
            nn.ReLU(),
            nn.Linear(32, 64),
            nn.ReLU(),
            nn.Linear(64, input_dim)
        )
        
        self.threshold = None
        
    def detect_anomaly(self, data: torch.Tensor) -> Tuple[bool, float]:
        """æ£€æµ‹æ˜¯å¦å­˜åœ¨å¼‚å¸¸"""
        # ç¼–ç -è§£ç 
        encoded = self.encoder(data)
        decoded = self.decoder(encoded)
        
        # è®¡ç®—é‡å»ºè¯¯å·®
        mse = nn.MSELoss()(decoded, data)
        
        # åˆ¤æ–­æ˜¯å¦å¼‚å¸¸
        is_anomaly = mse > self.threshold if self.threshold else False
        
        return is_anomaly, mse.item()
</code></pre>
            </div>
        </div>
        
        <h4>8.5.2 AIå®‰å…¨ä¸é£é™©ç®¡ç†</h4>
        <div class="warning-box">
            <h4>âš ï¸ AIåœ¨DeFiä¸­çš„é£é™©è€ƒè™‘</h4>
            <ul>
                <li><strong>æ¨¡å‹æ”»å‡»é£é™©</strong>ï¼š
                    <ul>
                        <li>å¯¹æŠ—æ ·æœ¬æ”»å‡»ï¼šæ¶æ„æ“çºµè¾“å…¥æ•°æ®</li>
                        <li>æ¨¡å‹æå–æ”»å‡»ï¼šé€†å‘å·¥ç¨‹ç­–ç•¥</li>
                        <li>æ•°æ®æŠ•æ¯’ï¼šæ±¡æŸ“è®­ç»ƒæ•°æ®</li>
                    </ul>
                </li>
                <li><strong>è¿‡æ‹Ÿåˆé£é™©</strong>ï¼š
                    <ul>
                        <li>å†å²æ¨¡å¼å¯èƒ½ä¸å†é€‚ç”¨</li>
                        <li>é»‘å¤©é¹…äº‹ä»¶çš„å¤„ç†</li>
                        <li>éœ€è¦æŒç»­çš„æ¨¡å‹æ›´æ–°</li>
                    </ul>
                </li>
                <li><strong>é€æ˜åº¦é—®é¢˜</strong>ï¼š
                    <ul>
                        <li>æ·±åº¦å­¦ä¹ æ¨¡å‹çš„é»‘ç®±ç‰¹æ€§</li>
                        <li>ç›‘ç®¡åˆè§„æŒ‘æˆ˜</li>
                        <li>ç”¨æˆ·ä¿¡ä»»é—®é¢˜</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <h4>8.5.3 æœªæ¥å±•æœ›</h4>
        <div class="concept">
            <h5>2024-2025å¹´è¶‹åŠ¿ï¼š</h5>
            <ul>
                <li><strong>é“¾ä¸Šæœºå™¨å­¦ä¹ </strong>ï¼š
                    <ul>
                        <li>zkMLï¼ˆé›¶çŸ¥è¯†æœºå™¨å­¦ä¹ ï¼‰ï¼šåœ¨é“¾ä¸ŠéªŒè¯æ¨¡å‹æ¨ç†</li>
                        <li>è”é‚¦å­¦ä¹ ï¼šå¤šæ–¹åä½œè®­ç»ƒè€Œä¸æš´éœ²æ•°æ®</li>
                        <li>å»ä¸­å¿ƒåŒ–AIå¸‚åœºï¼šæ¨¡å‹å³æœåŠ¡</li>
                    </ul>
                </li>
                <li><strong>è‡ªä¸»ä»£ç†ï¼ˆAutonomous Agentsï¼‰</strong>ï¼š
                    <ul>
                        <li>AIç®¡ç†çš„é‡‘åº“ï¼šè‡ªä¸»æ‰§è¡Œæ”¶ç›Šç­–ç•¥</li>
                        <li>MEVæœºå™¨äººï¼šAIé©±åŠ¨çš„å¥—åˆ©æ‰§è¡Œ</li>
                        <li>é£é™©ç®¡ç†AIï¼šå®æ—¶è°ƒæ•´æ•å£</li>
                    </ul>
                </li>
                <li><strong>é¢„æµ‹å¸‚åœºæ•´åˆ</strong>ï¼š
                    <ul>
                        <li>åˆ©ç”¨é¢„æµ‹å¸‚åœºæ•°æ®è®­ç»ƒæ¨¡å‹</li>
                        <li>AIå‚ä¸é¢„æµ‹å¸‚åœºå¥—åˆ©</li>
                        <li>æƒ…ç»ªåˆ†æä¸ä»·æ ¼é¢„æµ‹ç»“åˆ</li>
                    </ul>
                </li>
            </ul>
        </div>
        
        <h3>æœ¬ç« å°ç»“</h3>
        <div class="summary-box">
            <h4>æ ¸å¿ƒè¦ç‚¹å›é¡¾ï¼š</h4>
            <ul>
                <li><strong>æ”¶ç›Šæ¥æºå¤šæ ·åŒ–ï¼š</strong>ä»ä¼ ç»Ÿå€Ÿè´·åˆ°RWAæ•´åˆï¼Œä»ç®€å•LPåˆ°å¤æ‚è¡ç”Ÿå“</li>
                <li><strong>é£é™©çš„å¤šç»´åº¦è¯„ä¼°ï¼š</strong>æŠ€æœ¯ã€ç»æµã€æ²»ç†ã€ç»„åˆæ€§é£é™©éœ€è¦ç»¼åˆè€ƒè™‘</li>
                <li><strong>è‡ªåŠ¨åŒ–ä¸æ™ºèƒ½åŒ–ï¼š</strong>ä»ç®€å•å¤æŠ•åˆ°AIé©±åŠ¨çš„åŠ¨æ€ä¼˜åŒ–</li>
                <li><strong>è·¨é“¾å¥—åˆ©æœºä¼šï¼š</strong>ä¸åŒé“¾å’Œåè®®é—´çš„æ•ˆç‡å·®å¼‚åˆ›é€ æ”¶ç›Šç©ºé—´</li>
                <li><strong>å‰æ²¿åˆ›æ–°ï¼š</strong>LSTfi/LRTfiå¸¦æ¥æ–°æœºä¼šï¼ŒAIæ•´åˆå¼€å¯æ–°ç¯‡ç« </li>
            </ul>
            
            <h4>é£é™©æé†’ï¼š</h4>
            <ul>
                <li><strong>å¤æ‚æ€§é£é™©ï¼š</strong>ç­–ç•¥è¶Šå¤æ‚ï¼Œæ½œåœ¨æ•…éšœç‚¹è¶Šå¤š</li>
                <li><strong>ç»„åˆé£é™©ï¼š</strong>å¤šä¸ªåè®®çš„é£é™©å¯èƒ½ç›¸äº’æ”¾å¤§</li>
                <li><strong>æŠ€æœ¯ä¾èµ–ï¼š</strong>å¯¹é¢„è¨€æœºã€è·¨é“¾æ¡¥ç­‰åŸºç¡€è®¾æ–½çš„ä¾èµ–</li>
                <li><strong>ç›‘ç®¡ä¸ç¡®å®šæ€§ï¼š</strong>ç‰¹åˆ«æ˜¯æ¶‰åŠRWAå’Œè·¨å¢ƒçš„ç­–ç•¥</li>
            </ul>
            
            <h4>å®è·µå»ºè®®ï¼š</h4>
            <ul>
                <li>ä»ç®€å•ç­–ç•¥å¼€å§‹ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦</li>
                <li>å§‹ç»ˆä¿æŒéƒ¨åˆ†èµ„é‡‘çš„æµåŠ¨æ€§</li>
                <li>å®šæœŸå®¡æŸ¥å’Œè°ƒæ•´ç­–ç•¥é…ç½®</li>
                <li>å…³æ³¨æ–°æŠ€æœ¯ä½†è°¨æ…æ—©æœŸå‚ä¸</li>
                <li>å»ºç«‹è‡ªå·±çš„é£é™©è¯„ä¼°æ¡†æ¶</li>
            </ul>
            
            <h4>ä¸‹ä¸€æ­¥å­¦ä¹ ï¼š</h4>
            <p>æŒæ¡äº†æ”¶ç›Šç­–ç•¥åï¼Œä¸‹ä¸€ç« æˆ‘ä»¬å°†æ·±å…¥æ¢è®¨æ™ºèƒ½åˆçº¦å®‰å…¨ï¼Œå­¦ä¹ å¦‚ä½•è¯†åˆ«å’Œé˜²èŒƒå„ç§å®‰å…¨å¨èƒï¼Œæ„å»ºå®‰å…¨å¯é çš„DeFiåè®®ã€‚</p>
        </div>
        
        <h3>æœ¯è¯­é€ŸæŸ¥è¡¨</h3>
        <table class="glossary-table">
            <tr>
                <th>æœ¯è¯­</th>
                <th>è‹±æ–‡</th>
                <th>è§£é‡Š</th>
            </tr>
            <tr>
                <td>å¹´åŒ–æ”¶ç›Šç‡</td>
                <td>APY (Annual Percentage Yield)</td>
                <td>è€ƒè™‘å¤åˆ©æ•ˆåº”çš„å¹´åŒ–æ”¶ç›Šç‡</td>
            </tr>
            <tr>
                <td>å‘é‡APR</td>
                <td>Vector APR</td>
                <td>å¤šæºæ”¶ç›Šçš„å‘é‡åŒ–è¡¨ç¤ºæ–¹æ³•</td>
            </tr>
            <tr>
                <td>æ— å¸¸æŸå¤±</td>
                <td>Impermanent Loss</td>
                <td>LPç›¸å¯¹äºæŒæœ‰åŸå§‹èµ„äº§çš„æŸå¤±</td>
            </tr>
            <tr>
                <td>æµåŠ¨æ€§è´¨æŠ¼ä»£å¸</td>
                <td>LST (Liquid Staking Token)</td>
                <td>è´¨æŠ¼ETHçš„æµåŠ¨æ€§ä»£è¡¨ï¼Œå¦‚stETH</td>
            </tr>
            <tr>
                <td>æµåŠ¨æ€§å†è´¨æŠ¼ä»£å¸</td>
                <td>LRT (Liquid Restaking Token)</td>
                <td>EigenLayerç”Ÿæ€çš„å†è´¨æŠ¼ä»£å¸</td>
            </tr>
            <tr>
                <td>é£é™©ä»·å€¼</td>
                <td>VaR (Value at Risk)</td>
                <td>ç‰¹å®šç½®ä¿¡æ°´å¹³ä¸‹çš„æœ€å¤§æ½œåœ¨æŸå¤±</td>
            </tr>
            <tr>
                <td>æ¡ä»¶é£é™©ä»·å€¼</td>
                <td>CVaR (Conditional VaR)</td>
                <td>è¶…è¿‡VaRé˜ˆå€¼çš„å¹³å‡æŸå¤±</td>
            </tr>
            <tr>
                <td>èµ„é‡‘è´¹ç‡</td>
                <td>Funding Rate</td>
                <td>æ°¸ç»­åˆçº¦å¤šç©ºåŒæ–¹çš„å®šæœŸç»“ç®—è´¹ç”¨</td>
            </tr>
            <tr>
                <td>å¤æ™®æ¯”ç‡</td>
                <td>Sharpe Ratio</td>
                <td>é£é™©è°ƒæ•´åæ”¶ç›Šçš„è¡¡é‡æŒ‡æ ‡</td>
            </tr>
            <tr>
                <td>é›¶çŸ¥è¯†æœºå™¨å­¦ä¹ </td>
                <td>zkML</td>
                <td>åœ¨ä¸æš´éœ²æ•°æ®çš„æƒ…å†µä¸‹éªŒè¯MLæ¨ç†</td>
            </tr>
        </table>
    
            
            <!-- ç« èŠ‚å¯¼èˆª -->
            <div class="chapter-nav">
                <a href="chapter7.html">â† ç¬¬7ç« </a>
                <a href="chapter9.html">ç¬¬9ç«  â†’</a>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-solidity.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="script.js"></script>
</body>
</html>